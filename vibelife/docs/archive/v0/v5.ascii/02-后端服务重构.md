# VibeLife v5 后端服务重构方案

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                         后 端 服 务 重 构 蓝 图                              ║
║                    从"技能驱动"到"用户旅程驱动"                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 1. 服务架构演进

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        服务架构对比: 现有 vs 目标                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────┐    ┌─────────────────────────────┐       │
│   │        现有架构              │    │        目标架构              │       │
│   │      (技能驱动)              │    │     (用户旅程驱动)           │       │
│   ├─────────────────────────────┤    ├─────────────────────────────┤       │
│   │                             │    │                             │       │
│   │  routes/                    │    │  routes/                    │       │
│   │  ├── auth.py                │    │  ├── auth.py                │       │
│   │  ├── users.py               │    │  ├── users.py (增强)        │       │
│   │  ├── chat.py                │    │  ├── chat.py (重构)         │       │
│   │  ├── bazi.py      ─────────────▶│  ├── identity.py (新)        │       │
│   │  ├── zodiac.py              │    │  ├── rituals.py (新)        │       │
│   │  ├── report.py              │    │  ├── journey.py (新)        │       │
│   │  └── fortune.py             │    │  ├── memories.py (新)       │       │
│   │                             │    │  ├── events.py (新)         │       │
│   │  services/                  │    │  └── dimensions/            │       │
│   │  ├── agent/                 │    │      ├── bazi.py            │       │
│   │  ├── vibe_engine/           │    │      └── zodiac.py          │       │
│   │  ├── bazi/                  │    │                             │       │
│   │  └── zodiac/                │    │  services/                  │       │
│   │                             │    │  ├── understanding_engine/  │       │
│   │                             │    │  ├── memory_engine/         │       │
│   │                             │    │  ├── ritual_engine/         │       │
│   │                             │    │  └── journey_engine/        │       │
│   │                             │    │                             │       │
│   └─────────────────────────────┘    └─────────────────────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心引擎架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          四大核心引擎                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                    Understanding Engine                            │    │
│   │                      (统一理解引擎)                                 │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │    │
│   │  │  Context    │  │  Dimension  │  │  Insight    │                │    │
│   │  │Orchestrator │─▶│   Fusion    │─▶│  Generator  │                │    │
│   │  │ (上下文编排) │  │ (维度融合)  │  │ (洞察生成)  │                │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘                │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│          ┌─────────────────────────┼─────────────────────────┐              │
│          │                         │                         │              │
│          ▼                         ▼                         ▼              │
│   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │
│   │   Memory    │           │   Ritual    │           │   Journey   │      │
│   │   Engine    │           │   Engine    │           │   Engine    │      │
│   │  (记忆引擎) │           │  (仪式引擎) │           │  (旅程引擎) │      │
│   ├─────────────┤           ├─────────────┤           ├─────────────┤      │
│   │• Extractor  │           │• Morning    │           │• Stage      │      │
│   │  (提取器)   │           │  Oracle     │           │  Tracker    │      │
│   │• Retriever  │           │  (晨谕)     │           │  (阶段追踪) │      │
│   │  (检索器)   │           │• Midday     │           │• Transition │      │
│   │• Consolidator│          │  Mirror     │           │  Handler    │      │
│   │  (整合器)   │           │  (午照)     │           │  (转换处理) │      │
│   │             │           │• Night      │           │             │      │
│   │             │           │  Whisper    │           │             │      │
│   │             │           │  (夜语)     │           │             │      │
│   └─────────────┘           └─────────────┘           └─────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Context Orchestrator 数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Context Orchestrator 上下文编排流程                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐                                                           │
│   │  用户消息   │                                                           │
│   └──────┬──────┘                                                           │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Context Orchestrator                              │   │
│   │                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                    并行数据获取                              │   │   │
│   │   │                                                             │   │   │
│   │   │  asyncio.gather(                                            │   │   │
│   │   │      _get_user(user_id),                                    │   │   │
│   │   │      _get_identity_prism(user_id),                          │   │   │
│   │   │      _get_relevant_memories(user_id, message),              │   │   │
│   │   │      _get_upcoming_events(user_id),                         │   │   │
│   │   │      _get_daily_fortune(user_id)                            │   │   │
│   │   │  )                                                          │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                              │                                       │   │
│   │                              ▼                                       │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │              ConversationContext                             │   │   │
│   │   │  ┌───────────────┬───────────────┬───────────────┐          │   │   │
│   │   │  │     user      │identity_prism │recent_memories│          │   │   │
│   │   │  ├───────────────┼───────────────┼───────────────┤          │   │   │
│   │   │  │upcoming_events│current_fortune│ journey_stage │          │   │   │
│   │   │  ├───────────────┴───────────────┴───────────────┤          │   │   │
│   │   │  │           emotional_baseline                  │          │   │   │
│   │   │  └───────────────────────────────────────────────┘          │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                      │   │
│   └──────────────────────────────────────────────────────────────────────┘   │
│                              │                                               │
│                              ▼                                               │
│                       ┌─────────────┐                                        │
│                       │  LLM 生成   │                                        │
│                       │  个性化回复  │                                        │
│                       └─────────────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 记忆引擎工作流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Memory Engine 工作流                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Memory Extractor                                │   │
│   │                        (记忆提取器)                                  │   │
│   │                                                                      │   │
│   │   对话内容 ──▶ LLM 分析 ──▶ 结构化记忆                               │   │
│   │                                                                      │   │
│   │   提取类型:                                                          │   │
│   │   ┌──────────┬──────────┬──────────┬──────────┐                     │   │
│   │   │life_event│personality│emotional │preference│                     │   │
│   │   │ 生活事件 │ 性格特征  │ 情绪模式 │ 偏好习惯 │                     │   │
│   │   └──────────┴──────────┴──────────┴──────────┘                     │   │
│   │   ┌──────────┬──────────┬──────────┐                                │   │
│   │   │ concern  │relationship│ growth  │                                │   │
│   │   │关注/困扰 │ 人际关系  │成长里程碑│                                │   │
│   │   └──────────┴──────────┴──────────┘                                │   │
│   │                                                                      │   │
│   └──────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Memory Retriever                                │   │
│   │                        (记忆检索器)                                  │   │
│   │                                                                      │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│   │   │  语义检索   │    │  时间检索   │    │  情绪检索   │             │   │
│   │   │ (Embedding) │    │ (Temporal)  │    │ (Emotional) │             │   │
│   │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘             │   │
│   │          │                  │                  │                     │   │
│   │          └──────────────────┼──────────────────┘                     │   │
│   │                             │                                        │   │
│   │                             ▼                                        │   │
│   │                    ┌─────────────────┐                               │   │
│   │                    │  merge_and_rank │                               │   │
│   │                    │   (合并排序)    │                               │   │
│   │                    └─────────────────┘                               │   │
│   │                                                                      │   │
│   └──────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Memory Consolidator                              │   │
│   │                       (记忆整合器)                                   │   │
│   │                                                                      │   │
│   │   定期任务:                                                          │   │
│   │   1. 获取最近记忆 ──▶ 2. 聚类相关记忆 ──▶ 3. 合并重复 ──▶ 4. 更新洞察│   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 仪式引擎流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Ritual Engine 每日仪式流程                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   06:00-09:00                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Morning Oracle (晨谕)                           │   │
│   │                                                                      │   │
│   │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐         │   │
│   │   │ Context │───▶│ Fortune │───▶│Follow-up│───▶│ Generate│         │   │
│   │   │  获取   │    │  运势   │    │  跟进   │    │  生成   │         │   │
│   │   └─────────┘    └─────────┘    └─────────┘    └─────────┘         │   │
│   │                                                      │              │   │
│   │                                                      ▼              │   │
│   │   输出: {energy_theme, prediction, advice, follow_up_reminder}      │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   12:00-14:00                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Midday Mirror (午照)                            │   │
│   │                                                                      │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│   │   │ 获取晨谕    │───▶│ 生成问候    │───▶│ 等待回复    │             │   │
│   │   └─────────────┘    └─────────────┘    └──────┬──────┘             │   │
│   │                                                │                     │   │
│   │                                                ▼                     │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│   │   │ 提取记忆    │◀───│ 处理回复    │◀───│ 用户回复    │             │   │
│   │   └─────────────┘    └─────────────┘    └─────────────┘             │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   21:00-22:00                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Night Whisper (夜语)                            │   │
│   │                                                                      │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐             │   │
│   │   │ 今日总结    │───▶│ 明日预览    │───▶│ 晚安寄语    │             │   │
│   │   └─────────────┘    └─────────────┘    └─────────────┘             │   │
│   │                                                                      │   │
│   │   输出: {day_summary, tomorrow_preview, closing_message}             │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 旅程引擎状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Journey Engine 用户旅程状态机                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────────┐                                │
│                              │  encounter  │                                │
│                              │   (相遇)    │                                │
│                              └──────┬──────┘                                │
│                                     │ 完成首次对话                          │
│                                     ▼                                       │
│                              ┌─────────────┐                                │
│                              │ first_sight │                                │
│                              │   (初见)    │                                │
│                              └──────┬──────┘                                │
│                                     │ 对话>=3, 天数>=2                      │
│                                     ▼                                       │
│                              ┌─────────────┐                                │
│                              │understanding│                                │
│                              │   (了解)    │                                │
│                              └──────┬──────┘                                │
│                                     │ 对话>=10, 天数>=7, 已付费             │
│                                     ▼                                       │
│                              ┌─────────────┐                                │
│                              │    trust    │                                │
│                              │   (信任)    │                                │
│                              └──────┬──────┘                                │
│                                     │ 对话>=30, 天数>=30, 连续>=7天         │
│                                     ▼                                       │
│                              ┌─────────────┐                                │
│                              │ dependence  │                                │
│                              │   (依赖)    │                                │
│                              └──────┬──────┘                                │
│                                     │ 天数>=60, 连续>=14天                  │
│                                     ▼                                       │
│                              ┌─────────────┐                                │
│                              │  symbiosis  │                                │
│                              │   (共生)    │                                │
│                              └─────────────┘                                │
│                                                                             │
│   ════════════════════════════════════════════════════════════════════     │
│   阶段转换触发:                                                             │
│   ────────────────────────────────────────────────────────────────────     │
│   check_transition(user_id) ──▶ 检查条件 ──▶ transition(user_id, stage)    │
│                                                    │                        │
│                                                    ▼                        │
│                                           ┌─────────────────┐               │
│                                           │ • 更新数据库    │               │
│                                           │ • 发布事件      │               │
│                                           │ • 发送转换消息  │               │
│                                           └─────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. API 路由结构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            新增 API 路由                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   /chat (重构)                                                              │
│   ├── POST /chat              统一对话入口，支持多维度融合                   │
│   │   └── 流程: 构建上下文 → 检查旅程转换 → 生成回复 → 异步提取记忆         │
│   │                                                                         │
│   /identity (新增)                                                          │
│   ├── GET  /identity/prism           获取 Identity Prism                    │
│   ├── POST /identity/prism/regenerate 重新生成 Prism                        │
│   └── GET  /identity/dimensions      获取已解锁维度                         │
│                                                                             │
│   /rituals (新增)                                                           │
│   ├── GET  /rituals/today            获取今日仪式                           │
│   ├── POST /rituals/midday/respond   回复午照                               │
│   └── PUT  /rituals/preferences      更新仪式偏好                           │
│                                                                             │
│   /events (新增)                                                            │
│   ├── GET  /events                   获取用户事件                           │
│   ├── POST /events                   创建事件                               │
│   └── PUT  /events/{id}/feedback     添加事件反馈                           │
│                                                                             │
│   /journey (新增)                                                           │
│   ├── GET  /journey/stage            获取当前旅程阶段                       │
│   └── GET  /journey/progress         获取旅程进度                           │
│                                                                             │
│   /memories (新增)                                                          │
│   ├── GET  /memories                 获取用户记忆                           │
│   └── DELETE /memories/{id}          删除记忆                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 后台任务架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           后台 Workers 架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     Ritual Scheduler                                 │   │
│   │                      (仪式调度器)                                    │   │
│   │                                                                      │   │
│   │   while True:                                                        │   │
│   │       ├── _process_morning_oracles()  # 处理晨谕                     │   │
│   │       ├── _process_midday_mirrors()   # 处理午照                     │   │
│   │       ├── _process_night_whispers()   # 处理夜语                     │   │
│   │       └── sleep(60)                   # 每分钟检查                   │   │
│   │                                                                      │   │
│   │   流程:                                                              │   │
│   │   get_users_for_ritual() ──▶ generate() ──▶ save_and_send()         │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Memory Consolidator                               │   │
│   │                      (记忆整合器)                                    │   │
│   │                                                                      │   │
│   │   定期任务 (每日):                                                   │   │
│   │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐         │   │
│   │   │获取最近 │───▶│ 聚类    │───▶│ 合并    │───▶│ 更新    │         │   │
│   │   │  记忆   │    │ 相关记忆│    │重复记忆 │    │AI洞察   │         │   │
│   │   └─────────┘    └─────────┘    └─────────┘    └─────────┘         │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Event Reminder Worker                             │   │
│   │                     (事件提醒工作器)                                 │   │
│   │                                                                      │   │
│   │   检查 event_reminders 表:                                           │   │
│   │   ├── pre_event   (事件前提醒)                                       │   │
│   │   ├── day_of      (当天提醒)                                         │   │
│   │   └── post_event  (事件后跟进)                                       │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 实施检查清单

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              实施检查清单                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Understanding Engine:                                                     │
│   [ ] 创建 understanding_engine 服务目录                                    │
│   [ ] 实现 ContextOrchestrator                                              │
│   [ ] 实现 DimensionFusion                                                  │
│                                                                             │
│   Memory Engine:                                                            │
│   [ ] 创建 memory_engine 服务目录                                           │
│   [ ] 实现 MemoryExtractor                                                  │
│   [ ] 实现 MemoryRetriever                                                  │
│                                                                             │
│   Ritual Engine:                                                            │
│   [ ] 创建 ritual_engine 服务目录                                           │
│   [ ] 实现 MorningOracle                                                    │
│   [ ] 实现 MiddayMirror                                                     │
│   [ ] 实现 NightWhisper                                                     │
│                                                                             │
│   Journey Engine:                                                           │
│   [ ] 创建 journey_engine 服务目录                                          │
│   [ ] 实现 JourneyStageTracker                                              │
│                                                                             │
│   API Routes:                                                               │
│   [ ] 重构 chat.py 路由                                                     │
│   [ ] 新增 identity.py 路由                                                 │
│   [ ] 新增 rituals.py 路由                                                  │
│   [ ] 新增 events.py 路由                                                   │
│                                                                             │
│   Workers:                                                                  │
│   [ ] 实现 RitualScheduler worker                                           │
│   [ ] 实现 MemoryConsolidator worker                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*下一步: [03-AI引擎升级](./03-AI引擎升级.md)*
