# æ¨é€ä¸ä»ªå¼ç³»ç»Ÿ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘         â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘ â•‘
â•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—    â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘ â•‘
â•‘   â•šâ•â•  â•šâ•â•â•šâ•â•   â•šâ•â•    â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•    â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â• â•‘
â•‘                                                                              â•‘
â•‘                    æ¨ é€ ä¸ ä»ª å¼ ç³» ç»Ÿ è®¾ è®¡                                â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

> å®ç°è“å›¾ä¸­çš„"æ™¨è°•/åˆç…§/å¤œè¯­"ä¸‰ä»ªå¼ç³»ç»Ÿï¼Œä»¥åŠä¸»åŠ¨æ¨é€èƒ½åŠ›ï¼Œè®© AI ä»è¢«åŠ¨å·¥å…·å‡çº§ä¸ºä¸»åŠ¨çš„"æ•°å­—å­˜åœ¨"ã€‚

---

## 1. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ¨ é€ ä¸ ä»ª å¼ ç³» ç»Ÿ æ¶ æ„                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚   â”‚   ä»ªå¼è°ƒåº¦å™¨    â”‚â”€â”€â”€â–¶â”‚   ä»ªå¼ç”Ÿæˆå™¨    â”‚â”€â”€â”€â–¶â”‚    æ¨é€æœåŠ¡     â”‚        â”‚
â”‚   â”‚   Scheduler     â”‚    â”‚   Generator     â”‚    â”‚    Push         â”‚        â”‚
â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚            â”‚                      â”‚                      â”‚                  â”‚
â”‚            â–¼                      â–¼                      â–¼                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚   â”‚   ç”¨æˆ·åå¥½      â”‚    â”‚   ä¸Šä¸‹æ–‡ç¼–æ’    â”‚    â”‚   å¤šæ¸ é“åˆ†å‘    â”‚        â”‚
â”‚   â”‚   Preferences   â”‚    â”‚   Context       â”‚    â”‚   Channels      â”‚        â”‚
â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¯æ—¥ä¸‰ä»ªå¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ¯ æ—¥ ä¸‰ ä»ª å¼                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚       â˜€ï¸ æ™¨è°•                  ğŸŒ… åˆç…§                  ğŸŒ™ å¤œè¯­             â”‚
â”‚       Morning Oracle           Midday Mirror           Night Whisper       â”‚
â”‚       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚       07:00                    12:30                    21:30              â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚   â”‚ * èƒ½é‡ä¸»é¢˜      â”‚    â”‚ * åæ€é—®é¢˜      â”‚    â”‚ * ä»Šæ—¥æ€»ç»“      â”‚        â”‚
â”‚   â”‚ * ä»Šæ—¥é¢„æµ‹      â”‚    â”‚ * æ™¨è°•å›é¡¾      â”‚    â”‚ * æ˜æ—¥é¢„è§ˆ      â”‚        â”‚
â”‚   â”‚ * åº”å¯¹å»ºè®®      â”‚    â”‚ * ç”¨æˆ·å›å¤      â”‚    â”‚ * æ™šå®‰å¯„è¯­      â”‚        â”‚
â”‚   â”‚ * è·Ÿè¿›æé†’      â”‚    â”‚ * è®°å¿†æå–      â”‚    â”‚                 â”‚        â”‚
â”‚   â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ä»ªå¼è°ƒåº¦å™¨

### 2.1 è°ƒåº¦æœåŠ¡

```python
# services/ritual/scheduler.py

import asyncio
from datetime import datetime, time
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger

class RitualScheduler:
    """ä»ªå¼è°ƒåº¦å™¨ - ç®¡ç†æ¯æ—¥ä¸‰ä»ªå¼çš„å®šæ—¶è§¦å‘"""

    def __init__(
        self,
        ritual_generator: RitualGenerator,
        push_service: PushService,
        user_repo: UserRepo
    ):
        self.generator = ritual_generator
        self.push = push_service
        self.user_repo = user_repo
        self.scheduler = AsyncIOScheduler()

    def start(self):
        """å¯åŠ¨è°ƒåº¦å™¨"""
        # æ¯åˆ†é’Ÿæ£€æŸ¥éœ€è¦å‘é€ä»ªå¼çš„ç”¨æˆ·
        self.scheduler.add_job(
            self._process_morning_oracles,
            CronTrigger(minute='*'),
            id='morning_oracle_check'
        )
        self.scheduler.add_job(
            self._process_midday_mirrors,
            CronTrigger(minute='*'),
            id='midday_mirror_check'
        )
        self.scheduler.add_job(
            self._process_night_whispers,
            CronTrigger(minute='*'),
            id='night_whisper_check'
        )

        self.scheduler.start()

    async def _process_morning_oracles(self):
        """å¤„ç†æ™¨è°•"""
        current_time = datetime.now()
        users = await self._get_users_for_ritual('morning_oracle', current_time)

        for user in users:
            try:
                await self._send_morning_oracle(user)
            except Exception as e:
                logger.error(f"Failed morning oracle for {user.vibe_id}: {e}")

    async def _get_users_for_ritual(self, ritual_type: str, current_time: datetime) -> list:
        """è·å–å½“å‰æ—¶é—´éœ€è¦æ¥æ”¶ä»ªå¼çš„ç”¨æˆ·"""
        current_hour = current_time.hour
        current_minute = current_time.minute

        # æŸ¥è¯¢åå¥½æ—¶é—´åŒ¹é…çš„ç”¨æˆ·
        return await self.user_repo.get_users_by_ritual_time(
            ritual_type=ritual_type,
            hour=current_hour,
            minute=current_minute
        )

    async def _send_morning_oracle(self, user):
        """å‘é€æ™¨è°•"""
        # æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²å‘é€
        if await self._already_sent_today(user.vibe_id, 'morning_oracle'):
            return

        # ç”Ÿæˆæ™¨è°•
        oracle = await self.generator.generate_morning_oracle(user.vibe_id)

        # ä¿å­˜åˆ°æ•°æ®åº“
        await self._save_ritual(user.vibe_id, 'morning_oracle', oracle)

        # å‘é€æ¨é€
        await self.push.send(
            user_id=user.vibe_id,
            title="ä»Šæ—¥æ™¨è°•",
            body=f"ä»Šæ—¥èƒ½é‡: {oracle['energy_theme']}",
            data={'type': 'morning_oracle', 'ritual_id': oracle['id']}
        )
```

### 2.2 æ‰¹é‡å¤„ç†ä¼˜åŒ–

```python
# services/ritual/batch_processor.py

class RitualBatchProcessor:
    """æ‰¹é‡å¤„ç†ä»ªå¼ç”Ÿæˆï¼Œæé«˜æ•ˆç‡"""

    BATCH_SIZE = 100

    async def process_batch(self, ritual_type: str, users: list):
        """æ‰¹é‡å¤„ç†ç”¨æˆ·ä»ªå¼"""

        # åˆ†æ‰¹å¤„ç†
        for i in range(0, len(users), self.BATCH_SIZE):
            batch = users[i:i + self.BATCH_SIZE]

            # å¹¶è¡Œç”Ÿæˆä»ªå¼
            tasks = [
                self._generate_and_send(user, ritual_type)
                for user in batch
            ]

            results = await asyncio.gather(*tasks, return_exceptions=True)

            # è®°å½•å¤±è´¥
            for user, result in zip(batch, results):
                if isinstance(result, Exception):
                    logger.error(f"Ritual failed for {user.vibe_id}: {result}")

            # æ‰¹æ¬¡é—´çŸ­æš‚ä¼‘æ¯ï¼Œé¿å…è¿‡è½½
            await asyncio.sleep(0.5)
```

---

## 3. ä»ªå¼ç”Ÿæˆå™¨

### 3.1 æ™¨è°•ç”Ÿæˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ™¨ è°• ç”Ÿ æˆ æµ ç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   è¾“å…¥:                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ ç”¨æˆ·ä¿¡æ¯    â”‚  â”‚ ä»Šæ—¥è¿åŠ¿    â”‚  â”‚ è·Ÿè¿›äº‹é¡¹    â”‚  â”‚ å³å°†äº‹ä»¶    â”‚       â”‚
â”‚   â”‚ - åå­—      â”‚  â”‚ - å…«å­—è¿åŠ¿  â”‚  â”‚ - å¾…è·Ÿè¿›    â”‚  â”‚ - 3å¤©å†…äº‹ä»¶ â”‚       â”‚
â”‚   â”‚ - æ ¸å¿ƒæœ¬è´¨  â”‚  â”‚ - æ˜Ÿåº§è¿åŠ¿  â”‚  â”‚ - æé†’äº‹é¡¹  â”‚  â”‚             â”‚       â”‚
â”‚   â”‚ - å†…åœ¨è‡ªæˆ‘  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          â”‚                â”‚                â”‚                â”‚              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                           â”‚    LLM ç”Ÿæˆ     â”‚                              â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚   è¾“å‡º:                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  {                                                                  â”‚  â”‚
â”‚   â”‚    "energy_theme": "çªç ´",                                          â”‚  â”‚
â”‚   â”‚    "prediction": "...",                                             â”‚  â”‚
â”‚   â”‚    "advice": "...",                                                 â”‚  â”‚
â”‚   â”‚    "follow_up_reminder": "..."                                      â”‚  â”‚
â”‚   â”‚  }                                                                  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```python
# services/ritual/generators/morning_oracle.py

class MorningOracleGenerator:
    """æ™¨è°•ç”Ÿæˆå™¨"""

    PROMPT_TEMPLATE = """
ä½ æ˜¯ VibeLifeï¼Œæ­£åœ¨ä¸ºç”¨æˆ·ç”Ÿæˆä»Šæ—¥æ™¨è°•ã€‚

## ç”¨æˆ·ä¿¡æ¯
- åå­—: {user_name}
- æ ¸å¿ƒæœ¬è´¨: {core_essence}
- å†…åœ¨è‡ªæˆ‘: {inner_self}

## ä»Šæ—¥è¿åŠ¿
{daily_fortune}

## éœ€è¦è·Ÿè¿›çš„äº‹é¡¹
{follow_ups}

## å³å°†å‘ç”Ÿçš„äº‹ä»¶
{upcoming_events}

è¯·ç”Ÿæˆä»Šæ—¥æ™¨è°•ï¼ŒåŒ…å«:

1. **èƒ½é‡ä¸»é¢˜** (2-3ä¸ªå­—ï¼Œå¦‚"çªç ´"ã€"æ²‰æ·€"ã€"è¿æ¥")
2. **ä»Šæ—¥é¢„æµ‹** (å¯èƒ½é‡åˆ°çš„æƒ…å†µï¼Œå…·ä½“ä¸”æœ‰æ´å¯ŸåŠ›)
3. **åº”å¯¹å»ºè®®** (å¦‚æœå‘ç”Ÿäº†è¯¥æ€ä¹ˆåš)
4. **è·Ÿè¿›æé†’** (å¦‚æœæœ‰éœ€è¦è·Ÿè¿›çš„äº‹é¡¹ï¼Œè‡ªç„¶åœ°æåŠ)

é£æ ¼è¦æ±‚:
- æ¸©æš–ä½†ä¸è…»ï¼Œåƒä¸€ä¸ªäº†è§£ä½ çš„æœ‹å‹
- å…·ä½“è€Œéæ³›æ³›ï¼ŒåŸºäºç”¨æˆ·çš„ç‰¹è´¨
- ç®€æ´æœ‰åŠ›ï¼Œæ€»å­—æ•°ä¸è¶…è¿‡150å­—

è¾“å‡º JSON æ ¼å¼:
{{
    "energy_theme": "...",
    "prediction": "...",
    "advice": "...",
    "follow_up_reminder": "..." // å¯é€‰
}}
"""

    async def generate(self, user_id: str) -> dict:
        """ç”Ÿæˆæ™¨è°•"""

        # è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
        user = await self.user_repo.get(user_id)
        prism = await self.identity_service.get_prism(user_id)
        fortune = await self.fortune_service.get_daily(user_id)
        follow_ups = await self.memory_service.get_follow_ups(user_id)
        events = await self.event_service.get_upcoming(user_id, days=3)

        # æ„å»º prompt
        prompt = self.PROMPT_TEMPLATE.format(
            user_name=user.display_name or "æœ‹å‹",
            core_essence=prism.get('core_essence', {}).get('summary', 'å°šæœªè§£é”'),
            inner_self=prism.get('inner_self', {}).get('summary', 'å°šæœªè§£é”'),
            daily_fortune=self._format_fortune(fortune),
            follow_ups=self._format_follow_ups(follow_ups),
            upcoming_events=self._format_events(events)
        )

        # è°ƒç”¨ LLM
        response = await self.llm.generate(
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )

        oracle = json.loads(response)
        oracle['generated_at'] = datetime.utcnow().isoformat()

        return oracle
```

### 3.2 åˆç…§ç”Ÿæˆ

```python
# services/ritual/generators/midday_mirror.py

class MiddayMirrorGenerator:
    """åˆç…§ç”Ÿæˆå™¨"""

    PROMPT_TEMPLATE = """
ä½ æ˜¯ VibeLifeï¼Œæ­£åœ¨ä¸ºç”¨æˆ·ç”Ÿæˆåˆé—´åæ€ã€‚

## ä»Šæ—¥æ™¨è°•
èƒ½é‡ä¸»é¢˜: {morning_theme}
é¢„æµ‹: {morning_prediction}

## ç”¨æˆ·ç‰¹è´¨
{user_traits}

è¯·ç”Ÿæˆåˆç…§å†…å®¹:

1. **åæ€é—®é¢˜** (è¯¢é—®ä¸Šåˆçš„æƒ…å†µï¼Œè‡ªç„¶åœ°å¼•ç”¨æ™¨è°•)
2. **æ™¨è°•å›é¡¾** (ç®€çŸ­æåŠæ—©ä¸Šçš„é¢„æµ‹)

é£æ ¼è¦æ±‚:
- åƒæœ‹å‹ä¸­åˆå‘æ¥çš„å…³å¿ƒæ¶ˆæ¯
- è‡ªç„¶ã€è½»æ¾ï¼Œä¸è¦å¤ªæ­£å¼
- æ€»å­—æ•°ä¸è¶…è¿‡50å­—

è¾“å‡º JSON æ ¼å¼:
{{
    "check_in_question": "...",
    "morning_reference": "..."
}}
"""

    async def generate(self, user_id: str) -> dict:
        """ç”Ÿæˆåˆç…§"""

        # è·å–ä»Šæ—¥æ™¨è°•
        today_ritual = await self.ritual_repo.get_today(user_id)
        morning_oracle = today_ritual.get('morning_oracle', {})

        if not morning_oracle:
            # å¦‚æœæ²¡æœ‰æ™¨è°•ï¼Œç”Ÿæˆé€šç”¨åˆç…§
            return await self._generate_generic_midday(user_id)

        # è·å–ç”¨æˆ·ç‰¹è´¨
        prism = await self.identity_service.get_prism(user_id)

        prompt = self.PROMPT_TEMPLATE.format(
            morning_theme=morning_oracle.get('energy_theme', ''),
            morning_prediction=morning_oracle.get('prediction', ''),
            user_traits=prism.get('core_essence', {}).get('summary', '')
        )

        response = await self.llm.generate(
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )

        mirror = json.loads(response)
        mirror['generated_at'] = datetime.utcnow().isoformat()

        return mirror

    async def process_response(self, user_id: str, response: str) -> dict:
        """å¤„ç†ç”¨æˆ·å¯¹åˆç…§çš„å›å¤"""

        # æå–è®°å¿†
        memories = await self.memory_extractor.extract_from_text(
            user_id, response
        )

        # ç”Ÿæˆ AI è·Ÿè¿›
        follow_up = await self._generate_follow_up(user_id, response)

        return {
            'ai_follow_up': follow_up,
            'extracted_memories': memories
        }
```

### 3.3 å¤œè¯­ç”Ÿæˆ

```python
# services/ritual/generators/night_whisper.py

class NightWhisperGenerator:
    """å¤œè¯­ç”Ÿæˆå™¨"""

    PROMPT_TEMPLATE = """
ä½ æ˜¯ VibeLifeï¼Œæ­£åœ¨ä¸ºç”¨æˆ·ç”Ÿæˆæ™šé—´å¤œè¯­ã€‚

## ä»Šæ—¥äº’åŠ¨æ‘˜è¦
{today_summary}

## ä»Šæ—¥æ™¨è°•å›é¡¾
èƒ½é‡ä¸»é¢˜: {morning_theme}
é¢„æµ‹: {morning_prediction}

## æ˜æ—¥è¿åŠ¿é¢„è§ˆ
{tomorrow_preview}

## ç”¨æˆ·ç‰¹è´¨
{user_traits}

è¯·ç”Ÿæˆå¤œè¯­å†…å®¹:

1. **ä»Šæ—¥æ€»ç»“** (æ¸©æš–åœ°å›é¡¾ä»Šå¤©ï¼Œå¦‚æœæœ‰äº’åŠ¨åˆ™æåŠ)
2. **æ˜æ—¥é¢„è§ˆ** (ç®€çŸ­é¢„å‘Šæ˜å¤©çš„èƒ½é‡)
3. **æ™šå®‰å¯„è¯­** (æ¸©æš–çš„ç»“æŸè¯­ï¼Œå¯ä»¥ç”¨ç”¨æˆ·çš„åå­—)

é£æ ¼è¦æ±‚:
- æ¸©æš–ã€æ²»æ„ˆï¼Œåƒç¡å‰çš„è½»å£°ç»†è¯­
- è®©ç”¨æˆ·æ„Ÿåˆ°è¢«å…³å¿ƒå’Œç†è§£
- æ€»å­—æ•°ä¸è¶…è¿‡100å­—

è¾“å‡º JSON æ ¼å¼:
{{
    "day_summary": "...",
    "tomorrow_preview": "...",
    "closing_message": "..."
}}
"""

    async def generate(self, user_id: str) -> dict:
        """ç”Ÿæˆå¤œè¯­"""

        user = await self.user_repo.get(user_id)
        today_ritual = await self.ritual_repo.get_today(user_id)
        morning_oracle = today_ritual.get('morning_oracle', {})

        # è·å–ä»Šæ—¥äº’åŠ¨æ‘˜è¦
        today_summary = await self._get_today_summary(user_id)

        # è·å–æ˜æ—¥è¿åŠ¿é¢„è§ˆ
        tomorrow_preview = await self.fortune_service.get_preview(user_id, days=1)

        # è·å–ç”¨æˆ·ç‰¹è´¨
        prism = await self.identity_service.get_prism(user_id)

        prompt = self.PROMPT_TEMPLATE.format(
            today_summary=today_summary,
            morning_theme=morning_oracle.get('energy_theme', ''),
            morning_prediction=morning_oracle.get('prediction', ''),
            tomorrow_preview=tomorrow_preview,
            user_traits=prism.get('core_essence', {}).get('summary', '')
        )

        response = await self.llm.generate(
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )

        whisper = json.loads(response)
        whisper['generated_at'] = datetime.utcnow().isoformat()
        whisper['user_name'] = user.display_name

        return whisper
```

---

## 4. æ¨é€æœåŠ¡

### 4.1 å¤šæ¸ é“æ¨é€æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¤š æ¸  é“ æ¨ é€ æ¶ æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                          â”‚                     â”‚                           â”‚
â”‚                          â”‚    PushService      â”‚                           â”‚
â”‚                          â”‚                     â”‚                           â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                     â”‚                                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚           â”‚                         â”‚                         â”‚            â”‚
â”‚           â–¼                         â–¼                         â–¼            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚     â”‚
â”‚   â”‚   Web Push      â”‚     â”‚   APNS/FCM      â”‚     â”‚   WeChat        â”‚     â”‚
â”‚   â”‚   Provider      â”‚     â”‚   Provider      â”‚     â”‚   Provider      â”‚     â”‚
â”‚   â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚            â”‚                       â”‚                       â”‚              â”‚
â”‚            â–¼                       â–¼                       â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚     â”‚
â”‚   â”‚   æµè§ˆå™¨        â”‚     â”‚   iOS/Android   â”‚     â”‚   å¾®ä¿¡          â”‚     â”‚
â”‚   â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```python
# services/push/service.py

class PushService:
    """å¤šæ¸ é“æ¨é€æœåŠ¡"""

    def __init__(
        self,
        web_push: WebPushProvider,
        apns: APNSProvider,
        fcm: FCMProvider,
        wechat: WeChatProvider
    ):
        self.providers = {
            'web': web_push,
            'ios': apns,
            'android': fcm,
            'wechat': wechat
        }

    async def send(
        self,
        user_id: str,
        title: str,
        body: str,
        data: dict = None,
        channels: list = None
    ):
        """å‘é€æ¨é€é€šçŸ¥"""

        # è·å–ç”¨æˆ·çš„æ¨é€è®¢é˜…
        subscriptions = await self.subscription_repo.get_by_user(user_id)

        if not subscriptions:
            logger.info(f"No push subscriptions for user {user_id}")
            return

        # è¿‡æ»¤æ¸ é“
        if channels:
            subscriptions = [s for s in subscriptions if s.channel in channels]

        # å‘é€åˆ°å„æ¸ é“
        for sub in subscriptions:
            provider = self.providers.get(sub.channel)
            if provider:
                try:
                    await provider.send(
                        subscription=sub,
                        title=title,
                        body=body,
                        data=data
                    )
                except Exception as e:
                    logger.error(f"Push failed for {sub.channel}: {e}")
                    # æ ‡è®°å¤±è´¥çš„è®¢é˜…
                    await self._handle_push_failure(sub, e)
```

### 4.2 Web Push Provider

```python
# services/push/providers/web_push.py

from pywebpush import webpush, WebPushException

class WebPushProvider:
    """Web Push æ¨é€æä¾›è€…"""

    def __init__(self, vapid_private_key: str, vapid_claims: dict):
        self.vapid_private_key = vapid_private_key
        self.vapid_claims = vapid_claims

    async def send(
        self,
        subscription: PushSubscription,
        title: str,
        body: str,
        data: dict = None
    ):
        """å‘é€ Web Push"""

        payload = json.dumps({
            'title': title,
            'body': body,
            'data': data or {},
            'icon': '/icons/vibe-icon-192.png',
            'badge': '/icons/vibe-badge.png',
            'tag': data.get('type', 'notification'),
            'actions': self._get_actions(data)
        })

        try:
            webpush(
                subscription_info=subscription.subscription_info,
                data=payload,
                vapid_private_key=self.vapid_private_key,
                vapid_claims=self.vapid_claims
            )
        except WebPushException as e:
            if e.response.status_code == 410:
                # è®¢é˜…å·²å¤±æ•ˆ
                raise SubscriptionExpiredError(subscription.id)
            raise

    def _get_actions(self, data: dict) -> list:
        """æ ¹æ®é€šçŸ¥ç±»å‹è¿”å›æ“ä½œæŒ‰é’®"""

        notification_type = data.get('type', '')

        if notification_type == 'morning_oracle':
            return [
                {'action': 'view', 'title': 'æŸ¥çœ‹è¯¦æƒ…'},
                {'action': 'chat', 'title': 'å¼€å§‹å¯¹è¯'}
            ]
        elif notification_type == 'midday_mirror':
            return [
                {'action': 'respond', 'title': 'å›å¤'}
            ]
        elif notification_type == 'event_reminder':
            return [
                {'action': 'view', 'title': 'æŸ¥çœ‹'},
                {'action': 'chat', 'title': 'èŠèŠ'}
            ]

        return []
```

### 4.3 å¾®ä¿¡æ¨é€ Provider

```python
# services/push/providers/wechat.py

class WeChatProvider:
    """å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ¨é€"""

    TEMPLATE_IDS = {
        'morning_oracle': 'TEMPLATE_ID_MORNING',
        'midday_mirror': 'TEMPLATE_ID_MIDDAY',
        'night_whisper': 'TEMPLATE_ID_NIGHT',
        'event_reminder': 'TEMPLATE_ID_EVENT'
    }

    async def send(
        self,
        subscription: PushSubscription,
        title: str,
        body: str,
        data: dict = None
    ):
        """å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯"""

        template_id = self.TEMPLATE_IDS.get(data.get('type'), 'TEMPLATE_ID_DEFAULT')

        message = {
            'touser': subscription.wechat_openid,
            'template_id': template_id,
            'url': f"{settings.WEB_URL}/ritual/{data.get('ritual_id', '')}",
            'data': {
                'first': {'value': title},
                'keyword1': {'value': body},
                'remark': {'value': 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}
            }
        }

        async with httpx.AsyncClient() as client:
            response = await client.post(
                f"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token={await self._get_access_token()}",
                json=message
            )
            result = response.json()

            if result.get('errcode') != 0:
                raise WeChatPushError(result.get('errmsg'))
```

---

## 5. æ¨é€è®¢é˜…ç®¡ç†

### 5.1 æ•°æ®æ¨¡å‹

```sql
-- æ¨é€è®¢é˜…è¡¨
CREATE TABLE push_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),

    -- æ¸ é“ä¿¡æ¯
    channel VARCHAR(20) NOT NULL,  -- web, ios, android, wechat
    device_id VARCHAR(255),

    -- è®¢é˜…ä¿¡æ¯ (å„æ¸ é“ä¸åŒ)
    subscription_info JSONB NOT NULL,
    -- web: {endpoint, keys: {p256dh, auth}}
    -- ios: {device_token}
    -- android: {fcm_token}
    -- wechat: {openid}

    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT true,
    last_used_at TIMESTAMP,
    failure_count INTEGER DEFAULT 0,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(user_id, channel, device_id)
);

CREATE INDEX idx_push_sub_user ON push_subscriptions(user_id);
CREATE INDEX idx_push_sub_active ON push_subscriptions(is_active) WHERE is_active = true;
```

### 5.2 è®¢é˜… API

```python
# routes/push.py

@router.post("/subscribe")
async def subscribe(
    request: SubscribeRequest,
    user: VibeUser = Depends(get_current_user)
):
    """è®¢é˜…æ¨é€"""

    subscription = await push_service.subscribe(
        user_id=user.vibe_id,
        channel=request.channel,
        subscription_info=request.subscription_info,
        device_id=request.device_id
    )

    return {"subscription_id": subscription.id}

@router.post("/unsubscribe")
async def unsubscribe(
    request: UnsubscribeRequest,
    user: VibeUser = Depends(get_current_user)
):
    """å–æ¶ˆè®¢é˜…"""

    await push_service.unsubscribe(
        user_id=user.vibe_id,
        subscription_id=request.subscription_id
    )

    return {"status": "unsubscribed"}

@router.get("/subscriptions")
async def get_subscriptions(user: VibeUser = Depends(get_current_user)):
    """è·å–ç”¨æˆ·çš„æ¨é€è®¢é˜…"""

    subscriptions = await push_service.get_subscriptions(user.vibe_id)
    return {"subscriptions": subscriptions}
```

---

## 6. ä»ªå¼ API

### 6.1 è·¯ç”±å®šä¹‰

```python
# routes/rituals.py

@router.get("/today")
async def get_today_rituals(user: VibeUser = Depends(get_current_user)):
    """è·å–ä»Šæ—¥ä»ªå¼"""

    ritual = await ritual_service.get_today(user.vibe_id)
    return ritual

@router.post("/midday/respond")
async def respond_to_midday(
    request: MiddayResponseRequest,
    user: VibeUser = Depends(get_current_user)
):
    """å›å¤åˆç…§"""

    result = await ritual_service.process_midday_response(
        user_id=user.vibe_id,
        response=request.response
    )

    return result

@router.put("/preferences")
async def update_preferences(
    request: RitualPreferencesRequest,
    user: VibeUser = Depends(get_current_user)
):
    """æ›´æ–°ä»ªå¼åå¥½"""

    await ritual_service.update_preferences(
        user_id=user.vibe_id,
        preferences=request.dict()
    )

    return {"status": "updated"}

@router.get("/history")
async def get_ritual_history(
    days: int = 7,
    user: VibeUser = Depends(get_current_user)
):
    """è·å–ä»ªå¼å†å²"""

    history = await ritual_service.get_history(user.vibe_id, days=days)
    return {"history": history}
```

---

## 7. å‰ç«¯é›†æˆ

### 7.1 Service Worker

```javascript
// public/sw.js

self.addEventListener('push', (event) => {
  const data = event.data.json()

  const options = {
    body: data.body,
    icon: data.icon || '/icons/vibe-icon-192.png',
    badge: data.badge || '/icons/vibe-badge.png',
    tag: data.tag,
    data: data.data,
    actions: data.actions || [],
    vibrate: [100, 50, 100],
    requireInteraction: data.tag === 'midday_mirror'
  }

  event.waitUntil(
    self.registration.showNotification(data.title, options)
  )
})

self.addEventListener('notificationclick', (event) => {
  event.notification.close()

  const data = event.notification.data
  let url = '/'

  if (event.action === 'respond' || event.action === 'chat') {
    url = '/chat'
  } else if (event.action === 'view') {
    url = `/ritual/${data.ritual_id || 'today'}`
  } else if (data.type === 'morning_oracle') {
    url = '/home'
  }

  event.waitUntil(
    clients.matchAll({ type: 'window' }).then((clientList) => {
      for (const client of clientList) {
        if (client.url.includes(self.location.origin) && 'focus' in client) {
          client.navigate(url)
          return client.focus()
        }
      }
      return clients.openWindow(url)
    })
  )
})
```

### 7.2 æ¨é€è®¢é˜… Hook

```tsx
// hooks/usePushNotifications.ts

export function usePushNotifications() {
  const [permission, setPermission] = useState<NotificationPermission>('default')
  const [isSubscribed, setIsSubscribed] = useState(false)

  useEffect(() => {
    if ('Notification' in window) {
      setPermission(Notification.permission)
    }
    checkSubscription()
  }, [])

  const checkSubscription = async () => {
    if ('serviceWorker' in navigator) {
      const registration = await navigator.serviceWorker.ready
      const subscription = await registration.pushManager.getSubscription()
      setIsSubscribed(!!subscription)
    }
  }

  const subscribe = async () => {
    // è¯·æ±‚æƒé™
    const permission = await Notification.requestPermission()
    setPermission(permission)

    if (permission !== 'granted') {
      throw new Error('Notification permission denied')
    }

    // è·å– Service Worker
    const registration = await navigator.serviceWorker.ready

    // è®¢é˜…æ¨é€
    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(
        process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY!
      )
    })

    // å‘é€åˆ°æœåŠ¡å™¨
    await api.post('/api/v1/push/subscribe', {
      channel: 'web',
      subscription_info: subscription.toJSON()
    })

    setIsSubscribed(true)
  }

  const unsubscribe = async () => {
    const registration = await navigator.serviceWorker.ready
    const subscription = await registration.pushManager.getSubscription()

    if (subscription) {
      await subscription.unsubscribe()
      await api.post('/api/v1/push/unsubscribe')
    }

    setIsSubscribed(false)
  }

  return {
    permission,
    isSubscribed,
    subscribe,
    unsubscribe,
    isSupported: 'Notification' in window && 'serviceWorker' in navigator
  }
}
```

---

## 8. å®æ–½æ£€æŸ¥æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å® æ–½ æ£€ æŸ¥ æ¸… å•                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   æ•°æ®å±‚                                                                    â”‚
â”‚   [ ] åˆ›å»º push_subscriptions è¡¨                                            â”‚
â”‚   [ ] åˆ›å»º daily_rituals è¡¨                                                 â”‚
â”‚                                                                             â”‚
â”‚   è°ƒåº¦å™¨                                                                    â”‚
â”‚   [ ] å®ç° RitualScheduler                                                  â”‚
â”‚   [ ] å®ç° RitualBatchProcessor                                             â”‚
â”‚                                                                             â”‚
â”‚   ç”Ÿæˆå™¨                                                                    â”‚
â”‚   [ ] å®ç° MorningOracleGenerator                                           â”‚
â”‚   [ ] å®ç° MiddayMirrorGenerator                                            â”‚
â”‚   [ ] å®ç° NightWhisperGenerator                                            â”‚
â”‚                                                                             â”‚
â”‚   æ¨é€æœåŠ¡                                                                  â”‚
â”‚   [ ] å®ç° PushService                                                      â”‚
â”‚   [ ] å®ç° WebPushProvider                                                  â”‚
â”‚   [ ] å®ç° WeChatProvider (å¯é€‰)                                            â”‚
â”‚   [ ] é…ç½® VAPID å¯†é’¥                                                       â”‚
â”‚                                                                             â”‚
â”‚   API                                                                       â”‚
â”‚   [ ] åˆ›å»ºä»ªå¼ API è·¯ç”±                                                     â”‚
â”‚   [ ] åˆ›å»ºæ¨é€ API è·¯ç”±                                                     â”‚
â”‚                                                                             â”‚
â”‚   å‰ç«¯                                                                      â”‚
â”‚   [ ] å®ç° Service Worker                                                   â”‚
â”‚   [ ] å®ç° usePushNotifications hook                                        â”‚
â”‚                                                                             â”‚
â”‚   æµ‹è¯•ä¸éƒ¨ç½²                                                                â”‚
â”‚   [ ] æµ‹è¯•å®Œæ•´ä»ªå¼æµç¨‹                                                      â”‚
â”‚   [ ] é…ç½®ç”Ÿäº§ç¯å¢ƒè°ƒåº¦                                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*ä¸‹ä¸€æ­¥: [07-è¿ç§»ä¸éƒ¨ç½²](./07-è¿ç§»ä¸éƒ¨ç½².md)*

---

*æ–‡æ¡£ç‰ˆæœ¬: v5.ascii*
*åˆ›å»ºæ—¥æœŸ: 2026-01-10*
