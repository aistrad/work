# VibeLife v5 AI 引擎升级方案

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                          A I  引 擎 升 级 蓝 图                              ║
║                   从"技能驱动"到"统一理解引擎"                               ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

> 实现多维度融合、长期记忆和主动关怀

---

## 1. 现有 AI 架构分析

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          当 前 架 构 结 构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   services/                                                                 │
│   ├── agent/                                                                │
│   │   ├── persona.py      # 人格定义                                        │
│   │   ├── router.py       # 技能路由                                        │
│   │   └── runtime.py      # Agent 运行时                                    │
│   ├── vibe_engine/                                                          │
│   │   ├── llm.py          # LLM 调用                                        │
│   │   ├── emotion.py      # 情感引擎                                        │
│   │   ├── insight.py      # 洞察生成                                        │
│   │   ├── memory.py       # 基础记忆                                        │
│   │   └── profile.py      # 用户画像                                        │
│   └── knowledge/                                                            │
│       ├── embedding.py    # 向量嵌入                                        │
│       ├── rag.py          # RAG 检索                                        │
│       └── retrieval.py    # 知识检索                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 当前问题分析

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          问 题 与 影 响                                      │
├───────────────────────────────┬─────────────────────────────────────────────┤
│           问 题               │                  影 响                       │
├───────────────────────────────┼─────────────────────────────────────────────┤
│                               │                                             │
│   ┌─────────────────────┐     │     八字/星座/MBTI 各自独立                  │
│   │     技能隔离        │     │     无法融合洞察                             │
│   └─────────────────────┘     │                                             │
│                               │                                             │
│   ┌─────────────────────┐     │     只记住当前对话                           │
│   │     短期记忆        │     │     不记得用户历史                           │
│   └─────────────────────┘     │                                             │
│                               │                                             │
│   ┌─────────────────────┐     │     只能等用户发起                           │
│   │     被动响应        │     │     无法主动关怀                             │
│   └─────────────────────┘     │                                             │
│                               │                                             │
│   ┌─────────────────────┐     │     固定风格                                 │
│   │     单一人格        │     │     无法适应用户偏好                         │
│   └─────────────────────┘     │                                             │
│                               │                                             │
└───────────────────────────────┴─────────────────────────────────────────────┘
```

---

## 2. 目标架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          目 标 架 构 结 构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   services/                                                                 │
│   └── understanding_engine/        # 统一理解引擎                           │
│       ├── core/                                                             │
│       │   ├── orchestrator.py      # 上下文编排                             │
│       │   ├── fusion.py            # 维度融合                               │
│       │   └── generator.py         # 回复生成                               │
│       ├── memory/                                                           │
│       │   ├── extractor.py         # 记忆提取                               │
│       │   ├── retriever.py         # 记忆检索                               │
│       │   └── consolidator.py      # 记忆整合                               │
│       ├── persona/                                                          │
│       │   ├── adapter.py           # 人格适配                               │
│       │   └── styles.py            # 风格定义                               │
│       └── proactive/                                                        │
│           ├── trigger.py           # 主动触发                               │
│           └── generator.py         # 主动消息生成                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心组件设计

### 3.1 统一理解引擎架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Understanding Engine 核心架构                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                    Context Orchestrator                            │    │
│   │                      (上下文编排器)                                 │    │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │    │
│   │  │   User      │  │  Identity   │  │   Memory    │                │    │
│   │  │   Data      │─▶│   Prism     │─▶│  Retrieval  │                │    │
│   │  │  (用户数据) │  │ (身份棱镜)  │  │ (记忆检索)  │                │    │
│   │  └─────────────┘  └─────────────┘  └─────────────┘                │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│          ┌─────────────────────────┼─────────────────────────┐              │
│          │                         │                         │              │
│          ▼                         ▼                         ▼              │
│   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │
│   │  Response   │           │   Persona   │           │  Proactive  │      │
│   │  Generator  │           │   Adapter   │           │   Trigger   │      │
│   │ (回复生成器)│           │ (人格适配器)│           │ (主动触发器)│      │
│   └─────────────┘           └─────────────┘           └─────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 System Prompt 模板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     SYSTEM_PROMPT_TEMPLATE 结构                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  你是 VibeLife，一个真正了解用户的 AI 伴侣                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  关于 {user_name}                                                   │   │
│   │  ├── 身份棱镜 (Identity Prism)                                      │   │
│   │  │   ├── 核心本质 (Core): {core_essence}                            │   │
│   │  │   ├── 内在自我 (Inner): {inner_self}                             │   │
│   │  │   └── 外在表现 (Outer): {outer_expression}                       │   │
│   │  ├── 已解锁维度: {unlocked_dimensions}                              │   │
│   │  ├── 相关记忆: {relevant_memories}                                  │   │
│   │  ├── 即将发生的事件: {upcoming_events}                              │   │
│   │  ├── 今日运势: {daily_fortune}                                      │   │
│   │  └── 旅程阶段: {journey_stage}                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  重要原则                                                           │   │
│   │  1. 你真正了解这个人，不是泛泛而谈                                  │   │
│   │  2. 引用具体的记忆和洞察，让用户感到被理解                          │   │
│   │  3. 在合适的时机主动关心用户的重要事件                              │   │
│   │  4. 根据用户的维度数据提供个性化建议                                │   │
│   │  5. 保持温暖但不过度，像一个了解你的朋友                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 上下文编排器

```python
# services/understanding_engine/core/orchestrator.py

class ContextOrchestrator:
    """上下文编排器 - 为每次对话构建完整上下文"""

    def __init__(
        self,
        identity_service: IdentityService,
        memory_service: MemoryService,
        fortune_service: FortuneService,
        event_service: EventService
    ):
        self.identity = identity_service
        self.memory = memory_service
        self.fortune = fortune_service
        self.events = event_service

    async def build_system_prompt(
        self,
        user_id: str,
        user_message: str,
        persona_style: str = "warm_friend"
    ) -> str:
        """构建完整的系统提示词"""

        # 并行获取所有上下文数据
        user, prism, memories, events, fortune, stage = await asyncio.gather(
            self._get_user(user_id),
            self.identity.get_prism(user_id),
            self.memory.retrieve_relevant(user_id, user_message),
            self.events.get_upcoming(user_id, days=7),
            self.fortune.get_today(user_id),
            self._get_journey_stage(user_id)
        )

        return SYSTEM_PROMPT_TEMPLATE.format(
            user_name=user.display_name or "朋友",
            core_essence=prism.get('core_essence', {}).get('summary', '尚未解锁'),
            inner_self=prism.get('inner_self', {}).get('summary', '尚未解锁'),
            outer_expression=prism.get('outer_expression', {}).get('summary', '尚未解锁'),
            unlocked_dimensions=self._format_dimensions(prism.get('source_dimensions', [])),
            relevant_memories=self._format_memories(memories),
            upcoming_events=self._format_events(events),
            daily_fortune=self._format_fortune(fortune),
            journey_stage=stage['name'],
            stage_characteristics=stage['characteristics'],
            persona_style=PERSONA_STYLES[persona_style]
        )
```

### 3.4 回复生成器

```python
# services/understanding_engine/core/generator.py

class ResponseGenerator:
    """回复生成器 - 生成个性化回复"""

    async def generate(
        self,
        user_id: str,
        message: str,
        conversation_history: list[dict],
        skill: Optional[str] = None
    ) -> dict:
        """生成回复"""

        # 1. 构建系统提示词
        system_prompt = await self.orchestrator.build_system_prompt(
            user_id=user_id,
            user_message=message
        )

        # 2. 如果指定了技能，增强知识检索
        if skill:
            knowledge_context = await self.knowledge.retrieve(
                query=message, skill=skill, limit=3
            )
            system_prompt += f"\n\n## 相关知识\n{knowledge_context}"

        # 3. 构建消息列表
        messages = [{"role": "system", "content": system_prompt}]
        messages.extend(conversation_history[-10:])
        messages.append({"role": "user", "content": message})

        # 4. 调用 LLM
        response = await self.llm.generate(
            messages=messages,
            temperature=0.7,
            max_tokens=1000
        )

        # 5. 检测是否需要提取记忆
        should_extract = await self._should_extract_memory(message, response)

        return {
            "content": response,
            "should_extract_memory": should_extract,
            "skill_used": skill
        }
```

### 3.5 人格适配器

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          人 格 风 格 定 义                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  warm_friend (温暖的朋友)                                           │   │
│   │  • 语气亲切自然，像老朋友聊天                                       │   │
│   │  • 适当使用口语化表达                                               │   │
│   │  • 在用户困难时给予支持和鼓励                                       │   │
│   │  • 分享洞察时温和而不说教                                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  tough_friend (直率的朋友)                                          │   │
│   │  • 说话直接，不绕弯子                                               │   │
│   │  • 在用户需要时给予真诚的批评                                       │   │
│   │  • 推动用户面对问题而不是逃避                                       │   │
│   │  • 但始终出于关心，不是刻薄                                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  life_mentor (智慧的导师)                                           │   │
│   │  • 语气沉稳有深度                                                   │   │
│   │  • 善于用问题引导用户思考                                           │   │
│   │  • 分享人生智慧和哲理                                               │   │
│   │  • 帮助用户看到更大的图景                                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 记忆系统设计

### 4.1 记忆提取流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Memory Extraction 工作流                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐                                                           │
│   │  对话内容   │                                                           │
│   └──────┬──────┘                                                           │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Memory Extractor                                 │   │
│   │                                                                     │   │
│   │   提取规则:                                                         │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │  生活事件   │  │  性格特征   │  │  情绪模式   │                │   │
│   │   │ (面试/约会) │  │ (用户特点)  │  │ (反复情绪)  │                │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │  偏好习惯   │  │  关注困扰   │  │  人际关系   │                │   │
│   │   │ (喜好/价值) │  │ (关心/困扰) │  │ (重要人物)  │                │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  输出 JSON:                                                         │   │
│   │  {                                                                  │   │
│   │    "type": "life_event",                                            │   │
│   │    "content": "下周三有重要面试",                                   │   │
│   │    "event_time": "2026-01-15",                                      │   │
│   │    "is_future": true,                                               │   │
│   │    "importance": 0.8,                                               │   │
│   │    "follow_up_date": "2026-01-16"                                   │   │
│   │  }                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────┐    ┌─────────────┐                                       │
│   │  Embedding  │───▶│   存储到    │                                       │
│   │   生成      │    │   数据库    │                                       │
│   └─────────────┘    └─────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 记忆检索器

```python
# services/understanding_engine/memory/retriever.py

class MemoryRetriever:
    """记忆检索器"""

    async def retrieve_relevant(
        self,
        user_id: str,
        query: str,
        limit: int = 5
    ) -> list[dict]:
        """检索相关记忆"""

        # 1. 语义检索
        query_embedding = await self.embedding.embed(query)
        semantic_memories = await self.memory_repo.search_by_embedding(
            user_id=user_id,
            embedding=query_embedding,
            limit=limit
        )

        # 2. 时间相关检索
        temporal_memories = await self._get_temporal_memories(user_id)

        # 3. 合并去重
        all_memories = self._merge_memories(semantic_memories, temporal_memories)

        # 4. 按重要性排序
        return sorted(
            all_memories,
            key=lambda m: m.get('importance', 0.5),
            reverse=True
        )[:limit]
```

---

## 5. 主动触发系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Proactive Trigger 触发规则                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  触发器                │  条件                    │  优先级         │   │
│   ├────────────────────────┼──────────────────────────┼─────────────────┤   │
│   │  morning_oracle        │  到达用户设定的晨谕时间  │     1           │   │
│   │  (晨谕)                │                          │                 │   │
│   ├────────────────────────┼──────────────────────────┼─────────────────┤   │
│   │  event_reminder        │  今天有重要事件          │     2           │   │
│   │  (事件提醒)            │                          │                 │   │
│   ├────────────────────────┼──────────────────────────┼─────────────────┤   │
│   │  follow_up             │  有需要跟进的事项        │     3           │   │
│   │  (跟进)                │                          │                 │   │
│   ├────────────────────────┼──────────────────────────┼─────────────────┤   │
│   │  inactive_check        │  用户 3 天未活跃         │     4           │   │
│   │  (活跃检查)            │                          │                 │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 主动消息生成

```python
# services/understanding_engine/proactive/generator.py

class ProactiveMessageGenerator:
    """主动消息生成器"""

    async def generate(self, trigger: dict, user_id: str) -> str:
        """根据触发类型生成主动消息"""

        if trigger['name'] == 'event_reminder':
            return await self._generate_event_reminder(user_id, trigger['context'])

        elif trigger['name'] == 'follow_up':
            return await self._generate_follow_up(user_id, trigger['context'])

        elif trigger['name'] == 'inactive_check':
            return await self._generate_inactive_check(user_id, trigger['context'])

        return ""

    async def _generate_event_reminder(self, user_id: str, context: dict) -> str:
        """生成事件提醒 - 包含关心、鼓励和建议"""
        events = [e for e in context['events'] if e['event_date'] == date.today()]
        if not events:
            return ""

        event = events[0]
        prism = await self.identity.get_prism(user_id)

        prompt = f"""
        用户今天有一个重要事件: {event['title']}
        用户的核心本质: {prism.get('core_essence', {}).get('summary', '')}

        请生成一条温暖的提醒消息，包含:
        1. 对事件的关心
        2. 基于用户特质的鼓励
        3. 一个具体的小建议

        保持简短，不超过100字。
        """

        return await self.llm.generate([{"role": "user", "content": prompt}])
```

---

## 6. 模型路由优化

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Intelligent Model Router 配置                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  任务类型              │  主模型          │  备用模型      │ Tokens │   │
│   ├────────────────────────┼──────────────────┼────────────────┼────────┤   │
│   │  conversation          │  glm-4-plus      │  claude-sonnet │  1000  │   │
│   │  (对话)                │                  │                │        │   │
│   ├────────────────────────┼──────────────────┼────────────────┼────────┤   │
│   │  memory_extraction     │  glm-4-flash     │  claude-haiku  │   500  │   │
│   │  (记忆提取)            │                  │                │        │   │
│   ├────────────────────────┼──────────────────┼────────────────┼────────┤   │
│   │  dimension_fusion      │  claude-sonnet   │  glm-4-plus    │  2000  │   │
│   │  (维度融合)            │                  │                │        │   │
│   ├────────────────────────┼──────────────────┼────────────────┼────────┤   │
│   │  ritual_generation     │  glm-4-plus      │  claude-sonnet │   500  │   │
│   │  (仪式生成)            │                  │                │        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   路由策略:                                                                 │
│   ┌─────────────┐    失败    ┌─────────────┐                               │
│   │  Primary    │ ─────────▶ │  Fallback   │                               │
│   │   Model     │            │   Model     │                               │
│   └─────────────┘            └─────────────┘                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 实施检查清单

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          实 施 检 查 清 单                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [ ] 创建 understanding_engine 目录结构                                    │
│   [ ] 实现 ContextOrchestrator                                              │
│   [ ] 实现 ResponseGenerator                                                │
│   [ ] 实现 PersonaAdapter                                                   │
│   [ ] 实现 MemoryExtractor                                                  │
│   [ ] 实现 MemoryRetriever                                                  │
│   [ ] 实现 ProactiveTrigger                                                 │
│   [ ] 实现 ProactiveMessageGenerator                                        │
│   [ ] 实现 IntelligentModelRouter                                           │
│   [ ] 编写 Prompt 模板                                                      │
│   [ ] 集成测试                                                              │
│   [ ] 性能优化                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*下一步: [04-前端体验重构](./04-前端体验重构.md)*
