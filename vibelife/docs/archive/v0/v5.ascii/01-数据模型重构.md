# VibeLife v5 数据模型重构方案

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                         数 据 模 型 重 构 蓝 图                              ║
║                    "统一理解引擎" 的数据基础设施                             ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 1. 整体数据架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           VibeLife v5 数据架构                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│   │  用户身份   │    │ 身份棱镜    │    │  记忆系统   │    │  生活事件   │ │
│   │   模型      │───▶│  Identity   │───▶│   Memory    │───▶│   Life      │ │
│   │  (User)     │    │   Prism     │    │   System    │    │   Events    │ │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ │
│         │                  │                  │                  │         │
│         │                  │                  │                  │         │
│         ▼                  ▼                  ▼                  ▼         │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│   │  用户偏好   │    │  维度档案   │    │  AI 洞察    │    │  每日仪式   │ │
│   │ Preferences │    │ Dimensions  │    │  Insights   │    │   Rituals   │ │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        订阅与付费系统                                │   │
│   │   ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐  │   │
│   │   │ L0 免费   │───▶│ L1 Letter │───▶│L2 Companion│───▶│L3 Sanctuary│ │   │
│   │   │   ¥0     │    │   ¥29     │    │  ¥39/月   │    │  ¥299/年  │  │   │
│   │   └───────────┘    └───────────┘    └───────────┘    └───────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 用户旅程阶段模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          六阶段用户旅程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   encounter      first_sight     understanding      trust                   │
│   (相遇)          (初见)           (了解)           (信任)                  │
│      │              │                │                │                     │
│      ▼              ▼                ▼                ▼                     │
│   ┌──────┐      ┌──────┐        ┌──────┐        ┌──────┐                   │
│   │ Day  │─────▶│ Day  │───────▶│ Day  │───────▶│ Day  │                   │
│   │  0   │      │  0   │        │ 1-3  │        │ 3-14 │                   │
│   └──────┘      └──────┘        └──────┘        └──────┘                   │
│                                                       │                     │
│                                                       ▼                     │
│                                  ┌──────┐        ┌──────┐                   │
│                                  │ Day  │◀───────│ Day  │                   │
│                                  │ 60+  │        │14-60 │                   │
│                                  └──────┘        └──────┘                   │
│                                      ▲                ▲                     │
│                                      │                │                     │
│                                  symbiosis       dependence                 │
│                                   (共生)          (依赖)                    │
│                                                                             │
│   ════════════════════════════════════════════════════════════════════     │
│   阶段转换条件:                                                             │
│   ────────────────────────────────────────────────────────────────────     │
│   encounter → first_sight    : 完成首次对话                                 │
│   first_sight → understanding: 对话数 >= 3, 天数 >= 2                       │
│   understanding → trust      : 对话数 >= 10, 天数 >= 7, 已付费              │
│   trust → dependence         : 对话数 >= 30, 天数 >= 30, 连续活跃 >= 7天    │
│   dependence → symbiosis     : 天数 >= 60, 连续活跃 >= 14天                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Identity Prism (身份棱镜) 模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Identity Prism 三维身份模型                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────────┐                                │
│                              │    你是谁    │                                │
│                              └──────┬──────┘                                │
│                                     │                                       │
│              ┌──────────────────────┼──────────────────────┐                │
│              │                      │                      │                │
│              ▼                      ▼                      ▼                │
│     ┌────────────────┐    ┌────────────────┐    ┌────────────────┐         │
│     │     Inner      │    │      Core      │    │     Outer      │         │
│     │    内在自我     │    │    核心本质    │    │    外在表现     │         │
│     │                │    │                │    │                │         │
│     │  "你内心真正   │    │  "你的本质     │    │  "别人眼中     │         │
│     │   想要的是..." │    │   驱动力是..." │    │   的你是..."   │         │
│     └───────┬────────┘    └───────┬────────┘    └───────┬────────┘         │
│             │                     │                     │                   │
│             │    ┌────────────────┼────────────────┐    │                   │
│             │    │                │                │    │                   │
│             ▼    ▼                ▼                ▼    ▼                   │
│     ┌─────────────────┐  ┌─────────────┐  ┌─────────────────┐              │
│     │   八字月令      │  │  八字日主   │  │    八字时柱     │              │
│     │   星座月亮      │  │  星座太阳   │  │    星座上升     │              │
│     │   MBTI内倾      │  │  MBTI主导   │  │    MBTI外显     │              │
│     └─────────────────┘  └─────────────┘  └─────────────────┘              │
│                                                                             │
│   ════════════════════════════════════════════════════════════════════     │
│   数据结构:                                                                 │
│   ────────────────────────────────────────────────────────────────────     │
│   identity_prism:                                                           │
│     - core_essence:    {summary, keywords[], confidence}                    │
│     - inner_self:      {summary, keywords[], confidence}                    │
│     - outer_expression:{summary, keywords[], confidence}                    │
│     - source_dimensions: ["bazi", "zodiac", "mbti"]                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 记忆系统数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            记忆系统数据流                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐                                                           │
│   │   用户对话   │                                                           │
│   └──────┬──────┘                                                           │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      Memory Extractor                                │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  提取类型:                                                   │   │   │
│   │   │  • life_event      - 生活事件 (面试、约会、考试)             │   │   │
│   │   │  • personality     - 性格特征                                │   │   │
│   │   │  • emotional       - 情绪模式                                │   │   │
│   │   │  • preference      - 偏好习惯                                │   │   │
│   │   │  • concern         - 关注点/困扰                             │   │   │
│   │   │  • relationship    - 人际关系                                │   │   │
│   │   │  • growth          - 成长里程碑                              │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       user_memories 表                               │   │
│   │   ┌───────────┬───────────┬───────────┬───────────┬───────────┐    │   │
│   │   │ memory_   │  content  │  event_   │ follow_up │ embedding │    │   │
│   │   │   type    │           │   time    │   _date   │ vector    │    │   │
│   │   ├───────────┼───────────┼───────────┼───────────┼───────────┤    │   │
│   │   │life_event │"下周面试" │2026-01-15 │2026-01-16 │ [0.1,...]│    │   │
│   │   └───────────┴───────────┴───────────┴───────────┴───────────┘    │   │
│   └──────────────────────────────┬──────────────────────────────────────┘   │
│                                  │                                          │
│          ┌───────────────────────┼───────────────────────┐                  │
│          │                       │                       │                  │
│          ▼                       ▼                       ▼                  │
│   ┌─────────────┐         ┌─────────────┐         ┌───���─────────┐          │
│   │  语义检索   │         │  时间检索   │         │  跟进提醒   │          │
│   │ (Embedding) │         │ (Temporal)  │         │ (Follow-up) │          │
│   └─────────────┘         └─────────────┘         └─────────────┘          │
│                                                                             │
└───────────────────────────────���─────────────────────────────────────────────┘
```

---

## 5. 每日仪式系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           每日三仪式系统                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   06:00-09:00              12:00-14:00              21:00-22:00             │
│        │                        │                        │                  │
│        ▼                        ▼                        ▼                  │
│   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐          │
│   │   晨 谕     │         │   午 照     │         │   夜 语     │          │
│   │  Morning    │         │   Midday    │         │   Night     │          │
│   │   Oracle    │         │   Mirror    │         │   Whisper   │          │
│   └──────┬──────┘         └──────┬──────┘         └──────┬──────┘          │
│          │                       │                       │                  │
│          ▼                       ▼                       ▼                  │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐          │
│   │ • energy_theme  │   │ • check_in_     │   │ • day_summary   │          │
│   │   今日能量主题  │   │   question      │   │   今日总结      │          │
│   │                 │   │   午间问候      │   │                 │          │
│   │ • prediction    │   │                 │   │ • tomorrow_     │          │
│   │   今日预测      │   │ • morning_      │   │   preview       │          │
│   │                 │   │   reference     │   │   明日预览      │          │
│   │ • advice        │   │   晨谕回顾      │   │                 │          │
│   │   应对建议      │   │                 │   │ • closing_      │          │
│   │                 │   │ • user_response │   │   message       │          │
│   │ • follow_up     │   │   用户回复      │   │   晚安寄语      │          │
│   │   跟进提醒      │   │                 │   │                 │          │
│   └─────────────────┘   └─────────────────┘   └─────────────────┘          │
│                                                                             │
│   ════════════════════════════════════════════════════════════════════     │
│   数据存储: daily_rituals 表                                                │
│   ────────────────────────────────────────────────────────────────────     │
│   {                                                                         │
│     user_id, ritual_date,                                                   │
│     morning_oracle: {..., generated_at, sent_at, opened_at},                │
│     midday_mirror:  {..., generated_at, sent_at, responded_at},             │
│     night_whisper:  {..., generated_at, sent_at, opened_at},                │
│     daily_fortune:  {bazi_day_pillar, zodiac_transits, overall_energy}      │
│   }                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 订阅层级权益模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          L0-L3 订阅层级权益                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  L0: 免费体验                                                ¥0    │   │
│   │  ─────────────────────────────────────────────────────────────────  │   │
│   │  [✓] 完整的首次信件          [✓] 3天试用陪伴                       │   │
│   │  [✓] 每日3次对话             [✓] 八字维度                          │   │
│   │  [✗] 每日仪式                [✗] 深度报告                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  L1: The Letter (一次性)                                    ¥29    │   │
│   │  ─────────────────────────────────────────────────────────────────  │   │
│   │  [✓] 完整深度报告 PDF         [✓] Identity Prism 解锁              │   │
│   │  [✓] 10次深度对话             [✓] 八字+星座 维度                   │   │
│   │  [✗] 每日仪式                [✗] 无限对话                          │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  L2: The Companion (月订阅)                                ¥39/月  │   │
│   │  ─────────────────────────────────────────────────────────────────  │   │
│   │  [✓] 无限对话                 [✓] 每日三仪式 (晨谕/午照/夜语)       │   │
│   │  [✓] 每周运势报告             [✓] 1次关系分析/月                   │   │
│   │  [✓] 八字+星座+MBTI+塔罗      [✓] 记忆系统                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  L3: The Sanctuary (年订阅)                               ¥299/年  │   │
│   │  ───────────────────────────────────���─────────────────────────────  │   │
│   │  [✓] 所有 L2 功能             [✓] 无限关系分析                     │   │
│   │  [✓] 季度深度报告             [✓] 年度人生复盘                     │   │
│   │  [✓] 所有维度解锁             [✓] 优先体验新功能                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 核心表结构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            核心表结构关系图                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────────┐                                                     │
│   │    vibe_users     │◀─────────────────────────────────────────┐          │
│   │───────────────────│                                          │          │
│   │ vibe_id (PK)      │                                          │          │
│   │ journey_stage     │                                          │          │
│   │ last_active_at    │                                          │          │
│   │ total_conversations│                                         │          │
│   └─────────┬─────────┘                                          │          │
│             │                                                    │          │
│     ┌───────┴───────┬───────────────┬───────────────┐           │          │
│     │               │               │               │           │          │
│     ▼               ▼               ▼               ▼           │          │
│ ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐          │          │
│ │  user_  │   │identity_│   │  user_  │   │  life_  │          │          │
│ │preferen-│   │  prism  │   │memories │   │ events  │          │          │
│ │  ces    │   │         │   │         │   │         │          │          │
│ └─────────┘   └────┬────┘   └─────────┘   └────┬────┘          │          │
│                    │                           │                │          │
│                    ▼                           ▼                │          │
│              ┌─────────┐                 ┌─────────┐            │          │
│              │dimension│                 │  event_ │            │          │
│              │profiles │                 │reminders│            │          │
│              └─────────┘                 └─────────┘            │          │
│                                                                 │          │
│ ┌─────────┐   ┌─────────┐   ┌─────────┐                        │          │
│ │  daily_ │   │   ai_   │   │  user_  │────────────────────────┘          │
│ │ rituals │   │insights │   │entitle- │                                   │
│ │         │   │         │   │ ments   │                                   │
│ └─────────┘   └─────────┘   └─────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 数据迁移流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据迁移四阶段流程                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Phase 1                Phase 2                Phase 3                     │
│   创建新表               添加新字段             数据回填                    │
│      │                      │                      │                        │
│      ▼                      ▼                      ▼                        │
│   ┌──────┐              ┌──────┐              ┌──────┐              ┌──────┐│
│   │CREATE│─────────────▶│ALTER │─────────────▶│BACK- │─────────────▶│ENABLE││
│   │TABLES│              │TABLES│              │ FILL │              │ NEW  ││
│   └──────┘              └──────┘              └──────┘              └──────┘│
│      │                      │                      │                   │    │
│      │                      │                      │                   │    │
│      ▼                      ▼                      ▼                   ▼    │
│   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌──────────┐ │
│   │• user_         │  │• vibe_users    │  │• 推断旅程阶段  │  │• 启用新  │ │
│   │  preferences   │  │  +journey_stage│  │• 生成初始     │  │  功能    │ │
│   │• identity_prism│  │  +last_active  │  │  Identity     │  │• 开放新  │ │
│   │• dimension_    │  │• conversations │  │  Prism        │  │  API     │ │
│   │  profiles      │  │  +context_     │  │• 迁移现有     │  │• 监控    │ │
│   │• user_memories │  │   snapshot     │  │  订阅数据     │  │  指标    │ │
│   │• life_events   │  │• messages      │  │               │  │          │ │
│   │• daily_rituals │  │  +emotional_   │  │               │  │          │ │
│   │• user_         │  │   state        │  │               │  │          │ │
│   │  entitlements  │  │               │  │               │  │          │ │
│   └────────────────┘  └────────────────┘  └────────────────┘  └──────────┘ │
│                                                                             │
│   ════════════════════════════════════════════════════════════════════     │
│   关键原则:                                                                 │
│   • 不影响现有功能运行                                                      │
│   • 每阶段可独立回滚                                                        │
│   • 数据完整性验证                                                          │
│                                                                             │
└────────────────────────────────────────────���────────────────────────────────┘
```

---

## 9. 实施检查清单

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              实施检查清单                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [ ] 创建 user_preferences 表                                              │
│   [ ] 创建 identity_prism 表                                                │
│   [ ] 创建 dimension_profiles 表                                            │
│   [ ] 创建 user_memories 表                                                 │
│   [ ] 创建 ai_insights 表                                                   │
│   [ ] 创建 life_events 表                                                   │
│   [ ] 创建 event_reminders 表                                               │
│   [ ] 创建 daily_rituals 表                                                 │
│   [ ] 升级 subscription_plans 表                                            │
│   [ ] 创建 user_entitlements 表                                             │
│   [ ] 增强 conversations 表                                                 │
│   [ ] 增强 messages 表                                                      │
│   [ ] 执行数据回填脚本                                                      │
│   [ ] 验证索引性能                                                          │
│   [ ] 配置缓存策略                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*下一步: [02-后端服务重构](./02-后端服务重构.md)*
