# VibeLife Expert System 2.0 设计文档

> 版本: 2.0
> 日期: 2026-01-13
> 目标: 构建堪比真人顶级专家的智能体系统

---

## 一、设计原则

### 1.1 核心理念

**真人专家如何工作？**

```
收集信息 → 计算/排盘 → 快速扫描 → 深入分析 → 给出建议
   ↑            ↑           ↑           ↑          ↑
  工具         工具        模式库      规则库     表达层
```

**分工原则：**
- **工具做确定性任务**：计算、信息收集、结果展示
- **大模型做推理任务**：分析、综合、个性化表达
- **知识库做支撑**：规则、案例、方法论

### 1.2 简化原则

- 最少必要的抽象层级
- 每个组件有明确的单一职责
- 可渐进式扩展，不过度设计

---

## 二、系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         CoreAgent                                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    System Prompt                           │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │  │
│  │  │  Core   │ +│  Active │ +│  User   │ +│ Runtime │      │  │
│  │  │  人格   │  │  Skill  │  │ Context │  │ Context │      │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      工具系统                              │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                │  │
│  │  │ 通用工具 │  │ 技能工具 │  │ 检索工具 │                │  │
│  │  │ (Core)   │  │ (Skill)  │  │  (RAG)   │                │  │
│  │  └──────────┘  └──────────┘  └──────────┘                │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      知识系统                              │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                │  │
│  │  │ 自有知识 │  │ RAG向量库│  │Deep Research│              │  │
│  │  │  (优先)  │  │  (检索)  │  │  (补充)   │                │  │
│  │  └──────────┘  └──────────┘  └──────────┘                │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 工具系统分层

```
┌─────────────────────────────────────────────────────────────────┐
│                        工具注册层级                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Level 1: CoreAgent 级（所有对话可用）                          │
│  ────────────────────────────────────                          │
│  • use_skill          - 技能路由                               │
│  • show_report        - 通用报告展示                           │
│  • show_insight       - 洞察卡片展示                           │
│  • collect_info       - 通用信息收集（弹出表单）               │
│  • search_knowledge   - RAG检索                                │
│                                                                 │
│  Level 2: Skill 级（技能激活后可用）                            │
│  ────────────────────────────────────                          │
│  • Bazi:                                                       │
│    - calculate_bazi   - 排盘计算（确定性）                     │
│    - show_bazi_chart  - 命盘展示                               │
│    - show_bazi_fortune- 运势展示                               │
│                                                                 │
│  • Zodiac:                                                     │
│    - calculate_chart  - 星盘计算（确定性）                     │
│    - show_zodiac_chart- 星盘展示                               │
│    - show_transit     - 行运展示                               │
│                                                                 │
│  • Tarot:                                                      │
│    - draw_cards       - 抽牌（随机性）                         │
│    - show_tarot_spread- 牌阵展示                               │
│                                                                 │
│  • MBTI:                                                       │
│    - start_assessment - 启动问卷                               │
│    - show_mbti_result - 结果展示                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 工具类型定义

| 工具类型 | 职责 | 为什么用工具 | 示例 |
|---------|------|-------------|------|
| **计算型** | 确定性计算 | 大模型无法精确计算 | 排盘、星盘计算 |
| **随机型** | 随机操作 | 需要真随机 | 塔罗抽牌 |
| **收集型** | 信息收集 | 需要结构化表单UI | 出生信息、问卷 |
| **展示型** | 结果呈现 | 需要可视化UI卡片 | 命盘、运势图 |
| **检索型** | 知识检索 | 需要访问RAG | 规则检索、案例检索 |
| **流程型** | 多轮交互 | 需要状态管理 | MBTI测评流程 |

### 2.4 工具与前端卡片同步

```
┌─────────────────────────────────────────────────────────────────┐
│                    工具 ↔ 前端卡片 映射                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  工具调用                        前端渲染                        │
│  ─────────                      ─────────                       │
│                                                                 │
│  show_bazi_chart({              <BaziChartCard                  │
│    pillars: {...},        →       pillars={...}                 │
│    dayun: [...],                  dayun={...}                   │
│    analysis: "..."              />                              │
│  })                                                             │
│                                                                 │
│  collect_info({                 <InfoFormCard                   │
│    form_type: "birth",    →       formType="birth"              │
│    fields: [...]                  onSubmit={...}                │
│  })                             />                              │
│                                                                 │
│  同步机制:                                                       │
│  1. 工具定义包含 card_type 字段                                  │
│  2. 前端维护 card_type → Component 映射表                        │
│  3. 新增工具时同步新增前端卡片组件                               │
│                                                                 │
│  工具定义示例:                                                   │
│  {                                                              │
│    name: "show_bazi_chart",                                     │
│    card_type: "bazi_chart",      // 对应前端组件                │
│    card_props_schema: {...},     // 前端需要的props结构         │
│    ...                                                          │
│  }                                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、Skill 结构设计

### 3.1 简化的Skill目录结构

```
skills/{skill}/
├── SKILL.md              # 技能定义（人格 + SOP + 工具规则）
├── knowledge/            # 知识库
│   ├── sop.yaml          # 核心SOP流程
│   ├── patterns.yaml     # 快速识别模式
│   └── rules.yaml        # 判断规则（分层）
├── tools/                # 工具配置
│   └── tools.yaml        # 本技能的工具定义
└── meta.json             # 元数据
```

### 3.2 SKILL.md 核心结构

```
SKILL.md 必须包含:
├── 1. 专家身份（一句话）
├── 2. 核心SOP（分析流程）
├── 3. 工具调用规则（意图→工具映射）
└── 4. 禁止行为
```

### 3.3 知识文件职责

| 文件 | 职责 | 内容 |
|-----|------|------|
| `sop.yaml` | 标准分析流程 | 专家处理问题的步骤 |
| `patterns.yaml` | 快速识别 | "一眼看出"的典型模式 |
| `rules.yaml` | 判断规则 | IF-THEN形式的专业规则 |

### 3.4 规则分层结构

```yaml
# rules.yaml 分层结构
rules:
  tier1_must_know:      # 红旗规则：必须首先检查
    - id: T1_001
      condition: "..."
      action: "立即提示用户..."
      priority: critical
  
  tier2_core:           # 核心规则：主要判断依据
    - id: T2_001
      condition: "..."
      conclusion: "..."
      confidence: high
  
  tier3_edge:           # 边缘规则：特殊情况
    - id: T3_001
      condition: "..."
      conclusion: "..."
      note: "例外情况"
```

---

## 四、认知框架：专家工作手册

### 4.1 真人专家的工作流程（以八字为例）

```
┌─────────────────────────────────────────────────────────────────┐
│                  八字大师工作手册 (SOP)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Phase 1: 信息收集                                              │
│  ─────────────────                                             │
│  □ 收集出生信息（年月日时 + 地点）                              │
│  □ 确认信息准确性（尤其是时辰）                                │
│  □ 了解用户当前困惑/问题                                       │
│                                                                 │
│  Phase 2: 排盘                                                  │
│  ─────────                                                     │
│  □ 计算四柱八字                                                │
│  □ 排出大运流年                                                │
│  □ 标注当前运势节点                                            │
│                                                                 │
│  Phase 3: 快速扫描（30秒内完成）                                │
│  ────────────────────────────                                  │
│  □ 看日主强弱 → 判断身强/身弱                                  │
│  □ 看月令 → 确定格局方向                                       │
│  □ 看用神 → 确定喜忌                                           │
│  □ 检查红旗信号 → 是否有特殊配置需要注意                       │
│                                                                 │
│  Phase 4: 深入分析（针对用户问题）                              │
│  ────────────────────────────                                  │
│  □ 根据问题类型选择分析路径:                                   │
│    - 性格/自我认知 → 分析日主、十神配置                        │
│    - 事业/财运 → 分析财官、大运流年                            │
│    - 感情/婚姻 → 分析桃花、配偶宫                              │
│    - 健康 → 分析五行平衡、忌神                                 │
│  □ 应用相关规则                                                │
│  □ 检索相似案例（如果有）                                      │
│                                                                 │
│  Phase 5: 综合建议                                              │
│  ─────────────                                                 │
│  □ 总结核心观点（不超过3点）                                   │
│  □ 给出具体建议（可操作）                                      │
│  □ 说明不确定的地方（如果有）                                  │
│  □ 预判用户可能的追问                                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 通用SOP框架

```
┌─────────────────────────────────────────────────────────────────┐
│                    通用专家SOP框架                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                               │
│  │ P1: 收集    │  信息收集阶段                                  │
│  │   (Collect) │  • 确定需要什么信息                           │
│  └──────┬──────┘  • 通过工具或对话收集                         │
│         │         • 确认信息完整性                              │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │ P2: 计算    │  确定性计算阶段                                │
│  │  (Compute)  │  • 调用计算型工具                             │
│  └──────┬──────┘  • 生成基础数据                               │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │ P3: 扫描    │  快速识别阶段                                  │
│  │   (Scan)    │  • 匹配已知模式                               │
│  └──────┬──────┘  • 检查红旗信号                               │
│         │         • 确定分析方向                                │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │ P4: 分析    │  深度分析阶段                                  │
│  │ (Analyze)   │  • 检索相关规则（RAG）                        │
│  └──────┬──────┘  • 应用规则推理                               │
│         │         • 检索相似案例                                │
│         ▼                                                       │
│  ┌─────────────┐                                               │
│  │ P5: 输出    │  结果输出阶段                                  │
│  │  (Output)   │  • 调用展示工具                               │
│  └─────────────┘  • 生成个性化表达                             │
│                   • 准备追问应答                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 SOP与工具的绑定

| SOP阶段 | 触发条件 | 工具调用 | 大模型任务 |
|--------|---------|---------|-----------|
| P1: 收集 | 缺少必要信息 | `collect_info` | 判断缺什么信息 |
| P2: 计算 | 有完整输入 | `calculate_*` | 无（纯计算） |
| P3: 扫描 | 计算完成 | 无 | 模式匹配、红旗检查 |
| P4: 分析 | 用户有具体问题 | `search_knowledge` | 规则推理、案例匹配 |
| P5: 输出 | 分析完成 | `show_*_chart` | 组织表达、预判追问 |

---

## 五、知识系统设计

### 5.1 三层知识来源

```
┌─────────────────────────────────────────────────────────────────┐
│                      知识来源优先级                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  优先级 1: 自有知识库（最高可信度）                              │
│  ────────────────────────────────                              │
│  来源: 经典书籍、专家经验、验证过的规则                         │
│  形式: SKILL.md + knowledge/*.yaml                             │
│  特点: 领域专属、深度knowhow、已验证                           │
│  使用: 作为主要判断依据                                        │
│                                                                 │
│  优先级 2: RAG向量库（中等可信度）                              │
│  ────────────────────────────────                              │
│  来源: 入库的书籍、文章全文                                    │
│  形式: 向量检索 + 原文引用                                     │
│  特点: 信息丰富、可追溯来源                                    │
│  使用: 补充细节、提供原文支持                                  │
│                                                                 │
│  优先级 3: Deep Research（实时补充）                            │
│  ────────────────────────────────                              │
│  来源: 实时网络搜索                                            │
│  形式: 搜索结果摘要                                            │
│  特点: 最新信息、广度覆盖                                      │
│  使用: 补充最新信息、验证不确定内容                            │
│                                                                 │
│  优先级 4: 大模型直接输出（基础能力）                           │
│  ────────────────────────────────                              │
│  来源: 预训练知识                                              │
│  形式: 直接生成                                                │
│  特点: 通用知识、可能有幻觉                                    │
│  使用: 日常对话、通用问题                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 知识融合策略

```
┌─────────────────────────────────────────────────────────────────┐
│                      知识融合决策流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户提问                                                       │
│      │                                                          │
│      ▼                                                          │
│  ┌────────────────────────────────────┐                        │
│  │ 问题分类                            │                        │
│  │ • 专业分析类（需要领域知识）        │                        │
│  │ • 信息查询类（需要检索）            │                        │
│  │ • 日常对话类（通用能力）            │                        │
│  └──────────────┬─────────────────────┘                        │
│                 │                                               │
│      ┌──────────┼──────────┐                                   │
│      ▼          ▼          ▼                                   │
│  ┌───────┐  ┌───────┐  ┌───────┐                              │
│  │专业类 │  │查询类 │  │对话类 │                              │
│  └───┬───┘  └───┬───┘  └───┬───┘                              │
│      │          │          │                                   │
│      ▼          ▼          ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  专业分析类:                                              │ │
│  │  1. 首先检查 SKILL.md 中的规则 (sop/patterns/rules)       │ │
│  │  2. 调用 RAG 检索补充细节                                 │ │
│  │  3. 如有不确定，可调用 Deep Research 验证                 │ │
│  │  4. 最后由大模型综合表达                                  │ │
│  │                                                           │ │
│  │  信息查询类:                                              │ │
│  │  1. 首先调用 RAG 检索相关内容                             │ │
│  │  2. 如 RAG 无结果，调用 Deep Research                     │ │
│  │  3. 由大模型整理输出                                      │ │
│  │                                                           │ │
│  │  日常对话类:                                              │ │
│  │  1. 大模型直接响应                                        │ │
│  │  2. 保持人格一致性（Core Skill）                          │ │
│  │                                                           │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 RAG 融入方式

```
┌─────────────────────────────────────────────────────────────────┐
│                      RAG 在系统中的角色                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 注册为工具                                                  │
│  ────────────                                                  │
│  工具名: search_knowledge                                       │
│  注册层级: CoreAgent 级（所有技能可用）                         │
│  参数:                                                          │
│    - query: 检索词                                             │
│    - skill_id: 技能ID（限定检索范围）                          │
│    - top_k: 返回数量                                           │
│  返回:                                                          │
│    - chunks: 相关文本片段                                      │
│    - sources: 来源信息                                         │
│    - relevance_scores: 相关度分数                              │
│                                                                 │
│  2. 调用时机                                                    │
│  ──────────                                                    │
│  • SOP Phase 4（分析阶段）                                     │
│  • 用户问"为什么"类问题时                                      │
│  • 需要原文支持时                                              │
│  • 规则不足以回答时                                            │
│                                                                 │
│  3. 结果使用方式                                                │
│  ──────────────                                                │
│  • 作为推理的补充证据                                          │
│  • 引用原文增加可信度                                          │
│  • 发现新的相关规则                                            │
│                                                                 │
│  4. 与规则库的关系                                              │
│  ────────────────                                              │
│  • 规则库: 提炼后的精华（快速应用）                            │
│  • RAG: 原始资料（深度补充）                                   │
│  • 规则库不足时 → 检索RAG                                      │
│  • RAG发现新模式 → 可提炼为新规则                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、知识库构建流程

### 6.1 完整构建流程

```
┌─────────────────────────────────────────────────────────────────┐
│                  知识库构建流程 (End-to-End)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: 主题 (theme)                                             │
│      │                                                          │
│      ▼                                                          │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║  Stage 1: 资料收集 (CURATE)                                ║ │
│  ╠═══════════════════════════════════════════════════════════╣ │
│  ║  1.1 经典资料识别                                          ║ │
│  ║      • 领域必读书单（手动指定或自动搜索）                  ║ │
│  ║      • GitHub 开源项目                                     ║ │
│  ║      • 权威网站/论文                                       ║ │
│  ║                                                            ║ │
│  ║  1.2 Deep Research 补充                                    ║ │
│  ║      • 搜索领域最新进展                                    ║ │
│  ║      • 搜索领域争议话题                                    ║ │
│  ║      • 搜索实战案例                                        ║ │
│  ║                                                            ║ │
│  ║  1.3 质量筛选                                              ║ │
│  ║      • 来源可信度评估                                      ║ │
│  ║      • 内容完整性检查                                      ║ │
│  ║                                                            ║ │
│  ║  输出: /knowledge/{theme}/source/                          ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│      │                                                          │
│      ▼                                                          │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║  Stage 2: 格式转换 (CONVERT)                               ║ │
│  ╠═══════════════════════════════════════════════════════════╣ │
│  ║  • PDF/EPUB/DOCX → Markdown                                ║ │
│  ║  • 清洗：去噪、修复乱码                                    ║ │
│  ║  • 结构化：识别章节、标题                                  ║ │
│  ║                                                            ║ │
│  ║  输出: /knowledge/{theme}/converted/                       ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│      │                                                          │
│      ├──────────────────────────┐                              │
│      ▼                          ▼                              │
│  ╔════════════════════╗    ╔════════════════════╗             │
│  ║ Stage 3a: RAG入库  ║    ║ Stage 3b: 知识提取 ║             │
│  ╠════════════════════╣    ╠════════════════════╣             │
│  ║ • 智能分块         ║    ║ • SOP提取          ║             │
│  ║ • Embedding生成    ║    ║ • 模式提取         ║             │
│  ║ • 向量库存储       ║    ║ • 规则提取         ║             │
│  ║                    ║    ║ • 迭代优化         ║             │
│  ║ 输出: 向量数据库   ║    ║ 输出: skills/      ║             │
│  ╚════════════════════╝    ╚════════════════════╝             │
│      │                          │                              │
│      └──────────┬───────────────┘                              │
│                 ▼                                               │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║  Stage 4: 整合验证 (INTEGRATE)                             ║ │
│  ╠═══════════════════════════════════════════════════════════╣ │
│  ║  4.1 规则与RAG一致性检查                                   ║ │
│  ║      • 规则是否有RAG原文支持                               ║ │
│  ║      • RAG中是否有遗漏的规则                               ║ │
│  ║                                                            ║ │
│  ║  4.2 工具配置                                              ║ │
│  ║      • 定义技能专属工具                                    ║ │
│  ║      • 配置工具与前端卡片映射                              ║ │
│  ║                                                            ║ │
│  ║  4.3 端到端测试                                            ║ │
│  ║      • 工具调用测试                                        ║ │
│  ║      • RAG检索测试                                         ║ │
│  ║      • 完整对话流程测试                                    ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.2 Stage 3b 知识提取详细流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   知识提取详细流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: SOP 提取（最重要）                                     │
│  ─────────────────────────                                     │
│  目标: 提取专家处理问题的标准流程                               │
│                                                                 │
│  提取方法:                                                      │
│  • 阅读经典书籍的"方法论"章节                                  │
│  • Deep Research 搜索"{领域} 分析流程/方法"                    │
│  • 参考 GitHub 开源项目的分析逻辑                              │
│                                                                 │
│  输出: sop.yaml                                                 │
│  • 5-7个主要步骤                                               │
│  • 每步的输入/输出/工具调用                                    │
│  • 步骤间的依赖关系                                            │
│                                                                 │
│  Step 2: 模式提取                                               │
│  ────────────────                                              │
│  目标: 提取"一眼能看出"的典型配置                              │
│                                                                 │
│  提取方法:                                                      │
│  • 从书籍中提取"典型案例"描述                                  │
│  • 从 GitHub 项目中提取模式匹配逻辑                            │
│  • 让大模型总结"常见模式"                                      │
│                                                                 │
│  输出: patterns.yaml                                            │
│  • 典型模式（10-20个）                                         │
│  • 红旗信号（5-10个）                                          │
│  • 每个模式的特征和初步判断                                    │
│                                                                 │
│  Step 3: 规则提取                                               │
│  ────────────────                                              │
│  目标: 提取 IF-THEN 形式的判断规则                              │
│                                                                 │
│  提取方法:                                                      │
│  • 逐书逐章提取具体判断规则                                    │
│  • 从 GitHub 项目代码中提取判断逻辑                            │
│  • Deep Research 补充争议性规则                                │
│                                                                 │
│  输出: rules.yaml (分层)                                        │
│  • tier1: 红旗规则（5-10条）                                   │
│  • tier2: 核心规则（30-50条）                                  │
│  • tier3: 边缘规则（20-30条）                                  │
│                                                                 │
│  Step 4: 迭代优化                                               │
│  ────────────────                                              │
│  • 去除常识性规则                                              │
│  • 合并重复规则                                                │
│  • 补充遗漏规则（回读原文）                                    │
│  • 验证规则一致性                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 知识来源融合的具体方法

```
┌─────────────────────────────────────────────────────────────────┐
│                知识来源融合具体方法                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 建库阶段的融合                                              │
│  ─────────────────                                             │
│                                                                 │
│  ┌────────────────┐                                            │
│  │ 自有书籍/资料  │ ──→ 主体知识                               │
│  └────────────────┘     (SOP/模式/规则)                        │
│          +                                                      │
│  ┌────────────────┐                                            │
│  │ Deep Research  │ ──→ 补充最新进展                           │
│  └────────────────┘     争议话题                               │
│          +              实战案例                                │
│  ┌────────────────┐                                            │
│  │ GitHub 项目    │ ──→ 计算库集成                             │
│  └────────────────┘     规则补充                               │
│          +              代码逻辑参考                            │
│  ┌────────────────┐                                            │
│  │ 大模型总结     │ ──→ 知识整理                               │
│  └────────────────┘     格式标准化                             │
│                         缺漏识别                                │
│                                                                 │
│  2. Runtime阶段的融合                                           │
│  ─────────────────────                                         │
│                                                                 │
│  用户提问                                                       │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────┐                       │
│  │ Step 1: 先查本地规则                 │                       │
│  │ 检索 sop.yaml + patterns.yaml       │                       │
│  │ + rules.yaml                        │                       │
│  └─────────────────────────────────────┘                       │
│      │                                                          │
│      ├── 规则足够 ──→ 直接应用                                 │
│      │                                                          │
│      └── 规则不足 ──→ Step 2                                   │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────┐                       │
│  │ Step 2: 检索 RAG                     │                       │
│  │ 调用 search_knowledge 工具          │                       │
│  │ 获取相关原文片段                    │                       │
│  └─────────────────────────────────────┘                       │
│      │                                                          │
│      ├── RAG有结果 ──→ 结合规则+原文回答                       │
│      │                                                          │
│      └── RAG无结果 ──→ Step 3                                  │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────┐                       │
│  │ Step 3: Deep Research (可选)         │                       │
│  │ 对于需要最新信息的问题              │                       │
│  │ 或需要验证的不确定内容              │                       │
│  └─────────────────────────────────────┘                       │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────┐                       │
│  │ Step 4: 大模型综合                   │                       │
│  │ 整合所有信息源                      │                       │
│  │ 生成最终回答                        │                       │
│  └─────────────────────────────────────┘                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、Runtime 设计

### 7.1 请求处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      Runtime 处理流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户消息                                                       │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. 上下文构建                                            │   │
│  │    • 加载 Core Skill（人格）                            │   │
│  │    • 判断是否需要激活专业 Skill                         │   │
│  │    • 加载用户上下文（birth_info, portrait等）           │   │
│  └─────────────────────────────────────────────────────────┘   │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 2. 技能路由                                              │   │
│  │    • 前端指定? → 直接激活                               │   │
│  │    • 未指定? → LLM 判断是否需要 use_skill               │   │
│  └─────────────────────────────────────────────────────────┘   │
│      │                                                          │
│      ├── 日常对话 ──────────────────────────┐                 │
│      │                                       │                 │
│      └── 专业分析 ──→ 激活 Skill            │                 │
│                          │                   │                 │
│                          ▼                   │                 │
│  ┌─────────────────────────────────────┐    │                 │
│  │ 3. SOP 执行                          │    │                 │
│  │                                      │    │                 │
│  │  P1: 收集 ──→ 信息完整?             │    │                 │
│  │       │         │                    │    │                 │
│  │       │    ┌────┴────┐              │    │                 │
│  │       │    ▼         ▼              │    │                 │
│  │       │   是        否              │    │                 │
│  │       │    │         │              │    │                 │
│  │       │    │    collect_info        │    │                 │
│  │       │    │         │              │    │                 │
│  │       │    │    等待用户输入        │    │                 │
│  │       │    │         │              │    │                 │
│  │       ▼    ◄─────────┘              │    │                 │
│  │  P2: 计算 ──→ calculate_*           │    │                 │
│  │       │                              │    │                 │
│  │       ▼                              │    │                 │
│  │  P3: 扫描 ──→ 匹配 patterns.yaml    │    │                 │
│  │       │         检查红旗             │    │                 │
│  │       ▼                              │    │                 │
│  │  P4: 分析 ──→ 应用 rules.yaml       │    │                 │
│  │       │         search_knowledge    │    │                 │
│  │       ▼                              │    │                 │
│  │  P5: 输出 ──→ show_*_chart          │    │                 │
│  │                                      │    │                 │
│  └─────────────────────────────────────┘    │                 │
│      │                                       │                 │
│      └───────────────────────────────────────┘                 │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 4. 响应生成                                              │   │
│  │    • 工具调用结果 → 前端卡片渲染                        │   │
│  │    • 文本响应 → 流式输出                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 System Prompt 动态组装

```
┌─────────────────────────────────────────────────────────────────┐
│                System Prompt 组装顺序                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Part 1: Core Skill (始终加载)                            │   │
│  │ • Vibe 的人格定义                                       │   │
│  │ • 通用对话风格                                          │   │
│  │ • 通用工具说明 (use_skill, show_report等)               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              +                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Part 2: User Context (有则加载)                          │   │
│  │ • birth_info（出生信息）                                │   │
│  │ • identity_prism（身份棱镜）                            │   │
│  │ • portrait（近期画像）                                  │   │
│  │ • life_context（生活上下文）                            │   │
│  │                                                         │   │
│  │ 🔑 格式：叙事化，非JSON                                 │   │
│  │    "用户出生于1990年5月15日..."                         │   │
│  │    而非 {"year": 1990, ...}                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              +                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Part 3: Active Skill (激活后加载)                        │   │
│  │ • 专家身份（一句话）                                    │   │
│  │ • SOP流程（核心分析步骤）                               │   │
│  │ • 技能专属工具                                          │   │
│  │ • 工具调用规则（意图→工具映射）                        │   │
│  │                                                         │   │
│  │ 🔑 不加载完整规则库，运行时通过RAG检索                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              +                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Part 4: Runtime Context (动态生成)                       │   │
│  │ • 当前命盘数据（如果已计算）                            │   │
│  │ • RAG检索结果（如果已检索）                             │   │
│  │ • 对话历史摘要（长对话时）                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 工具调用流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      工具调用流程                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  LLM 决定调用工具                                               │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 工具调用解析                                             │   │
│  │ • 工具名称                                              │   │
│  │ • 参数                                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 工具路由                                                 │   │
│  │                                                         │   │
│  │  CoreAgent级工具?  ──→ 直接执行                         │   │
│  │        │                                                │   │
│  │        └── 否 ──→ Skill级工具                          │   │
│  │                      │                                  │   │
│  │                      └──→ 检查技能是否激活              │   │
│  │                             │                           │   │
│  │                        ┌────┴────┐                     │   │
│  │                        ▼         ▼                     │   │
│  │                       是        否                     │   │
│  │                        │         │                     │   │
│  │                     执行工具   返回错误                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 工具执行                                                 │   │
│  │                                                         │   │
│  │  计算型 ──→ 调用计算服务 ──→ 返回数据                  │   │
│  │  收集型 ──→ 返回表单定义 ──→ 前端渲染表单              │   │
│  │  展示型 ──→ 返回卡片数据 ──→ 前端渲染卡片              │   │
│  │  检索型 ──→ 调用RAG服务 ──→ 返回检索结果               │   │
│  └─────────────────────────────────────────────────────────┘   │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 结果处理                                                 │   │
│  │                                                         │   │
│  │  展示型工具:                                            │   │
│  │  • 结果直接发送到前端渲染                               │   │
│  │  • LLM 生成配套文字说明                                 │   │
│  │                                                         │   │
│  │  计算/检索型工具:                                       │   │
│  │  • 结果注入到 Runtime Context                           │   │
│  │  • LLM 基于结果继续推理                                 │   │
│  │                                                         │   │
│  │  收集型工具:                                            │   │
│  │  • 前端渲染表单                                         │   │
│  │  • 等待用户输入                                         │   │
│  │  • 输入结果触发下一轮对话                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.4 RAG 调用时机

```
┌─────────────────────────────────────────────────────────────────┐
│                      RAG 调用时机决策                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  在 SOP 哪个阶段调用 RAG?                                       │
│                                                                 │
│  P1: 收集 ──→ ❌ 不调用（信息收集阶段）                        │
│                                                                 │
│  P2: 计算 ──→ ❌ 不调用（确定性计算）                          │
│                                                                 │
│  P3: 扫描 ──→ ❌ 不调用（使用本地patterns）                    │
│                                                                 │
│  P4: 分析 ──→ ✅ 主要调用时机                                  │
│                │                                                │
│                ├── 本地规则不足以回答                          │
│                ├── 用户问"为什么"                              │
│                ├── 需要原文支持                                │
│                └── 发现边缘情况                                │
│                                                                 │
│  P5: 输出 ──→ ⚠️ 可选调用                                      │
│                │                                                │
│                └── 需要引用原文增加可信度                      │
│                                                                 │
│  RAG 调用决策伪代码:                                            │
│                                                                 │
│  if phase == "分析":                                            │
│      if local_rules_sufficient(question):                      │
│          apply_local_rules()                                   │
│      else:                                                     │
│          rag_results = search_knowledge(question)              │
│          combine_with_local_rules(rag_results)                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 八、数据结构定义

### 8.1 Skill 配置结构

```yaml
# SKILL.md frontmatter
---
name: string              # 技能ID
display_name: string      # 显示名称
description: string       # 一句话描述
triggers: string[]        # 触发关键词
requires_birth_info: bool # 是否需要出生信息
---
```

### 8.2 SOP 结构

```yaml
# knowledge/sop.yaml
sop:
  name: string            # SOP名称
  description: string     # SOP描述
  
  phases:
    - id: string          # 阶段ID (P1/P2/P3/P4/P5)
      name: string        # 阶段名称
      description: string # 阶段描述
      
      entry_condition: string      # 进入条件
      
      steps:
        - id: string               # 步骤ID
          action: string           # 动作描述
          tool: string | null      # 关联工具（可选）
          output: string           # 输出描述
      
      exit_condition: string       # 退出条件
      next_phase: string | null    # 下一阶段
```

### 8.3 模式库结构

```yaml
# knowledge/patterns.yaml
patterns:
  quick_patterns:         # 快速识别模式
    - id: string
      name: string
      signature: string   # 识别特征（一句话）
      indication: string  # 初步判断
      confidence: high|medium|low
  
  red_flags:              # 红旗信号
    - id: string
      signal: string      # 信号描述
      severity: critical|warning|notice
      action: string      # 应采取的行动
```

### 8.4 规则库结构

```yaml
# knowledge/rules.yaml
rules:
  tier1_must_know:        # 红旗规则（必须首先检查）
    - id: string
      condition: string
      action: string
      priority: critical
      source: string
  
  tier2_core:             # 核心规则（主要判断依据）
    - id: string
      condition: string
      conclusion: string
      confidence: high|medium|low
      source: string
  
  tier3_edge:             # 边缘规则（特殊情况）
    - id: string
      condition: string
      conclusion: string
      note: string        # 注意事项
      source: string
```

### 8.5 工具定义结构

```yaml
# tools/tools.yaml
tools:
  - name: string          # 工具名称
    type: compute|collect|display|retrieve|flow
    description: string   # 工具描述
    
    # 前端卡片映射
    card_type: string     # 对应的前端卡片类型
    card_props:           # 传递给前端的props结构
      - name: string
        type: string
        required: bool
    
    # 调用规则
    when_to_call: string  # 何时调用（给LLM看）
    
    # 参数定义
    parameters:
      - name: string
        type: string
        required: bool
        description: string
    
    # 返回值定义
    returns:
      - name: string
        type: string
        description: string
```

### 8.6 AgentContext 结构

```python
@dataclass
class AgentContext:
    # 用户信息
    user_id: str
    
    # 用户画像
    profile: dict
    # - birth_info: 出生信息
    # - identity_prism: 身份棱镜
    # - life_context: 生活上下文
    
    # 近期画像 (Hot Memory)
    portrait: str | None
    
    # 洞察记忆 (Cold Memory)
    recent_insights: list | None
    
    # 技能相关
    skill: str | None           # 前端指定的技能
    skill_data: dict | None     # 已计算的命盘数据
    
    # 运行时上下文
    rag_results: list | None    # RAG检索结果
    tool_results: list | None   # 工具调用结果
```

---

## 九、关键设计决策

### 9.1 规则库不全量加载

**问题**: 规则库可能有100+条规则，全量加载会导致Prompt过长

**决策**: 
- SKILL.md 只包含 SOP + 模式库概要 + 工具规则
- rules.yaml 在运行时通过 RAG 检索
- 只将相关规则注入 Runtime Context

**实现方式**:
```
用户提问 → 提取关键词 → search_knowledge(关键词) → 
返回相关规则 → 注入 Runtime Context → LLM推理
```

### 9.2 工具先行原则

**问题**: LLM可能用文字描述而不调用工具

**决策**: 在SKILL.md中明确规定"意图→工具"映射表

**映射表结构**:
```markdown
| 用户意图 | 必须调用的工具 | 禁止行为 |
|---------|--------------|---------|
| 看命盘   | show_bazi_chart | 用文字描述四柱 |
| 问运势   | show_bazi_fortune | 用文字描述运势 |
```

### 9.3 信息收集与分析分离

**问题**: 信息不完整时LLM可能猜测

**决策**: 
- 信息收集用工具（弹出表单）
- 分析必须在信息完整后进行
- SOP明确定义"信息完整"的条件

### 9.4 RAG作为补充而非主体

**问题**: 过度依赖RAG会导致响应慢且不稳定

**决策**:
- 主体判断依据是本地规则（sop + patterns + rules精华）
- RAG用于补充细节和提供原文支持
- 只在本地规则不足时调用RAG

---

## 十、实施计划

### 10.1 阶段划分

```
Phase 1: 基础架构 (Week 1-2)
├── 重构 Skill 目录结构
├── 实现工具注册机制（Core级 + Skill级）
├── 实现工具与前端卡片映射
└── 实现 System Prompt 动态组装

Phase 2: 知识系统 (Week 3-4)
├── 定义 SOP/Pattern/Rule 数据结构
├── 实现 RAG 检索工具
├── 实现知识融合逻辑
└── 重构现有 Skill（bazi/zodiac）

Phase 3: Runtime优化 (Week 5-6)
├── 实现 SOP 执行流程
├── 实现规则动态加载
├── 优化工具调用流程
└── 端到端测试

Phase 4: 知识构建流程 (Week 7-8)
├── 实现知识提取流程
├── 实现多源融合流程
├── 构建/优化更多 Skill
└── 持续迭代
```

### 10.2 验收标准

| 阶段 | 验收标准 |
|-----|---------|
| Phase 1 | 工具调用正常，前端卡片正确渲染 |
| Phase 2 | RAG检索有效，规则能正确加载 |
| Phase 3 | 完整SOP流程可执行，响应时间<5s |
| Phase 4 | 新Skill构建流程可复用 |

---

## 十一、待深入讨论的问题

1. **工具与前端卡片的具体映射方案** - 如何保持同步？
2. **RAG检索的具体策略** - 关键词提取、top_k选择
3. **知识提取的Prompt模板** - 如何高效提取SOP/Pattern/Rule
4. **不确定性表达** - 什么时候说"不确定"
5. **多技能融合** - 如何处理 bazi+career 联合分析

---

*文档版本: 1.0*
*最后更新: 2026-01-13*