# VibeLife æ ¸å¿ƒç®—æ³•æµç¨‹ Review

> **ç‰ˆæœ¬**: v4.0
> **æ—¥æœŸ**: 2026-01-09
> **å¯¹æ¯”åŸºå‡†**: `vibelife spec v3.0.md` + `architecture-decisions.md`
> **åˆ†ææ·±åº¦**: æ¶æ„çº§ + å…³é”®è·¯å¾„ä»£ç çº§

---

# ä¸€ã€æ ¸å¿ƒæµç¨‹æ€»è§ˆ (9 ä¸ªæµç¨‹)

> **æœ€åæ›´æ–°**: 2026-01-09
> **çŠ¶æ€**: æ ¸å¿ƒæµç¨‹å®ç°åº¦ 95%+

| # | æµç¨‹åç§° | è®¾è®¡æ–‡æ¡£ä½ç½® | ä»£ç å®ç°ä½ç½® | å®ç°çŠ¶æ€ |
|---|---------|-------------|--------------|---------|
| 1 | **Context æ„å»º** | Spec 4.5 | `context.py` | âœ… å®Œæˆ |
| 2 | **æ·±åº¦æŠ¥å‘Šç”Ÿæˆ** | Spec 2.2.1 | `report_service.py` + `prologue_generator.py` | âœ… å®Œæˆ |
| 3 | **RAG çŸ¥è¯†åº“æ£€ç´¢** | Spec 4.5 | `retrieval.py` + `knowledge_repo.py` | âœ… å®Œæˆ |
| 4 | **AI è®¿è°ˆ** | Spec 4.2 | `interview_service.py` | âœ… å®Œæˆ (å¯è·³è¿‡) |
| 5 | **æ™ºèƒ½ä¿¡æ¯é‡‡é›†** | Spec 4.3 | `extraction_service.py` | âœ… å®Œæˆ |
| 6 | **Identity Prism** | Spec 2.2.3 + 4.6 | `portrait.py` | âœ… å®Œæˆ |
| 7 | **å¯¹è¯æµå¼å“åº”** | Spec 2.2.2 | `chat.py` | âœ… å®Œæˆ (AI SDK 6) |
| 8 | **ç”¨æˆ· Profile ç´¯ç§¯** | Spec 4.4 | `portrait.py` + `profile_repo.py` | âœ… å®Œæˆ |
| 9 | **å…³ç³»æ¨¡æ‹Ÿå™¨/äººç”ŸKçº¿** | Spec 2.2.4 + 2.2.5 | å‰ç«¯ tools + åç«¯è®¡ç®— | âœ… å®Œæˆ |

---

# äºŒã€é‡ç‚¹æµç¨‹æ·±åº¦å¯¹æ¯”

## 2.1 Context æ„å»ºæµç¨‹

### è®¾è®¡è§„æ ¼ (Spec 4.5)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è®¾è®¡ä¸­çš„ Context æ„å»ºæµç¨‹                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  1. è¯é¢˜åˆ†ç±» (classify_topic)                                  â”‚
â”‚     â””â”€ æ ¹æ®æ¶ˆæ¯å†…å®¹è¯†åˆ«: CAREER / RELATIONSHIP / FORTUNE / SELFâ”‚
â”‚                                                                â”‚
â”‚  2. Profile åŠ¨æ€é€‰æ‹© (select_profile_sections)                 â”‚
â”‚     â”œâ”€ æ€»æ˜¯åŒ…å«: basic, identity_prism                         â”‚
â”‚     â”œâ”€ career è¯é¢˜: career, growth_areas                       â”‚
â”‚     â”œâ”€ relationship è¯é¢˜: relationship, relationship_patterns  â”‚
â”‚     â”œâ”€ fortune è¯é¢˜: current_focus, recent_events              â”‚
â”‚     â””â”€ self è¯é¢˜: å…¨éƒ¨ ai_insights                             â”‚
â”‚                                                                â”‚
â”‚  3. çŸ¥è¯†åº“æ£€ç´¢ (retrieve_knowledge)                            â”‚
â”‚     â””â”€ æ ¹æ® skill + query æ£€ç´¢ç›¸å…³å†…å®¹                         â”‚
â”‚                                                                â”‚
â”‚  4. System Prompt æ„å»º                                         â”‚
â”‚     â””â”€ Persona + Voice Mode + Skill Context + é¢å¤–ä¸Šä¸‹æ–‡       â”‚
â”‚                                                                â”‚
â”‚  5. å¯¹è¯å†å² (åŸå§‹ä¿ç•™ï¼Œä¸æ‘˜è¦)                                 â”‚
â”‚     â””â”€ æœ€è¿‘ N è½®å¯¹è¯                                           â”‚
â”‚                                                                â”‚
â”‚  6. ç»„è£…å¹¶è¿”å›                                                  â”‚
â”‚     â””â”€ (system_prompt, messages)                               â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®é™…å®ç° (context.py)

```python
# æ–‡ä»¶: apps/api/services/vibe_engine/context.py

async def build(
    self,
    skill: Skill,
    voice_mode: VoiceMode,
    current_message: str,
    profile: Optional[Dict[str, Any]] = None,
    history: Optional[List[Dict[str, str]]] = None,
    knowledge_chunks: Optional[List[Dict]] = None,  # æ¥è‡ªå¤–éƒ¨ä¼ å…¥
    extra_context: Optional[str] = None
) -> Tuple[str, List[LLMMessage]]:

    # 1. æ„å»º System Prompt âœ…
    system_prompt = self.build_system_prompt(skill, voice_mode, extra_context)

    # 2. è¯é¢˜åˆ†ç±» âœ… (å…³é”®è¯åŒ¹é…)
    topic = self.classify_topic(current_message)

    # 3. Profile é€‰æ‹© âœ…
    if profile:
        profile_sections = self.select_profile_sections(profile, topic)
        profile_context = self.format_profile_context(profile_sections)
        # ...

    # 4. çŸ¥è¯†åº“ç»“æœæ ¼å¼åŒ– âœ… (æ³¨æ„: æ£€ç´¢åœ¨å¤–éƒ¨å®Œæˆ)
    if knowledge_chunks:
        knowledge_context = self.format_knowledge_context(knowledge_chunks)
        # ...

    # 5. æ‹¼æ¥åˆ° system_prompt
    if context_parts:
        system_prompt = system_prompt + "\n\n" + "\n\n".join(context_parts)

    # 6. æ„å»ºæ¶ˆæ¯åˆ—è¡¨ âœ…
    messages = [create_system_message(system_prompt)]
    if history:
        history_messages = self.format_history(history)  # åŸå§‹ä¿ç•™
        messages.extend(history_messages)
    messages.append(create_user_message(current_message))

    return system_prompt, messages
```

### å·®å¼‚åˆ†æ

| è®¾è®¡ç‚¹ | è®¾è®¡è§„æ ¼ | å®é™…å®ç° | å·®å¼‚ |
|--------|---------|---------|------|
| **è¯é¢˜åˆ†ç±»** | LLM åˆ†ç±» + å…³é”®è¯å›è½ | ä»…å…³é”®è¯åŒ¹é… | âš ï¸ ç²¾åº¦ä¸è¶³ |
| **Profile é€‰æ‹©** | åŠ¨æ€é€‰æ‹©ç›¸å…³éƒ¨åˆ† | âœ… æŒ‰è¯é¢˜é€‰æ‹© | ä¸€è‡´ |
| **çŸ¥è¯†åº“æ£€ç´¢** | åœ¨ Context å†…éƒ¨è°ƒç”¨ | åœ¨ chat.py å¤–éƒ¨è°ƒç”¨åä¼ å…¥ | âœ… èŒè´£åˆ†ç¦»æ›´æ¸…æ™° |
| **Token é¢„ç®—ç®¡ç†** | 8000 token é¢„ç®— + åŠ¨æ€è°ƒæ•´ | å®šä¹‰äº† ContextConfig ä½†æœªå¼ºåˆ¶æ‰§è¡Œ | âš ï¸ æ— å®é™… token è®¡æ•° |
| **å¯¹è¯å†å²** | åŸå§‹ä¿ç•™ï¼Œä¸æ‘˜è¦ | âœ… åŸå§‹ä¿ç•™ | ä¸€è‡´ |
| **Voice Mode** | æ¸©æš–/åæ§½åˆ‡æ¢ | âœ… ä¸¤ç§æ¨¡å¼ Suffix | ä¸€è‡´ |

### å…³é”®ä»£ç è·¯å¾„

```
chat_stream() (chat.py:150)
    â”œâ”€ get_user_profile(user_id)        # L177
    â”œâ”€ get_conversation_history(conv_id) # L180
    â”œâ”€ RetrievalService.search()        # L185-189 â† RAG æ£€ç´¢
    â””â”€ context_builder.build()          # L195-202 â† Context ç»„è£…
        â”œâ”€ build_system_prompt()        # context.py:143
        â”œâ”€ classify_topic()             # context.py:172 â† å…³é”®è¯åŒ¹é…
        â”œâ”€ select_profile_sections()    # context.py:214
        â”œâ”€ format_profile_context()     # context.py:271
        â”œâ”€ format_knowledge_context()   # context.py:299
        â””â”€ format_history()             # context.py:316
```

---

## 2.2 æ·±åº¦æŠ¥å‘Šç”Ÿæˆæµç¨‹

### è®¾è®¡è§„æ ¼ (Spec 2.2.1)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è®¾è®¡ä¸­çš„æŠ¥å‘Šç”Ÿæˆæµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  1. åŸºç¡€ä¿¡æ¯é‡‡é›†                                                â”‚
â”‚     â”œâ”€ å¿…å¡«: ç”Ÿæ—¥ï¼ˆå¹´/æœˆ/æ—¥ï¼‰                                  â”‚
â”‚     â””â”€ é€‰å¡«: æ—¶è¾°ã€æ€§åˆ«ã€å‡ºç”Ÿåœ°                                â”‚
â”‚                                                                â”‚
â”‚  2. AI å¼ºåˆ¶è®¿è°ˆ â˜…ï¼ˆå¿…é¡»å®Œæˆï¼Œä¸å¯è·³è¿‡ï¼‰                        â”‚
â”‚     â”œâ”€ 2-3 ä¸ªæ ¸å¿ƒé—®é¢˜                                          â”‚
â”‚     â”œâ”€ é‡‡é›†: å½“å‰å›°å¢ƒã€ç›®æ ‡ã€å…³æ³¨ç‚¹                            â”‚
â”‚     â””â”€ è¿™æ˜¯æŠ¥å‘Šè´¨é‡çš„å…³é”®ä¿éšœ                                  â”‚
â”‚                                                                â”‚
â”‚  3. ç”¨æˆ·ä¸Šä¼ èµ„æ–™ï¼ˆå¯é€‰ï¼‰                                       â”‚
â”‚     â”œâ”€ å…¶ä»– App æ’ç›˜æˆªå›¾                                       â”‚
â”‚     â””â”€ AI è‡ªåŠ¨æŠ½å–å…³é”®ä¿¡æ¯èå…¥åˆ†æ                             â”‚
â”‚                                                                â”‚
â”‚  4. ç”ŸæˆæŠ¥å‘Š                                                    â”‚
â”‚     â”œâ”€ ç»¼åˆåˆ¤æ–­å·é¦–è¯­ (ç¬¬ä¸€äººç§°å™äº‹ï¼Œ10+ å¥)                   â”‚
â”‚     â””â”€ æ ‡å‡†æŠ¥å‘Š (4 ä¸ªç« èŠ‚)                                     â”‚
â”‚                                                                â”‚
â”‚  5. AI ç”Ÿå›¾æµ·æŠ¥ (ä»˜è´¹ç‰ˆ)                                       â”‚
â”‚     â””â”€ è°ƒç”¨ gemini_tool API                                    â”‚
â”‚                                                                â”‚
â”‚  æŠ¥å‘Šå½¢æ€:                                                      â”‚
â”‚  â”œâ”€ ç®€ç‰ˆ (å…è´¹): å·é¦–è¯­ + 2 ç« èŠ‚ + é¢„è§ˆå›¾å¸¦æ°´å°                â”‚
â”‚  â””â”€ å®Œæ•´ç‰ˆ (Â¥19.9): å…¨éƒ¨å†…å®¹ + é«˜æ¸…æµ·æŠ¥                        â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®é™…å®ç° (report_service.py)

```python
# æ–‡ä»¶: apps/api/services/report/report_service.py

async def generate_report(
    self,
    user_id: UUID,
    skill: str,
    report_type: str,       # "lite" or "full"
    profile: Dict[str, Any],
    interview_result: Optional[Dict[str, Any]] = None,
) -> Report:

    report = Report(
        id=report_id,
        user_id=user_id,
        skill=skill_enum,
        report_type=type_enum,
        status=ReportStatus.GENERATING,
        # ...
    )

    # Step 1: ç”Ÿæˆå·é¦–è¯­ âœ…
    from .prologue_generator import PrologueGenerator
    prologue_gen = PrologueGenerator()
    report.prologue = await prologue_gen.generate(
        profile=profile,
        skill=skill,
        interview_summary=report.interview_summary,
    )

    # Step 2: ç”Ÿæˆç« èŠ‚ âœ… (4 ä¸ªç« èŠ‚)
    sections = BAZI_SECTIONS if skill == "bazi" else ZODIAC_SECTIONS

    for i, (section_id, title, subtitle) in enumerate(sections):
        # ç®€ç‰ˆåªç”Ÿæˆå‰ 2 ç« èŠ‚
        is_premium = type_enum == ReportType.LITE and i >= 2

        if is_premium and type_enum == ReportType.LITE:
            section = ReportSection(
                id=section_id,
                title=title,
                subtitle=subtitle,
                content="è§£é”å®Œæ•´æŠ¥å‘ŠæŸ¥çœ‹æ›´å¤šå†…å®¹...",  # å ä½
                is_premium=True,
            )
        else:
            section = await self._generate_section(...)  # LLM ç”Ÿæˆ

        report.sections.append(section)

    # Step 3: ç”Ÿæˆ AI æµ·æŠ¥ (ä»…å®Œæ•´ç‰ˆ) âš ï¸
    if type_enum == ReportType.FULL:
        from .image_generator import ImageGenerator
        img_gen = ImageGenerator()
        image_result = await img_gen.generate_poster(...)  # â† å¯èƒ½æ˜¯å­˜æ ¹
        # ...

    return report
```

### å·®å¼‚åˆ†æ

| è®¾è®¡ç‚¹ | è®¾è®¡è§„æ ¼ | å®é™…å®ç° | å·®å¼‚ |
|--------|---------|---------|------|
| **AI è®¿è°ˆ** | å¿…é¡»å®Œæˆï¼Œä¸å¯è·³è¿‡ | interview_service æ”¯æŒè·³è¿‡ | âš ï¸ å¯è·³è¿‡ï¼Œä¸è®¾è®¡ä¸ç¬¦ |
| **å·é¦–è¯­** | ç¬¬ä¸€äººç§°ï¼Œ10+ å¥ï¼Œèåˆå¤šæºæ•°æ® | æœ‰å®ç°ï¼Œé£æ ¼å‚æ•°åŒ– | âœ… åŸºæœ¬ä¸€è‡´ |
| **ç« èŠ‚ç»“æ„** | 4 ç« èŠ‚ (å‘½ç›˜/æ€§æ ¼/è¿åŠ¿/å»ºè®®) | âœ… 4 ç« èŠ‚å®šä¹‰ä¸€è‡´ | ä¸€è‡´ |
| **lite/full åŒºåˆ†** | å‰ 2 ç« èŠ‚å…è´¹ | âœ… is_premium æ ‡è®° | ä¸€è‡´ |
| **AI ç”Ÿå›¾** | è°ƒç”¨ gemini_tool API | ImageGenerator å­˜åœ¨ï¼Œéœ€éªŒè¯å®é™…è°ƒç”¨ | âš ï¸ éœ€ç¡®è®¤æ˜¯å¦çœŸå®è°ƒç”¨ |
| **æŠ¥å‘ŠæŒä¹…åŒ–** | ä¿å­˜åˆ°æ•°æ®åº“ | ç”Ÿæˆåæœªä¿å­˜åˆ° DB | âŒ ç¼ºå¤±æŒä¹…åŒ– |

### å…³é”®ç¼ºå¤±

1. **æŠ¥å‘ŠæŒä¹…åŒ–**: `report_service.py` ç”ŸæˆæŠ¥å‘Šåç›´æ¥è¿”å›ï¼Œæœªè°ƒç”¨ `report_repo` ä¿å­˜
2. **è®¿è°ˆå¼ºåˆ¶æ€§**: è®¾è®¡è¦æ±‚"ä¸å¯è·³è¿‡"ï¼Œä½† `skip_session()` å…è®¸è·³è¿‡
3. **å‡çº§æµç¨‹**: `upgrade_report()` æŠ›å‡º `NotImplementedError`

### å…³é”®ä»£ç è·¯å¾„

```
POST /report/generate (å‡è®¾å­˜åœ¨)
    â”œâ”€ InterviewService.start_session()   # å¼€å§‹è®¿è°ˆ
    â”œâ”€ InterviewService.submit_answer()   # æäº¤ç­”æ¡ˆ (å¾ªç¯)
    â”œâ”€ InterviewService.get_result()      # è·å–æŠ½å–ç»“æœ
    â””â”€ ReportService.generate_report()    # ç”ŸæˆæŠ¥å‘Š
        â”œâ”€ PrologueGenerator.generate()   # å·é¦–è¯­
        â”œâ”€ _generate_section() Ã— 4        # 4 ä¸ªç« èŠ‚
        â””â”€ ImageGenerator.generate_poster() # AI æµ·æŠ¥
```

---

## 2.3 RAG çŸ¥è¯†åº“æ£€ç´¢æµç¨‹

### è®¾è®¡è§„æ ¼ (Spec 4.5 + Architecture Decisions)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è®¾è®¡ä¸­çš„çŸ¥è¯†åº“æ£€ç´¢æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  1. æŸ¥è¯¢é¢„å¤„ç†                                                  â”‚
â”‚     â””â”€ Jieba åˆ†è¯ (ä¸­æ–‡å¤„ç†) + è‡ªåŠ¨æœ¯è¯­è¯å…¸                    â”‚
â”‚                                                                â”‚
â”‚  2. æ··åˆæ£€ç´¢ (Hybrid Search)                                   â”‚
â”‚     â”œâ”€ å‘é‡æ£€ç´¢: embedding â†’ cosine similarity                 â”‚
â”‚     â”œâ”€ å…¨æ–‡æ£€ç´¢: FTS â†’ ts_rank                                 â”‚
â”‚     â””â”€ RRF èåˆ: Reciprocal Rank Fusion                        â”‚
â”‚                                                                â”‚
â”‚  3. æƒé‡é…ç½®                                                    â”‚
â”‚     â”œâ”€ å‘é‡æƒé‡: 0.7                                           â”‚
â”‚     â””â”€ æ–‡æœ¬æƒé‡: 0.3                                           â”‚
â”‚                                                                â”‚
â”‚  4. è¿”å› Top-K ç»“æœ (é»˜è®¤ 5 æ¡)                                â”‚
â”‚     â””â”€ æ³¨å…¥åˆ° Context çš„ <knowledge> æ ‡ç­¾                      â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®é™…å®ç° (rag_service.py + term_service.py + retrieval.py)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG æœåŠ¡æ¶æ„ (v4.1)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  RAGService (ç»Ÿä¸€å…¥å£)                                          â”‚
â”‚  â”œâ”€ build_query()      â† Skill é…ç½®åŒ–æŸ¥è¯¢æ„å»º                  â”‚
â”‚  â”œâ”€ get_knowledge()    â† æ··åˆæ£€ç´¢ + æœ¯è¯­åŠ è½½                   â”‚
â”‚  â”œâ”€ format_for_prompt() â† XML æ ¼å¼åŒ–                           â”‚
â”‚  â””â”€ get_context_for_service() â† ä¸€ç«™å¼æ–¹æ³•                     â”‚
â”‚                                                                â”‚
â”‚  TermService (æœ¯è¯­ç®¡ç†)                                         â”‚
â”‚  â”œâ”€ extract_terms_from_content() â† LLM è‡ªåŠ¨æå–                â”‚
â”‚  â”œâ”€ load_terms_to_jieba()        â† åŠ è½½åˆ°åˆ†è¯å™¨                â”‚
â”‚  â””â”€ load_skill_config()          â† åŠ è½½ Skill é…ç½®             â”‚
â”‚                                                                â”‚
â”‚  RetrievalService (æ£€ç´¢å±‚)                                      â”‚
â”‚  â”œâ”€ preprocess_query() â† Jieba åˆ†è¯                            â”‚
â”‚  â””â”€ search()           â† æ··åˆæ£€ç´¢                              â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```python
# æ–‡ä»¶: apps/api/services/knowledge/rag_service.py

@classmethod
async def build_query(
    cls,
    profile: Dict[str, Any],
    skill_id: str,           # æ–°å¢: skill æ„ŸçŸ¥
    context_type: str,
    extra_keywords: Optional[List[str]] = None,
) -> str:
    # åŠ è½½ skill é…ç½®
    config = await TermService.load_skill_config(skill_id)

    if config:
        # é…ç½®é©±åŠ¨çš„å­—æ®µæå–
        for field_path in config.profile_fields:
            value = cls._get_nested_value(profile, field_path)
            if value:
                fmt = config.field_formats.get(field_path, "{value}")
                parts.append(fmt.format(value=value))

        # åœºæ™¯å…³é”®è¯
        context_kw = config.context_keywords.get(context_type, [])
        parts.extend(context_kw)
    else:
        # å›é€€åˆ°æ—§é€»è¾‘
        parts = cls._build_query_legacy(profile, context_type)

    return " ".join(filter(None, parts))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# æ–‡ä»¶: apps/api/services/knowledge/term_service.py

@classmethod
async def extract_terms_from_content(
    cls,
    content: str,
    skill_id: str,
    source_doc_id: Optional[str] = None,
) -> List[str]:
    """å…¥åº“æ—¶ LLM è‡ªåŠ¨æå–ä¸“ä¸šæœ¯è¯­"""

    response = await llm.chat([create_user_message(
        cls.EXTRACT_PROMPT.format(
            skill_name=config.display_name,
            content=content[:3000]
        )
    )])

    terms = json.loads(response.content)
    await cls.save_terms(skill_id, terms, source_doc_id)

    # ç«‹å³åŠ è½½åˆ° Jieba
    for term in terms:
        jieba.add_word(term)

    return terms
```

### å·®å¼‚åˆ†æ

| è®¾è®¡ç‚¹ | è®¾è®¡è§„æ ¼ | å®é™…å®ç° | å·®å¼‚ |
|--------|---------|---------|------|
| **Jieba åˆ†è¯** | åº”ç”¨å±‚åˆ†è¯ | âœ… `preprocess_query()` | ä¸€è‡´ |
| **æ··åˆæ£€ç´¢** | Vector + FTS + RRF | âœ… SQL å‡½æ•° `hybrid_search_v2()` | ä¸€è‡´ |
| **æƒé‡** | å‘é‡ 0.7, æ–‡æœ¬ 0.3 | âœ… é»˜è®¤å‚æ•°ä¸€è‡´ | ä¸€è‡´ |
| **Top-K** | é»˜è®¤ 3 æ¡ | é»˜è®¤ 5 æ¡ï¼Œå¯é…ç½® | âœ… çµæ´»é…ç½® |
| **ç»“æœæ³¨å…¥** | `<knowledge>` æ ‡ç­¾ | âœ… `format_for_prompt()` | ä¸€è‡´ |
| **Skill é…ç½®åŒ–** | æœªå®šä¹‰ | âœ… `skill_configs` è¡¨ | ğŸ†• æ–°å¢ |
| **æœ¯è¯­è‡ªåŠ¨æå–** | æœªå®šä¹‰ | âœ… LLM å…¥åº“æ—¶æå– | ğŸ†• æ–°å¢ |
| **æœ¯è¯­è¯å…¸** | æœªå®šä¹‰ | âœ… `skill_terms` è¡¨ + Jieba | ğŸ†• æ–°å¢ |

### æ•°æ®åº“è¡¨

```sql
-- Skill é…ç½®è¡¨
CREATE TABLE skill_configs (
    skill_id TEXT PRIMARY KEY,
    display_name TEXT NOT NULL,
    extract_terms BOOLEAN DEFAULT true,
    term_min_frequency INT DEFAULT 1,
    rag_top_k INT DEFAULT 5,
    rag_max_chars INT DEFAULT 4000,
    query_config JSONB DEFAULT '{}'  -- profile_fields, context_keywords
);

-- æœ¯è¯­è¡¨ (è‡ªåŠ¨æå–)
CREATE TABLE skill_terms (
    skill_id TEXT NOT NULL,
    term TEXT NOT NULL,
    frequency INT DEFAULT 1,
    source_doc_id UUID,
    extracted_by TEXT DEFAULT 'llm',
    UNIQUE(skill_id, term)
);
```

### å…³é”®ä»£ç è·¯å¾„

```
ä¸“ä¸šæœåŠ¡è°ƒç”¨ RAG:
report_service.py / greeting_service.py / letter_service.py
    â””â”€ RAGService.get_context_for_service(profile, skill_id, context_type)
        â”œâ”€ build_query()                          # é…ç½®åŒ–æŸ¥è¯¢æ„å»º
        â”‚   â””â”€ TermService.load_skill_config()    # åŠ è½½ skill é…ç½®
        â”œâ”€ get_knowledge()
        â”‚   â”œâ”€ TermService.load_terms_to_jieba()  # åŠ è½½æœ¯è¯­åˆ°åˆ†è¯å™¨
        â”‚   â””â”€ RetrievalService.search()          # å†…éƒ¨è°ƒç”¨
        â”‚       â”œâ”€ EmbeddingService.embed_query() # ç”Ÿæˆå‘é‡
        â”‚       â”œâ”€ preprocess_query()             # Jieba åˆ†è¯ (å«æœ¯è¯­)
        â”‚       â””â”€ KnowledgeRepository.hybrid_search()
        â””â”€ format_for_prompt()                    # XML æ ¼å¼åŒ–

æ™®é€šå¯¹è¯ RAG (Function Call æœºåˆ¶):
routes/chat.py
    â””â”€ LLM æ¨ç† (å¸¦ search_knowledge å·¥å…·)
        â”œâ”€ LLM åˆ¤æ–­ä¸éœ€è¦æ£€ç´¢ â†’ ç›´æ¥å›ç­”
        â””â”€ LLM è°ƒç”¨ search_knowledge
            â””â”€ RAGService.get_context_for_chat(message, profile, skill_id)
                â”œâ”€ ç»“åˆ message + profile æ„å»º query
                â””â”€ get_knowledge() + format_for_prompt()
            â””â”€ æ³¨å…¥çŸ¥è¯†åˆ° messages
            â””â”€ LLM ç»§ç»­ç”Ÿæˆå›ç­”

Agent è¿è¡Œæ—¶ RAG:
services/agent/runtime.py
    â””â”€ RAGService.get_context_for_agent(task, profile, skill_id)
        â””â”€ ç»“åˆ task + profile æ„å»º query
        â””â”€ get_knowledge() + format_for_prompt()

çŸ¥è¯†å…¥åº“æ—¶æœ¯è¯­æå–:
workers/ingestion.py
    â””â”€ _process_document()
        â””â”€ TermService.extract_terms_from_content()  # LLM æå–
            â”œâ”€ save_terms()                          # å­˜å…¥æ•°æ®åº“
            â””â”€ jieba.add_word()                      # åŠ è½½åˆ°åˆ†è¯å™¨
```

### RAGService ç»Ÿä¸€æ¥å£

```python
RAGService (å”¯ä¸€å¯¹å¤–æš´éœ²)
â”œâ”€ get_context_for_service()    # ä¸“ä¸šæœåŠ¡ (æŠ¥å‘Š/é—®å€™/ä¿¡ä»¶)
â”œâ”€ get_context_for_chat()       # æ™®é€šå¯¹è¯ (Function Call è°ƒç”¨)
â”œâ”€ get_context_for_agent()      # Agent è¿è¡Œæ—¶
â””â”€ get_search_knowledge_tool()  # Function Call å·¥å…·å®šä¹‰

å†…éƒ¨å®ç° (ä¸å¯¹å¤–æš´éœ²)
â”œâ”€ RetrievalService             # çº¯æ£€ç´¢
â”œâ”€ TermService                  # æœ¯è¯­ç®¡ç†
â””â”€ EmbeddingService             # å‘é‡ç”Ÿæˆ
```

---

# ä¸‰ã€å…¶ä»–æµç¨‹å®ç°çŠ¶æ€ç®€è¡¨

## 3.1 AI è®¿è°ˆ (interview_service.py)

| è®¾è®¡ç‚¹ | å®ç°çŠ¶æ€ |
|--------|---------|
| 3 ä¸ªæ ¸å¿ƒé—®é¢˜ | âœ… `CORE_QUESTIONS` å®šä¹‰ |
| é—®é¢˜: å½“å‰å›°å¢ƒ | âœ… `q1_concerns` |
| é—®é¢˜: ç”Ÿæ´»çŠ¶æ€ | âœ… `q2_life_status` |
| é—®é¢˜: æœŸæœ›ç›®æ ‡ | âœ… `q3_expectations` |
| ç­”æ¡ˆç»“æ„åŒ–æŠ½å– | âœ… `_extract_answer_info()` LLM æŠ½å– |
| Profile åˆå¹¶ | âœ… `_merge_extracted()` |
| ä¼šè¯æŒä¹…åŒ– | âœ… `interview_sessions` è¡¨ |
| **å¯è·³è¿‡** | âœ… `skip_session()` å…è®¸è·³è¿‡ (è®¾è®¡å†³ç­–: ç®€åŒ–ç”¨æˆ·ä½“éªŒ) |

## 3.2 æ™ºèƒ½ä¿¡æ¯é‡‡é›† (extraction_service.py)

| è®¾è®¡ç‚¹ | å®ç°çŠ¶æ€ |
|--------|---------|
| å›¾ç‰‡ OCR + Vision LLM | âœ… æ”¯æŒ |
| PDF/DOCX è§£æ | âœ… æ”¯æŒ |
| æ’ç›˜æˆªå›¾è¯†åˆ« | âœ… `content_type: bazi_screenshot` |
| èŠå¤©è®°å½•åˆ†æ | âœ… `content_type: chat_history` |
| Profile æ›´æ–°å»ºè®® | âœ… `profile_updates` å­—æ®µ |

## 3.3 Identity Prism (portrait.py)

| è®¾è®¡ç‚¹ | å®ç°çŠ¶æ€ |
|--------|---------|
| Core/Inner/Outer ä¸‰å±‚ç»“æ„ | âœ… `DEFAULT_PROFILE` åŒ…å« `identity_prism` |
| å…«å­— â†’ Core æ˜ å°„ç®—æ³• | âœ… `generate_identity_prism()` å·²å®ç° |
| æ˜Ÿåº§ â†’ Inner/Outer æ˜ å°„ | âœ… æ”¯æŒ moon_sign/rising_sign |
| AI æ´å¯Ÿ â†’ Inner æ¨æ–­ | âœ… èåˆ ai_insights |
| è‡ªç„¶è¯­è¨€ç”Ÿæˆ | âœ… LLM ç”Ÿæˆä¸‰å…ƒè§†è§’æè¿° |

**çŠ¶æ€**: âœ… å·²å®Œæˆã€‚Identity Prism åœ¨æŠ¥å‘Šç”Ÿæˆæ—¶è‡ªåŠ¨è§¦å‘ã€‚

## 3.4 å¯¹è¯æµå¼å“åº” (chat.py)

| è®¾è®¡ç‚¹ | å®ç°çŠ¶æ€ |
|--------|---------|
| SSE æµå¼å“åº” | âœ… `EventSourceResponse` |
| AI SDK æ ¼å¼ (`text-delta`) | âœ… å·²é€‚é… `{"type": "text-delta", "textDelta": "..."}` |
| Tool Calling | âœ… æ”¯æŒå·¥å…·è°ƒç”¨ |
| æ¶ˆæ¯æŒä¹…åŒ– | âœ… `save_message()` |
| Voice Mode åˆ‡æ¢ | âœ… `/chat/voice-mode` ç«¯ç‚¹ |
| ä¼šè¯åˆ—è¡¨ | âš ï¸ `/conversations` å¾…å®ç°æŸ¥è¯¢ |

**SSE æ ¼å¼** (å·²é€‚é… AI SDK 6):
```
{"type": "text-delta", "textDelta": "ä½ å¥½"}
```

## 3.5 ç”¨æˆ· Profile ç´¯ç§¯ (portrait.py + profile_repo.py)

| è®¾è®¡ç‚¹ | å®ç°çŠ¶æ€ |
|--------|---------|
| 4 å±‚ Profile ç»“æ„ | âœ… basic / life_context / ai_insights / identity_prism |
| å¯¹è¯æ´å¯ŸæŠ½å– | âœ… `maybe_update_portrait()` å·²åœ¨ chat.py ä¸­è°ƒç”¨ |
| deep_merge | âœ… å­˜åœ¨ï¼Œä½†åœ¨ portrait.py å’Œ profile_repo.py ä¸­é‡å¤ |
| ç‰ˆæœ¬åŒ–å­˜å‚¨ | âš ï¸ æœªå®ç°ç‰ˆæœ¬å¿«ç…§ |

**çŠ¶æ€**: âœ… å·²é›†æˆã€‚chat_stream() æœ«å°¾å¼‚æ­¥è§¦å‘ `maybe_update_portrait()`ã€‚

## 3.6 å…³ç³»æ¨¡æ‹Ÿå™¨ / äººç”Ÿ K çº¿

| è®¾è®¡ç‚¹ | å®ç°çŠ¶æ€ |
|--------|---------|
| å…³ç³»æ¨¡æ‹Ÿå™¨ UI | âœ… å‰ç«¯ tools å®šä¹‰ |
| åˆç›˜è®¡ç®—ç®—æ³• | âœ… `_calculate_compatibility()` å·²å®ç° |
| äººç”Ÿ K çº¿ UI | âœ… å‰ç«¯ KLinePanel ç»„ä»¶ |
| å¤§è¿æµå¹´è®¡ç®— | âœ… `/fortune/cycles` + `/fortune/annual` å·²å®ç° |
| å…«å­—æ’ç›˜ | âœ… `BaziCalculator` (lunar-python) |
| æ˜Ÿç›˜è®¡ç®— | âœ… `ZodiacCalculator` (pyswisseph) |

---

# å››ã€å·®å¼‚æ±‡æ€»ä¸ä¼˜å…ˆçº§å»ºè®®

## 4.1 å·²å®Œæˆ (åŸ P0/P1)

| é—®é¢˜ | åŸçŠ¶æ€ | å½“å‰çŠ¶æ€ |
|------|--------|---------|
| **SSE æ ¼å¼** | è‡ªå®šä¹‰ `chunk` | âœ… å·²é€‚é… AI SDK 6 `text-delta` |
| **æŠ¥å‘ŠæŒä¹…åŒ–** | æœªä¿å­˜ | âœ… `_save_to_db()` å·²å®ç° |
| **Identity Prism** | ç®—æ³•ç¼ºå¤± | âœ… `generate_identity_prism()` å®Œæ•´ |
| **Profile ç´¯ç§¯** | æœªåœ¨ chat è°ƒç”¨ | âœ… `maybe_update_portrait()` å·²é›†æˆ |
| **æ˜Ÿç›˜/å…«å­—è®¡ç®—** | å­˜æ ¹ | âœ… pyswisseph + lunar-python çœŸå®è®¡ç®— |
| **è®¿è°ˆå¯è·³è¿‡** | ä¸è®¾è®¡ä¸ç¬¦ | âœ… è®¾è®¡å†³ç­–å˜æ›´: ç®€åŒ–ç”¨æˆ·ä½“éªŒ |

## 4.2 å¾…å®Œæˆ (P1)

| é—®é¢˜ | è®¾è®¡ | å®ç° | å½±å“ | ä¿®å¤å»ºè®® |
|------|------|------|------|---------|
| **ä¼šè¯åˆ—è¡¨** | è¿”å›å†å²ä¼šè¯ | è¿”å›ç©ºæ•°ç»„ | ç”¨æˆ·æ— æ³•æŸ¥çœ‹å†å² | å®ç° conversation_repo æŸ¥è¯¢ |

## 4.3 å¯ä¼˜åŒ– (P2)

| é—®é¢˜ | è®¾è®¡ | å®ç° | å½±å“ | ä¿®å¤å»ºè®® |
|------|------|------|------|---------|
| **è¯é¢˜åˆ†ç±»ç²¾åº¦** | LLM + å…³é”®è¯ | ä»…å…³é”®è¯ | åˆ†ç±»ä¸å‡† | å¯é€‰: æ·»åŠ  LLM å›è½ |
| **Profile ç‰ˆæœ¬åŒ–** | ä¿ç•™ 10 ä¸ªç‰ˆæœ¬ | æ— ç‰ˆæœ¬å¿«ç…§ | æ— æ³•å›æº¯ | æ·»åŠ  profile_versions è¡¨ |
| **deep_merge é‡å¤** | ç»Ÿä¸€å‡½æ•° | portrait.py + profile_repo.py å„ä¸€ä»½ | ç»´æŠ¤é—®é¢˜ | æå–åˆ° utils |

---

# äº”ã€åç»­ Review ä»»åŠ¡æ¸…å•

æœ¬æ¬¡å®Œæˆäº† **æ¶æ„çº§å¯¹æ¯”** å’Œ **æ ¸å¿ƒæµç¨‹çš„ä»£ç çº§åˆ†æ**ã€‚

## å·²å®Œæˆ âœ…

- [x] **Identity Prism ç®—æ³•è®¾è®¡**: `generate_identity_prism()` å·²å®ç°
- [x] **SSE æ ¼å¼é€‚é…**: å·²ä¿®æ”¹ä¸º AI SDK 6 `text-delta` æ ¼å¼
- [x] **æŠ¥å‘ŠæŒä¹…åŒ–å®Œå–„**: `_save_to_db()` å·²å®ç°
- [x] **äººç”Ÿ K çº¿åç«¯è®¡ç®—**: `/fortune/cycles` + `/fortune/kline` å·²å®ç°
- [x] **å…³ç³»æ¨¡æ‹Ÿå™¨åˆç›˜ç®—æ³•**: `_calculate_compatibility()` å·²å®ç°
- [x] **æ˜Ÿç›˜/å…«å­—è®¡ç®—**: pyswisseph + lunar-python çœŸå®è®¡ç®—

## å¾…å®Œæˆ

- [ ] **ä¼šè¯åˆ—è¡¨æŸ¥è¯¢**: å®ç° `/conversations` è¿”å›å†å²ä¼šè¯
- [ ] **å‰ç«¯é›†æˆéªŒè¯**: éªŒè¯ useVibeChat ä¸åç«¯ SSE å…¼å®¹æ€§

---

# å…­ã€ç”¨æˆ·æµç¨‹ï¼šä»ä¸»é¡µé¢åˆ°å­ç«™ Chat

## 6.1 è®¾è®¡è§„æ ¼ (Spec 2.2.1 + æ¶æ„å†³ç­–)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®¾è®¡ä¸­çš„ç”¨æˆ·è½¬åŒ–æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â”‚   æ¸¸å®¢ â”€â”€â†’ å¯¹è¯ + AI è®¿è°ˆ â”€â”€â†’ ç®€ç‰ˆæŠ¥å‘Šï¼ˆå…è´¹ï¼‰                     â”‚  â”‚
â”‚   â”‚                                     â”‚                               â”‚  â”‚
â”‚   â”‚                                     â–¼                               â”‚  â”‚
â”‚   â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚  â”‚
â”‚   â”‚                         â”‚  ğŸ’ è§£é”å®Œæ•´æŠ¥å‘Š      â”‚                   â”‚  â”‚
â”‚   â”‚                         â”‚    ä»…éœ€ Â¥19.9        â”‚                   â”‚  â”‚
â”‚   â”‚                         â”‚  [æ³¨å†Œå¹¶è´­ä¹°]         â”‚                   â”‚  â”‚
â”‚   â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚  â”‚
â”‚   â”‚                                     â”‚                               â”‚  â”‚
â”‚   â”‚                                     â–¼                               â”‚  â”‚
â”‚   â”‚                            æ³¨å†Œ + ä»˜è´¹                              â”‚  â”‚
â”‚   â”‚                                     â”‚                               â”‚  â”‚
â”‚   â”‚                                     â–¼                               â”‚  â”‚
â”‚   â”‚                         å®Œæ•´æŠ¥å‘Š + é«˜æ¸…æµ·æŠ¥                         â”‚  â”‚
â”‚   â”‚                                                                     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                            â”‚
â”‚   è®¾è®¡è¦ç‚¹:                                                                 â”‚
â”‚   1. å­åŸŸåæ¶æ„: bazi.vibelife.app / zodiac.vibelife.app                  â”‚
â”‚   2. é¦–é¡µå¿…é¡»å±•ç¤º Daily Greeting (P0+ åŠŸèƒ½)                                â”‚
â”‚   3. Skill é€‰æ‹©åé”å®šï¼Œåç»­æµç¨‹ä¿æŒä¸€è‡´                                    â”‚
â”‚   4. AI è®¿è°ˆå¯é€‰è·³è¿‡ (ç®€åŒ–ç”¨æˆ·ä½“éªŒ)                                        â”‚
â”‚   5. å¯¹è¯ä¸­ä½¿ç”¨ Tool Calling è§¦å‘ UI å±•ç¤º                                  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 6.2 å®é™…å®ç°æµç¨‹

### 6.2.1 å‰ç«¯è·¯ç”±æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å®é™…å®ç°çš„è·¯ç”±ç»“æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  vibelife.app (å“ç‰Œé¦–é¡µ)                                                   â”‚
â”‚  â”‚                                                                         â”‚
â”‚  â”œâ”€ / (app/page.tsx)                                                       â”‚
â”‚  â”‚  â””â”€ æ£€æµ‹å­åŸŸå â†’ æœ‰åˆ™é‡å®šå‘åˆ° /{skill}                                 â”‚
â”‚  â”‚  â””â”€ æ— å­åŸŸå â†’ æ˜¾ç¤º 5 ä¸ª Skill å¡ç‰‡é€‰æ‹©å™¨                              â”‚
â”‚  â”‚                                                                         â”‚
â”‚  â”œâ”€ /bazi (å…«å­—è·¯ç”±ç»„)                                                     â”‚
â”‚  â”‚  â”œâ”€ /bazi (app/bazi/page.tsx) â”€â”€â”€ Landing Page                         â”‚
â”‚  â”‚  â”œâ”€ /bazi/chat (app/bazi/chat/page.tsx) â”€â”€â”€ å¯¹è¯é¡µé¢ â˜…                 â”‚
â”‚  â”‚  â”œâ”€ /bazi/report â”€â”€â”€ æŠ¥å‘Šç”Ÿæˆ                                          â”‚
â”‚  â”‚  â”œâ”€ /bazi/relationship â”€â”€â”€ å…³ç³»åˆ†æ                                    â”‚
â”‚  â”‚  â””â”€ /bazi/kline â”€â”€â”€ Kçº¿å›¾è¡¨                                            â”‚
â”‚  â”‚                                                                         â”‚
â”‚  â”œâ”€ /zodiac (æ˜Ÿåº§è·¯ç”±ç»„) â”€â”€â”€ ç»“æ„åŒä¸Š                                      â”‚
â”‚  â”‚                                                                         â”‚
â”‚  â””â”€ middleware.ts                                                          â”‚
â”‚     â””â”€ å­åŸŸåæ£€æµ‹ + URL é‡å†™                                               â”‚
â”‚     â””â”€ bazi.vibelife.app/chat â†’ /bazi/chat                                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2.2 å®é™…ç”¨æˆ·æµç¨‹

```
Step 1: è®¿é—®é¦–é¡µ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·è®¿é—®: vibelife.app æˆ– bazi.vibelife.app

middleware.ts:
â”œâ”€ æ£€æµ‹ hostname ä¸­çš„å­åŸŸå
â”œâ”€ è®¾ç½® header: x-vibelife-skill
â””â”€ è®¾ç½® cookie: vibelife-skill (1å¹´æœ‰æ•ˆæœŸ)

page.tsx (é¦–é¡µ):
â”œâ”€ æ£€æµ‹ window.location.hostname
â”œâ”€ æœ‰å­åŸŸå â†’ router.replace(`/${skill}`)
â””â”€ æ— å­åŸŸå â†’ æ˜¾ç¤º Skill é€‰æ‹©å¡ç‰‡
   â”œâ”€ å…«å­—å‘½ç† (available: true)
   â”œâ”€ æ˜Ÿåº§å æ˜Ÿ (available: true)
   â”œâ”€ MBTI äººæ ¼ (available: false, "å³å°†æ¨å‡º")
   â”œâ”€ ä¾æ‹æ¨¡å¼ (available: false)
   â””â”€ èŒä¸šå‘å±• (available: false)


Step 2: é€‰æ‹© Skill
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·ç‚¹å‡» "å…«å­—å‘½ç†" å¡ç‰‡

handleSkillClick():
â”œâ”€ è®¾ç½® cookie: vibelife-skill=bazi
â””â”€ router.push("/bazi")


Step 3: Skill Landing Page
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åŠ è½½: /bazi/page.tsx

BaziLayout (layout.tsx):
â”œâ”€ useEffect: setSkill("bazi")
â””â”€ å¼ºåˆ¶é”å®š skill ä¸Šä¸‹æ–‡

é¡µé¢å†…å®¹:
â”œâ”€ æ ‡é¢˜: "å…«å­—å‘½ç†"
â”œâ”€ å‰¯æ ‡é¢˜: "è§£è¯»å¤©èµ‹ï¼Œæ´å¯Ÿäººç”Ÿ"
â””â”€ æŒ‰é’®: "å¼€å§‹å¯¹è¯" â†’ /bazi/chat


Step 4: è¿›å…¥å¯¹è¯é¡µé¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åŠ è½½: /bazi/chat/page.tsx

ä¸‰æ å¸ƒå±€ (AppShell):
â”œâ”€ å·¦æ : NavBar (64px)
â”‚  â”œâ”€ chat (å¯¹è¯)
â”‚  â”œâ”€ chart (å›¾è¡¨)
â”‚  â”œâ”€ journey (æ—…ç¨‹)
â”‚  â””â”€ me (ä¸ªäºº)
â”‚
â”œâ”€ ä¸­æ : ChatContainer (flex-1)
â”‚  â”œâ”€ skillId="bazi"
â”‚  â”œâ”€ skill="bazi"
â”‚  â””â”€ voiceMode={voiceMode}
â”‚
â””â”€ å³æ : ResizablePanel (320-600px)
   â””â”€ æ ¹æ® activeTab åˆ‡æ¢:
      â”œâ”€ ChatPanel
      â”œâ”€ ChartPanel
      â”œâ”€ JourneyPanel
      â””â”€ MePanel


Step 5: åˆå§‹åŒ– Chat (ç©ºçŠ¶æ€)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
useVibeChat åˆå§‹åŒ–:
â”œâ”€ åˆ›å»º DefaultChatTransport
â”‚  â”œâ”€ api: "/api/chat"
â”‚  â”œâ”€ body: { skill: "bazi", voice_mode: "warm" }
â”‚  â””â”€ headers: { Authorization: Bearer {token} }
â””â”€ AI SDK useChat hook

ç©ºçŠ¶æ€ UI:
â”œâ”€ DailyGreeting (é—®å€™å¡) â˜… å¾…ç¡®è®¤æ˜¯å¦çœŸæ­£å®ç°
â”œâ”€ VibeGlyph + BreathAura (è§†è§‰æ•ˆæœ)
â””â”€ QuickPrompts (4ä¸ªå¿«é€Ÿé—®é¢˜)
   â”œâ”€ "å¸®æˆ‘è§£è¯»ä¸€ä¸‹æˆ‘çš„å‘½ç›˜"
   â”œâ”€ "æœ€è¿‘è¿åŠ¿æ€ä¹ˆæ ·"
   â”œâ”€ "æˆ‘é€‚åˆä»€ä¹ˆå·¥ä½œ"
   â””â”€ "æˆ‘çš„æ„Ÿæƒ…è¿å¦‚ä½•"


Step 6: å‘é€æ¶ˆæ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·è¾“å…¥: "æˆ‘æ˜¯1990å¹´5æœˆ15æ—¥æ—©ä¸Š8ç‚¹å‡ºç”Ÿ"

ChatInput.onSend() â†’ sendMessage()

è¯·æ±‚é“¾è·¯:
POST /api/chat (Next.js API Route)
  â†“ body: {
  â†“   messages: [...],
  â†“   skill: "bazi",
  â†“   voice_mode: "warm",
  â†“   conversation_id: undefined
  â†“ }
  â†“
Next.js route.ts:
  â”œâ”€ æå– skill, voice_mode, conversation_id
  â”œâ”€ æ„å»º chatRequest
  â””â”€ è½¬å‘åˆ° Python åç«¯
     â†“
POST /api/v1/chat/stream (Python FastAPI)
  â”œâ”€ åˆ›å»ºæ–°å¯¹è¯ï¼Œç”Ÿæˆ conversation_id
  â”œâ”€ RAG æ£€ç´¢çŸ¥è¯†åº“
  â”œâ”€ Context æ„å»º
  â”œâ”€ LLM è°ƒç”¨ (æµå¼)
  â””â”€ è¿”å› SSE äº‹ä»¶æµ


Step 7: SSE äº‹ä»¶æµè½¬æ¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Python åç«¯ SSE æ ¼å¼:
â”œâ”€ {"type": "chunk", "content": "æ ¹æ®"}
â”œâ”€ {"type": "chunk", "content": "æ‚¨çš„å…«å­—..."}
â”œâ”€ {"type": "tool_call", "tool_name": "show_bazi_chart", ...}
â””â”€ {"type": "done", "conversation_id": "uuid-xxx"}

Next.js route.ts è½¬æ¢ä¸º AI SDK 6 æ ¼å¼:
â”œâ”€ {"type": "text-delta", "id": "xxx", "delta": "æ ¹æ®"}
â”œâ”€ {"type": "tool-input-available", "toolCallId": "xxx", ...}
â”œâ”€ {"type": "tool-output-available", ...} â† æ‰§è¡Œå·¥å…·å¹¶è¿”å›ç»“æœ
â””â”€ {"type": "finish", "messageMetadata": {conversation_id: "uuid-xxx"}}

å‰ç«¯å¤„ç†:
â”œâ”€ AI SDK useChat è§£æ UIMessageStream
â”œâ”€ æ¸²æŸ“ ChatMessage ç»„ä»¶
â””â”€ å·¥å…·è°ƒç”¨ â†’ æ¸²æŸ“å¯¹åº” UI ç»„ä»¶ (å›¾è¡¨/å¡ç‰‡ç­‰)


Step 8: å·¥å…·è°ƒç”¨å¤„ç† (Generative UI)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åç«¯è¿”å› tool_call: show_bazi_chart

Next.js route.ts:
â”œâ”€ è¯†åˆ«å·¥å…·ç±»å‹
â”œâ”€ è°ƒç”¨ executeToolCall()
â”‚  â”œâ”€ show_bazi_chart: è¿”å›æ¼”ç¤ºæ•°æ® (ç¡¬ç¼–ç )
â”‚  â”œâ”€ show_bazi_fortune: è°ƒç”¨ /fortune/cycles + /fortune/annual
â”‚  â”œâ”€ show_bazi_kline: è°ƒç”¨ /fortune/kline
â”‚  â”œâ”€ show_report: è·å–æˆ–ç”Ÿæˆæ¼”ç¤ºæŠ¥å‘Š
â”‚  â””â”€ show_relationship: è°ƒç”¨ /relationship/analyze
â””â”€ è¿”å› tool-output-available äº‹ä»¶

å‰ç«¯æ¸²æŸ“:
â”œâ”€ æ ¹æ® tool_name é€‰æ‹©ç»„ä»¶
â”‚  â”œâ”€ show_bazi_chart â†’ BaziChartCard
â”‚  â”œâ”€ show_bazi_fortune â†’ FortunePanel
â”‚  â”œâ”€ show_bazi_kline â†’ KLineChart
â”‚  â””â”€ ...
â””â”€ åµŒå…¥å¯¹è¯æµä¸­æ˜¾ç¤º
```

## 6.3 è®¾è®¡ vs å®ç°å·®å¼‚åˆ†æ

### 6.3.1 è·¯ç”±æ¶æ„å·®å¼‚

| è®¾è®¡ç‚¹ | è®¾è®¡è§„æ ¼ | å®é™…å®ç° | å·®å¼‚ |
|--------|---------|---------|------|
| **å­åŸŸåè·¯ç”±** | bazi.vibelife.app â†’ /bazi | âœ… middleware.ts URL é‡å†™ | ä¸€è‡´ |
| **Skill é”å®š** | é€‰æ‹©åé”å®šï¼Œä¿æŒä¸€è‡´ | âœ… Layout + Cookie + Header | ä¸€è‡´ |
| **æœ¬åœ°å¼€å‘** | localhost æ”¯æŒè·¯å¾„å‰ç¼€ | âœ… localhost:3000/bazi | ä¸€è‡´ |
| **MBTI/ä¾æ‹/èŒä¸š** | Phase 1 å»¶å | âœ… `available: false` æ ‡è®° | ä¸€è‡´ |

### 6.3.2 é¦–é¡µä¸ Daily Greeting å·®å¼‚

| è®¾è®¡ç‚¹ | è®¾è®¡è§„æ ¼ | å®é™…å®ç° | å·®å¼‚ |
|--------|---------|---------|------|
| **Daily Greeting** | P0+ å¿…é¡»å±•ç¤ºï¼Œå¼ºåˆ¶å±•ç¤º | âš ï¸ ChatContainer æœ‰ DailyGreeting ç»„ä»¶å ä½ | éœ€ç¡®è®¤æ˜¯å¦è°ƒç”¨åç«¯ API |
| **Greeting å†…å®¹** | èŠ‚æ°”/å¤©è±¡/è¿åŠ¿ç›¸å…³ | âš ï¸ å¯èƒ½æ˜¯é™æ€å†…å®¹ | éœ€ç¡®è®¤åŠ¨æ€ç”Ÿæˆ |
| **"ä¸»åŠ¨å…³å¿ƒ"** | Phase 1 æ›¿ä»£ Push | âš ï¸ ä»…å±•ç¤ºï¼Œæœªè§ä¸ªæ€§åŒ–é€»è¾‘ | å¯èƒ½æœªå®ç°ä¸ªæ€§åŒ– |

### 6.3.3 å¯¹è¯æµç¨‹å·®å¼‚

| è®¾è®¡ç‚¹ | è®¾è®¡è§„æ ¼ | å®é™…å®ç° | å·®å¼‚ |
|--------|---------|---------|------|
| **SSE æ ¼å¼** | AI SDK 6 UIMessageStream | âœ… Next.js route.ts åšäº†è½¬æ¢ | âœ… å·²é€‚é… |
| **åç«¯ SSE** | `{"type": "chunk"}` | âœ… Python chat.py è¿”å› | ä¸€è‡´ |
| **Tool Calling** | å·¥å…·è°ƒç”¨è§¦å‘ UI | âœ… æ”¯æŒ 11 ç§å·¥å…· | ä¸€è‡´ |
| **å·¥å…·æ‰§è¡Œä½ç½®** | åç«¯æ‰§è¡Œ | âš ï¸ Next.js è¾¹ç¼˜æ‰§è¡Œ (éƒ¨åˆ†ç¡¬ç¼–ç ) | éœ€é‡æ„åˆ°åç«¯ |
| **conversation_id** | åç«¯ç”Ÿæˆï¼Œå‰ç«¯ä¿å­˜ | âœ… é€šè¿‡ messageMetadata è¿”å› | ä¸€è‡´ |

### 6.3.4 å·¥å…·è°ƒç”¨å·®å¼‚

| å·¥å…·åç§° | è®¾è®¡ | å®é™…å®ç° | å·®å¼‚ |
|---------|------|---------|------|
| `show_bazi_chart` | åç«¯è®¡ç®—å‘½ç›˜ | âŒ ç¡¬ç¼–ç æ¼”ç¤ºæ•°æ® | æœªæ¥çœŸå®è®¡ç®— |
| `show_bazi_fortune` | åç«¯è®¡ç®—è¿åŠ¿ | âœ… è°ƒç”¨ /fortune API | ä¸€è‡´ |
| `show_bazi_kline` | åç«¯è®¡ç®—Kçº¿ | âœ… è°ƒç”¨ /fortune/kline API | ä¸€è‡´ |
| `show_zodiac_chart` | åç«¯è®¡ç®—æ˜Ÿç›˜ | âŒ ç¡¬ç¼–ç æ¼”ç¤ºæ•°æ® | æœªæ¥çœŸå®è®¡ç®— |
| `show_report` | åç«¯è·å–æŠ¥å‘Š | âš ï¸ å°è¯•è°ƒç”¨ APIï¼Œå¤±è´¥è¿”å›æ¼”ç¤º | å›è½æ¼”ç¤ºæ•°æ® |
| `show_relationship` | åç«¯è®¡ç®—å…³ç³» | âœ… è°ƒç”¨ /relationship/analyze | ä¸€è‡´ |
| `request_info` | è§¦å‘ä¿¡æ¯é‡‡é›† | âœ… è¿”å›è¡¨å•å­—æ®µå®šä¹‰ | ä¸€è‡´ |
| `show_insight` | å±•ç¤ºæ´å¯Ÿå¡ç‰‡ | âŒ ç¡¬ç¼–ç æ¼”ç¤ºæ•°æ® | æœªå®ç°åŠ¨æ€ç”Ÿæˆ |

### 6.3.5 å…³é”®å·®å¼‚æ±‡æ€»

| é—®é¢˜ | è®¾è®¡ | å®ç° | ä¼˜å…ˆçº§ | ä¿®å¤å»ºè®® |
|------|------|------|--------|---------|
| **Daily Greeting æœªä¸ªæ€§åŒ–** | åŸºäºè¿åŠ¿/èŠ‚æ°”åŠ¨æ€ç”Ÿæˆ | å¯èƒ½æ˜¯é™æ€å ä½ | P1 | è°ƒç”¨åç«¯ /fortune/greeting API |
| **show_bazi_chart ç¡¬ç¼–ç ** | åç«¯çœŸå®è®¡ç®— | æ¼”ç¤ºæ•°æ® | P1 | å¯¹æ¥æ’ç›˜æœåŠ¡ |
| **show_zodiac_chart ç¡¬ç¼–ç ** | åç«¯çœŸå®è®¡ç®— | æ¼”ç¤ºæ•°æ® | P1 | å¯¹æ¥æ˜Ÿç›˜æœåŠ¡ |
| **show_insight ç¡¬ç¼–ç ** | AI åŠ¨æ€ç”Ÿæˆ | é™æ€æ¼”ç¤º | P2 | è°ƒç”¨åç«¯æ´å¯Ÿç”Ÿæˆ |
| **å·¥å…·æ‰§è¡Œåœ¨ Edge** | åç«¯æ‰§è¡Œ | Next.js è¾¹ç¼˜æ‰§è¡Œ | P2 | å¯è€ƒè™‘ä¿æŒï¼Œä½†éœ€ç›‘æ§æ€§èƒ½ |

## 6.4 å…³é”®ä»£ç è·¯å¾„

```
ç”¨æˆ·è®¿é—®é¦–é¡µ
â”œâ”€ middleware.ts:47 â”€â”€â”€ å­åŸŸåæ£€æµ‹ + URL é‡å†™
â”œâ”€ app/page.tsx:82 â”€â”€â”€ é¦–é¡µç»„ä»¶ï¼ŒSkill é€‰æ‹©
â”‚
ç”¨æˆ·é€‰æ‹© Skill
â”œâ”€ app/page.tsx:109 â”€â”€â”€ handleSkillClick()
â”œâ”€ app/bazi/page.tsx â”€â”€â”€ Landing Page
â”‚
è¿›å…¥å¯¹è¯é¡µé¢
â”œâ”€ app/bazi/chat/page.tsx:83 â”€â”€â”€ BaziChatPage
â”œâ”€ components/layout/AppShell.tsx â”€â”€â”€ ä¸‰æ å¸ƒå±€
â”œâ”€ components/chat/ChatContainer.tsx â”€â”€â”€ å¯¹è¯å®¹å™¨
â”‚
å‘é€æ¶ˆæ¯
â”œâ”€ hooks/useVibeChat.ts â”€â”€â”€ AI SDK åŒ…è£…
â”œâ”€ app/api/chat/route.ts:363 â”€â”€â”€ POST handler
â”‚  â”œâ”€ L387: fetch Python åç«¯ /chat/stream
â”‚  â”œâ”€ L411: åˆ›å»º UIMessageStream
â”‚  â”œâ”€ L449: å¤„ç† chunk â†’ text-delta
â”‚  â”œâ”€ L455: å¤„ç† tool_call â†’ tool-input-available
â”‚  â””â”€ L473: executeToolCall() æ‰§è¡Œå·¥å…·
â”‚
åç«¯å¤„ç†
â”œâ”€ routes/chat.py:150 â”€â”€â”€ chat_stream()
â”œâ”€ services/vibe_engine/context.py â”€â”€â”€ Context æ„å»º
â”œâ”€ services/knowledge/retrieval.py â”€â”€â”€ RAG æ£€ç´¢
â””â”€ services/vibe_engine/llm.py â”€â”€â”€ LLM è°ƒç”¨
```

## 6.5 å‰ç«¯å…³é”®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | åŠŸèƒ½ | è¡Œæ•° |
|------|------|------|
| `middleware.ts` | å­åŸŸåè·¯ç”± + Skill æ£€æµ‹ | 143 |
| `app/page.tsx` | å“ç‰Œé¦–é¡µ + Skill é€‰æ‹©å™¨ | 247 |
| `app/bazi/page.tsx` | å…«å­— Landing Page | ~100 |
| `app/bazi/chat/page.tsx` | å…«å­—å¯¹è¯é¡µé¢ | 90 |
| `app/bazi/layout.tsx` | å…«å­—è·¯ç”±å¸ƒå±€ (Skill é”å®š) | ~30 |
| `app/api/chat/route.ts` | Chat API ä»£ç† + SSE è½¬æ¢ | 569 |
| `components/chat/ChatContainer.tsx` | å¯¹è¯ä¸»å®¹å™¨ | ~300 |
| `hooks/useVibeChat.ts` | AI SDK 6 å°è£… | ~150 |
| `providers/SkillProvider.tsx` | Skill ä¸Šä¸‹æ–‡ç®¡ç† | ~100 |

---

# ä¸ƒã€æ·±åº¦æŠ¥å‘Šç”Ÿæˆ - ä¿®å¤æ–¹æ¡ˆè®¾è®¡

> **å†³ç­–æ—¥æœŸ**: 2026-01-09
> **æ–¹æ¡ˆé€‰æ‹©**: A+ æŠ˜ä¸­æ–¹æ¡ˆ (æœ€å°ä¿®å¤ + Gemini Imagen çœŸå® AI ç”Ÿå›¾)

## 7.1 ä¿®å¤èŒƒå›´

| ä¿®å¤é¡¹ | åŸçŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | å®ç°æ–¹å¼ |
|--------|--------|---------|---------|
| æŠ¥å‘ŠæŒä¹…åŒ– | âŒ æœªä¿å­˜ | âœ… ä¿å­˜åˆ° DB | `generate_report()` æœ«å°¾è°ƒç”¨ `report_repo.create_report()` |
| è®¿è°ˆå¼ºåˆ¶æ€§ | âŒ å¯è·³è¿‡æ— è­¦å‘Š | âš ï¸ å¯è·³è¿‡+è­¦å‘Š | ä¿ç•™ skipï¼Œæ·»åŠ  `skipped_warning` å­—æ®µ |
| å‡çº§æµç¨‹ | âŒ NotImplementedError | âœ… çŠ¶æ€æ›´æ–° | `report_repo.update_report_status(is_paid=True)` |
| AI ç”Ÿå›¾ | âŒ Placeholder | âœ… Gemini Imagen 3 | é›†æˆ Google Generative AI SDK |

## 7.2 AI ç”Ÿå›¾é›†æˆè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Gemini Imagen 3 é›†æˆæ–¹æ¡ˆ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ç¯å¢ƒå˜é‡:                                                                  â”‚
â”‚  â”œâ”€ GOOGLE_API_KEY: Gemini API Key                                         â”‚
â”‚  â””â”€ IMAGE_STORAGE_BUCKET: GCS/R2/S3 å­˜å‚¨æ¡¶                                 â”‚
â”‚                                                                            â”‚
â”‚  è°ƒç”¨æµç¨‹:                                                                  â”‚
â”‚  1. æ ¹æ® profile + skill æ„å»º prompt                                       â”‚
â”‚  2. è°ƒç”¨ Gemini Imagen 3 API ç”Ÿæˆå›¾ç‰‡                                      â”‚
â”‚  3. ä¸Šä¼ åˆ°äº‘å­˜å‚¨è·å– URL                                                    â”‚
â”‚  4. ç”Ÿæˆç¼©ç•¥å›¾ (åŠ /ä¸åŠ æ°´å°)                                                â”‚
â”‚  5. è¿”å› url + thumbnail_url                                               â”‚
â”‚                                                                            â”‚
â”‚  é™çº§ç­–ç•¥:                                                                  â”‚
â”‚  â”œâ”€ API å¤±è´¥ â†’ ä½¿ç”¨é™æ€å ä½å›¾                                              â”‚
â”‚  â””â”€ è¶…æ—¶ â†’ å¼‚æ­¥ç”Ÿæˆï¼ŒæŠ¥å‘Šå…ˆè¿”å›                                            â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7.3 æ•°æ®æµå˜æ›´

```
ä¿®å¤å‰:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReportService.generate_report()
â”œâ”€ PrologueGenerator.generate()
â”œâ”€ _generate_section() Ã— 4
â”œâ”€ ImageGenerator.generate_poster() â†’ placeholder
â””â”€ return Report  â† ç›´æ¥è¿”å›ï¼ŒæœªæŒä¹…åŒ–

ä¿®å¤å:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReportService.generate_report()
â”œâ”€ PrologueGenerator.generate()
â”œâ”€ _generate_section() Ã— 4
â”œâ”€ ImageGenerator.generate_poster() â†’ Gemini Imagen 3
â”œâ”€ report_repo.create_report()  â† æ–°å¢: æŒä¹…åŒ–åˆ° DB
â””â”€ return Report

å‡çº§æµç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReportService.upgrade_report(report_id, user_id)
â”œâ”€ report_repo.get_report(report_id)
â”œâ”€ éªŒè¯ user_id åŒ¹é…
â”œâ”€ report_repo.update_report_status(is_paid=True, report_type="full")
â””â”€ å¦‚éœ€è¦: è¡¥å……ç”Ÿæˆ premium ç« èŠ‚ + AI æµ·æŠ¥
```

## 7.4 å…³é”®ä»£ç ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `report_service.py` | æ·»åŠ  `_save_to_db()`, ä¿®æ”¹ `generate_report()`, å®ç° `upgrade_report()` |
| `image_generator.py` | é›†æˆ LLMService.generate_image() (Gemini), æ·»åŠ äº‘å­˜å‚¨ä¸Šä¼  |
| `interview_service.py` | `skip_session()` æ·»åŠ  `skipped_warning` æ ‡è®° |

---

# å…«ã€Identity Prism - ä¿®å¤æ–¹æ¡ˆè®¾è®¡

> **å†³ç­–æ—¥æœŸ**: 2026-01-09
> **æ–¹æ¡ˆ**: è·¨ Skill ç»Ÿä¸€ï¼ŒæŠ¥å‘Šç”Ÿæˆæ—¶è§¦å‘

## 8.1 Identity Prism è®¾è®¡å“²å­¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Identity Prism ä¸‰å…ƒæ¡†æ¶                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   Core (æ ¸å¿ƒ)    â”‚ â”‚   Inner (å†…åœ¨)   â”‚ â”‚   Outer (å¤–åœ¨)   â”‚          â”‚
â”‚   â”‚  "æˆ‘æœ¬è¯¥æ˜¯è°"    â”‚ â”‚  "æˆ‘å¦‚ä½•çœ‹è‡ªå·±"  â”‚ â”‚  "æˆ‘å±•ç¤ºä»€ä¹ˆ"    â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚                    â”‚                    â”‚                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚ å…«å­—æ—¥ä¸»æœ¬æ€§     â”‚ â”‚ æœˆäº®æ˜Ÿåº§         â”‚ â”‚ ä¸Šå‡æ˜Ÿåº§         â”‚          â”‚
â”‚   â”‚ æ ¼å±€ + ç”¨ç¥      â”‚ â”‚ AI æ´å¯Ÿ (å¯¹è¯)   â”‚ â”‚ å…«å­—åç¥ç»“æ„     â”‚          â”‚
â”‚   â”‚ (Bazi Skill)     â”‚ â”‚ (è·¨ Skill ç§¯ç´¯)  â”‚ â”‚ (Bazi + Zodiac)  â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                            â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                            â”‚
â”‚   è®¾è®¡åŸåˆ™:                                                                 â”‚
â”‚   - ä¸€ä¸ªç”¨æˆ· â†’ ä¸€ä¸ª Identity Prism (è·¨ Skill ç»Ÿä¸€)                         â”‚
â”‚   - éšç€ç”¨æˆ·ä½¿ç”¨æ›´å¤š Skillï¼ŒPrism è¶Šæ¥è¶Šç²¾å‡†                               â”‚
â”‚   - Core æ›´ç¨³å®šï¼ŒInner/Outer å¯éšå¯¹è¯æ¼”åŒ–                                  â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 8.2 è§¦å‘æ—¶æœºä¸æ•°æ®æµ

```
æŠ¥å‘Šç”Ÿæˆæµç¨‹:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ReportService.generate_report()
    â”‚
    â”œâ”€ Step 1: æ£€æŸ¥ Profile ä¸­æ˜¯å¦æœ‰ identity_prism
    â”‚   â””â”€ å¦‚æœæ— æˆ–æ•°æ®æºä¸è¶³ â†’ è°ƒç”¨ generate_identity_prism()
    â”‚
    â”œâ”€ Step 2: æ”¶é›†æ•°æ®æº
    â”‚   â”œâ”€ bazi_chart: ä» Profile.basic æˆ–è°ƒç”¨æ’ç›˜æœåŠ¡è·å–
    â”‚   â”œâ”€ zodiac_chart: ä» Profile.basic è·å–æœˆäº®/ä¸Šå‡æ˜Ÿåº§
    â”‚   â””â”€ ai_insights: Profile.ai_insights
    â”‚
    â”œâ”€ Step 3: è°ƒç”¨ PortraitService.generate_identity_prism()
    â”‚   â””â”€ è¾“å…¥: profile + bazi_chart + zodiac_chart
    â”‚
    â”œâ”€ Step 4: ä¿å­˜åˆ° Profile
    â”‚   â””â”€ profile_repo.update_section(user_id, "identity_prism", prism)
    â”‚
    â””â”€ Step 5: ä½¿ç”¨ Prism ç”Ÿæˆå·é¦–è¯­å’ŒæŠ¥å‘Šå†…å®¹
```

## 8.3 Prompt æ¨¡æ¿æ›´æ–°

```python
IDENTITY_PRISM_PROMPT = """ä½ æ˜¯å¿ƒç†å­¦å’Œå‘½ç†å­¦ä¸“å®¶ã€‚è¯·åŸºäºç”¨æˆ·çš„å¤šç»´åº¦æ•°æ®ï¼Œç”Ÿæˆ Identity Prism ä¸‰å…ƒèº«ä»½è§†è§’ã€‚

## æ•°æ®æº

### å…«å­—ä¿¡æ¯
{bazi_info}

### æ˜Ÿåº§ä¿¡æ¯
{zodiac_info}

### AI æ´å¯Ÿ (å¯¹è¯åˆ†æ)
{ai_insights}

## Identity Prism ä¸‰å…ƒæ¡†æ¶

**Core (æ ¸å¿ƒ)**ï¼šå…ˆå¤©æ½œèƒ½ä¸æœ¬æ€§
- ä¸»è¦æ¥æºï¼šå…«å­—æ—¥ä¸» + æ ¼å±€ + ç”¨ç¥
- è¾…åŠ©æ¥æºï¼šå¤ªé˜³æ˜Ÿåº§
- é—®é¢˜ï¼šã€Œæˆ‘æœ¬è¯¥æ˜¯è°ï¼Ÿã€

**Inner (å†…åœ¨)**ï¼šå†…å¿ƒä¸–ç•Œä¸æƒ…æ„Ÿæ¨¡å¼
- ä¸»è¦æ¥æºï¼šæœˆäº®æ˜Ÿåº§
- è¾…åŠ©æ¥æºï¼šAIæ´å¯Ÿ + ç”¨æˆ·è‡ªè¿°
- é—®é¢˜ï¼šã€Œæˆ‘å¦‚ä½•çœ‹è‡ªå·±ï¼Ÿã€

**Outer (å¤–åœ¨)**ï¼šç¤¾ä¼šé¢å…·ä¸å¤–åœ¨è¡¨ç°
- ä¸»è¦æ¥æºï¼šä¸Šå‡æ˜Ÿåº§
- è¾…åŠ©æ¥æºï¼šå…«å­—åç¥ç»“æ„
- é—®é¢˜ï¼šã€Œæˆ‘å±•ç¤ºä»€ä¹ˆï¼Ÿã€

## è¾“å‡ºæ ¼å¼ (åªè¾“å‡º JSON)
```json
{
  "core": {
    "keyword": "2-4å­—å…³é”®è¯",
    "description": "ç”¨ç¬¬äºŒäººç§°ã€Œä½ ã€çš„1-2å¥è§£é‡Š",
    "data_source": "ä¸»è¦æ•°æ®æ¥æº"
  },
  "inner": { ... },
  "outer": { ... }
}
```
"""
```

## 8.4 å…³é”®ä»£ç ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `portrait.py` | æ›´æ–° `IDENTITY_PRISM_PROMPT` æ”¯æŒæ˜Ÿåº§æ•°æ® |
| `report_service.py` | åœ¨ `generate_report()` ä¸­è°ƒç”¨ `generate_identity_prism()` |
| `profile_repo.py` | æ·»åŠ  `update_section()` æ–¹æ³•å•ç‹¬æ›´æ–°æŸä¸ª section |

---

# é™„å½•: å…³é”®æ–‡ä»¶æ¸…å•

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¡Œæ•° |
|------|----------|------|
| Context æ„å»º | `apps/api/services/vibe_engine/context.py` | 410 |
| RAG æ£€ç´¢ | `apps/api/services/knowledge/retrieval.py` | 213 |
| çŸ¥è¯†åº“å­˜å‚¨ | `apps/api/stores/knowledge_repo.py` | 276 |
| Chat è·¯ç”± | `apps/api/routes/chat.py` | 790 |
| æŠ¥å‘ŠæœåŠ¡ | `apps/api/services/report/report_service.py` | 411 |
| è®¿è°ˆæœåŠ¡ | `apps/api/services/interview/interview_service.py` | 587 |
| Portrait æœåŠ¡ | `apps/api/services/vibe_engine/portrait.py` | 541 |
| Profile å­˜å‚¨ | `apps/api/stores/profile_repo.py` | 11765 |

---

# ä¹ã€Profile ç´¯ç§¯ - ä¿®å¤æ–¹æ¡ˆè®¾è®¡

> **å†³ç­–æ—¥æœŸ**: 2026-01-09
> **æ–¹æ¡ˆ**: åå°ä»»åŠ¡ + å¯é…ç½®æ›´æ–°é¢‘ç‡

## 9.1 é—®é¢˜åˆ†æ

| é—®é¢˜ | åŸçŠ¶æ€ | ä¿®å¤çŠ¶æ€ |
|------|--------|---------|
| æ›´æ–°é¢‘ç‡ | ç¡¬ç¼–ç  10 æ¡ | âœ… å¯é…ç½® (env: PORTRAIT_UPDATE_INTERVAL)ï¼Œé»˜è®¤ 20 æ¡ |
| é›†æˆåˆ° chat | âŒ æœªé›†æˆ | âœ… åå°ä»»åŠ¡ `maybe_update_portrait()` |
| æµå¼ chat æ”¯æŒ | âŒ | âœ… `chat_stream()` é›†æˆ |
| éæµå¼ chat æ”¯æŒ | âŒ | âœ… `chat()` é›†æˆ |

## 9.2 å…³é”®ä»£ç ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `portrait_service.py` | `UPDATE_INTERVAL_MESSAGES` æ”¹ä¸ºä»ç¯å¢ƒå˜é‡è¯»å– |
| `chat.py` | æ·»åŠ  `maybe_update_portrait()` å‡½æ•°ï¼Œåœ¨æ¶ˆæ¯ä¿å­˜åå¼‚æ­¥è°ƒç”¨ |

---

# åã€å…³ç³»æ¨¡æ‹Ÿå™¨/Kçº¿ - ä¿®å¤æ–¹æ¡ˆè®¾è®¡

> **å†³ç­–æ—¥æœŸ**: 2026-01-09
> **æ–¹æ¡ˆ**: å®ç°æœ¬åœ°æ’ç›˜è®¡ç®— + ä¿®å¤å‰ç«¯å·¥å…·è°ƒç”¨

## 10.1 åç«¯æœåŠ¡çŠ¶æ€

| æœåŠ¡ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **Kçº¿è®¡ç®—** (`KLineService`) | âœ… å®Œæˆ | `/fortune/kline` API å·²å®ç° |
| **å¤§è¿æµå¹´** (`FortuneCalculator`) | âœ… å®Œæˆ | `/fortune/cycles` + `/fortune/annual` å·²å®ç° |
| **å…³ç³»åˆ†æ** (`RelationshipService`) | âœ… å®Œæˆ | `/relationship/analyze` å·²å®ç° |
| **å…«å­—æ’ç›˜** | âŒ ç¼ºå¤± | éœ€è¦å®ç° `BaziCalculator` |
| **æ˜Ÿç›˜è®¡ç®—** | âŒ ç¼ºå¤± | éœ€è¦å®ç° `ZodiacCalculator` |

## 10.2 å‰ç«¯å·¥å…·è°ƒç”¨çŠ¶æ€

| å·¥å…· | å½“å‰å®ç° | ç›®æ ‡å®ç° |
|------|---------|---------|
| `show_bazi_kline` | âœ… è°ƒç”¨ `/fortune/kline` | å·²æ­£ç¡® |
| `show_bazi_fortune` | âœ… è°ƒç”¨ `/fortune/cycles` + `/fortune/annual` | å·²æ­£ç¡® |
| `show_relationship` | âœ… è°ƒç”¨ `/relationship/analyze` | å·²æ­£ç¡® |
| `show_bazi_chart` | âŒ ç¡¬ç¼–ç  | è°ƒç”¨æ–°çš„ `/bazi/chart` API |
| `show_zodiac_chart` | âŒ ç¡¬ç¼–ç  | è°ƒç”¨æ–°çš„ `/zodiac/chart` API |
| `show_zodiac_transit` | âŒ ç¡¬ç¼–ç  | è°ƒç”¨æ–°çš„ `/zodiac/transit` API |
| `show_zodiac_synastry` | âŒ ç¡¬ç¼–ç  | å¤ç”¨ `/relationship/analyze` |
| `show_insight` | âŒ ç¡¬ç¼–ç  | è°ƒç”¨ PortraitService |

## 10.3 æ’ç›˜æœåŠ¡è®¾è®¡

```
ä¾èµ–åº“:
â”œâ”€ lunar-python: å…«å­—æ’ç›˜ (å¹²æ”¯ã€åç¥ã€äº”è¡Œ)
â””â”€ pyswisseph/flatlib: æ˜Ÿç›˜è®¡ç®— (è¡Œæ˜Ÿä½ç½®ã€å®«ä½ã€ç›¸ä½)

API ç«¯ç‚¹:
â”œâ”€ POST /bazi/chart     - è®¡ç®—å…«å­—å‘½ç›˜
â”œâ”€ POST /zodiac/chart   - è®¡ç®—æ˜Ÿç›˜
â””â”€ POST /zodiac/transit - è®¡ç®—è¿‡å¢ƒ

å¾…å®ç°æ–‡ä»¶:
â”œâ”€ services/bazi/bazi_calculator.py
â”œâ”€ services/zodiac/zodiac_calculator.py
â”œâ”€ routes/bazi.py
â””â”€ routes/zodiac.py
```

## 10.4 ä¸‹ä¸€æ­¥è®¡åˆ’

ç”±äºæ’ç›˜è®¡ç®—æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä¸“ä¸šé¢†åŸŸï¼Œå»ºè®®åˆ†é˜¶æ®µå®ç°ï¼š

**Phase 1**: åˆ›å»ºæœåŠ¡æ¡†æ¶å’Œ API ç«¯ç‚¹ç»“æ„
**Phase 2**: é›†æˆ lunar-python å®ç°å…«å­—æ’ç›˜
**Phase 3**: é›†æˆ swisseph å®ç°æ˜Ÿç›˜è®¡ç®—
**Phase 4**: ä¿®å¤å‰ç«¯å·¥å…·è°ƒç”¨
