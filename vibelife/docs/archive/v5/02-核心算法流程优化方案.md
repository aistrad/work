# VibeLife æ ¸å¿ƒç®—æ³•æµç¨‹ä¼˜åŒ–æå‡æ–¹æ¡ˆ

> åŸºäºæˆ˜ç•¥é‡æ„è“å›¾ v0 çš„æ·±åº¦ä»£ç å®¡æŸ¥æŠ¥å‘Š
>
> åˆ›å»ºæ—¥æœŸï¼š2026-01-10
> ç‰ˆæœ¬ï¼šv5

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£åŸºäºå¯¹æˆ˜ç•¥é‡æ„è“å›¾çš„æ·±åº¦åˆ†æï¼Œç»“åˆå½“å‰åç«¯æ ¸å¿ƒç®—æ³•å®ç°çš„å…¨é¢å®¡æŸ¥ï¼Œæå‡ºæ ¸å¿ƒç®—æ³•æµç¨‹å±‚é¢çš„ä¼˜åŒ–æå‡æ–¹æ¡ˆã€‚

### æ ¸å¿ƒå‘ç°

| æ¨¡å— | è“å›¾æ„¿æ™¯ | å½“å‰å®ç° | å·®è·ç¨‹åº¦ |
|------|----------|----------|----------|
| å…«å­—è®¡ç®— | ç²¾ç¡®æ’ç›˜ + æ ¼å±€åˆ¤æ–­ | lunar-python å®Œæ•´å®ç° | ğŸŸ¢ è¾ƒå¥½ |
| æ˜Ÿåº§è®¡ç®— | Swiss Ephemeris ç²¾ç¡®æ˜Ÿå† | ç®€åŒ–å‘¨æœŸä¼°ç®— | ğŸ”´ ä¸¥é‡ |
| Context ç¼–æ’ | 5å±‚ç»Ÿä¸€ç†è§£å¼•æ“ | åŸºç¡€å®ç° | ğŸŸ¡ ä¸­ç­‰ |
| è®°å¿†ç³»ç»Ÿ | é•¿æœŸè®°å¿† + æ´å¯ŸæŠ½å– | æ¡†æ¶å­˜åœ¨ï¼ŒåŠŸèƒ½ç©ºå£³ | ğŸ”´ ä¸¥é‡ |
| å¤šç»´èåˆ | Identity Prism äº¤å‰æ´å¯Ÿ | ç‹¬ç«‹ Skill æ¨¡å¼ | ğŸ”´ ä¸¥é‡ |

---

## äºŒã€å½“å‰ç®—æ³•å®ç°åˆ†æ

### 2.1 å…«å­—è®¡ç®—ç®—æ³•

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/api/tools/bazi/calculator.py` - åŸºç¡€æ’ç›˜
- `apps/api/services/bazi/bazi_calculator.py` - æœåŠ¡å±‚
- `apps/api/tools/bazi/transit.py` - å¤§è¿æµå¹´
- `apps/api/tools/bazi/analysis.py` - åç¥åˆ†æ

**å½“å‰å®ç°æµç¨‹**ï¼š
```
å‡ºç”Ÿæ—¥æœŸæ—¶é—´ â†’ é˜³å†è½¬å†œå† â†’ å››æŸ±æ’ç›˜ â†’ è—å¹²è®¡ç®— â†’ åç¥æ¨ç®— â†’ æ ¼å±€åˆ¤æ–­ â†’ å¤§è¿æµå¹´
```

**å®ç°çŠ¶æ€**ï¼šâœ… å®Œæ•´
- ä½¿ç”¨ lunar-python åº“è¿›è¡Œç²¾ç¡®è®¡ç®—
- å››æŸ±ï¼ˆå¹´/æœˆ/æ—¥/æ—¶æŸ±ï¼‰è®¡ç®—å‡†ç¡®
- è—å¹²ã€åç¥ã€äº”è¡Œå¼ºåº¦åˆ†æå®Œæ•´
- å¤§è¿ï¼ˆ10å¹´å‘¨æœŸï¼‰ã€æµå¹´è®¡ç®—å®Œæ•´

### 2.2 æ˜Ÿåº§è®¡ç®—ç®—æ³•

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/api/tools/zodiac/chart.py` - æ˜Ÿç›˜è®¡ç®—
- `apps/api/tools/zodiac/transit.py` - è¡Œè¿è®¡ç®—
- `apps/api/tools/zodiac/events.py` - å¤©è±¡äº‹ä»¶

**å½“å‰å®ç°æµç¨‹**ï¼š
```
å‡ºç”Ÿæ—¥æœŸ â†’ å¤ªé˜³æ˜Ÿåº§åˆ¤æ–­ â†’ æœˆäº®æ˜Ÿåº§ä¼°ç®— â†’ ä¸Šå‡æ˜Ÿåº§ä¼°ç®— â†’ è¡Œæ˜Ÿä½ç½® â†’ è¡Œè¿åˆ†æ
```

**å®ç°çŠ¶æ€**ï¼šâš ï¸ ç®€åŒ–ç‰ˆ
- å¤ªé˜³æ˜Ÿåº§ï¼šåŸºäºæ—¥æœŸèŒƒå›´åˆ¤æ–­ï¼ˆå‡†ç¡®ï¼‰
- æœˆäº®æ˜Ÿåº§ï¼šåŸºäºå‘¨æœŸè¿‘ä¼¼ä¼°ç®—ï¼ˆä¸ç²¾ç¡®ï¼‰
- ä¸Šå‡æ˜Ÿåº§ï¼šåŸºäºå‡ºç”Ÿæ—¶é—´ä¼°ç®—ï¼ˆä¸ç²¾ç¡®ï¼‰
- è¡Œæ˜Ÿä½ç½®ï¼šåŸºäºå‘¨æœŸè¿‘ä¼¼ï¼ˆéç²¾ç¡®æ˜Ÿå†ï¼‰

**ä»£ç æ³¨é‡Š**ï¼š
```python
# For accurate calculations, use Swiss Ephemeris
```

### 2.3 AI å¯¹è¯å¼•æ“

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/api/services/vibe_engine/context.py` - Context ç¼–æ’
- `apps/api/services/vibe_engine/tools.py` - å·¥å…·å®šä¹‰
- `apps/api/services/vibe_engine/emotion_engine.py` - æƒ…ç»ªå¼•æ“
- `apps/api/services/vibe_engine/insight_generator.py` - æ´å¯Ÿç”Ÿæˆ
- `apps/api/services/vibe_engine/memory_system.py` - è®°å¿†ç³»ç»Ÿ
- `apps/api/services/vibe_engine/portrait.py` - ç”¨æˆ·ç”»åƒ

**Context ç¼–æ’æ¶æ„**ï¼š
```
System Prompt = Persona Base + Skill Context + Voice Mode
              + User Profile (å…¨é‡æ³¨å…¥)
              + Knowledge (RAGæ£€ç´¢)
              + Conversation History (åŸå§‹å¯¹è¯)
```

**å®ç°çŠ¶æ€**ï¼šâœ… åŸºç¡€å®Œæ•´
- 5å±‚ä¸Šä¸‹æ–‡ç»“æ„æ¸…æ™°
- å…¨é‡ Profile æ³¨å…¥ç­–ç•¥
- RAG çŸ¥è¯†æ£€ç´¢é›†æˆ
- 3ç§è¯­æ°”æ¨¡ï¿½ï¿½ï¿½ï¼ˆæš–å¿ƒ/æ¯’èˆŒ/å¯¼å¸ˆï¼‰

### 2.4 çŸ¥è¯†åº“æ£€ç´¢

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/api/services/knowledge/embedding.py` - å‘é‡åµŒå…¥
- `apps/api/services/knowledge/retrieval.py` - æ··åˆæ£€ç´¢
- `apps/api/services/knowledge/rag_service.py` - RAG æœåŠ¡
- `apps/api/services/knowledge/term_service.py` - æœ¯è¯­ç®¡ç†

**å®ç°çŠ¶æ€**ï¼šâœ… å®Œæ•´
- BGE-M3 æ¨¡å‹ï¼Œ1024ç»´å‘é‡
- Hybrid Searchï¼ˆVector 70% + FTS 30%ï¼‰
- Jieba åˆ†è¯ + æœ¯è¯­è¯å…¸

### 2.5 è®°å¿†ç³»ç»Ÿ

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/api/services/vibe_engine/memory_system.py`
- `apps/api/routes/memories.py`

**å®ç°çŠ¶æ€**ï¼šâš ï¸ æ¡†æ¶å­˜åœ¨ï¼ŒåŠŸèƒ½ç©ºå£³
- Memory API å·²å®šä¹‰ä½†è¿”å›ç©ºæ•°æ®
- çŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰å¯ç”¨
- é•¿æœŸè®°å¿†ï¼ˆæ´å¯Ÿ/äº‹å®ï¼‰æœªå®é™…å­˜å‚¨

---

## ä¸‰ã€ä¸è“å›¾å·®è·è¯¦ç»†åˆ†æ

### 3.1 ç»Ÿä¸€ç†è§£å¼•æ“ï¼ˆUnified Understanding Engineï¼‰

**è“å›¾è®¾è®¡**ï¼š
```
Context Orchestratorï¼ˆä¸Šä¸‹æ–‡ç¼–æ’å™¨ï¼‰
â”œâ”€â”€ 1. Identity Layerï¼ˆèº«ä»½å±‚ï¼‰
â”‚   â€¢ ç”¨æˆ·æ˜¯è°ï¼ˆåŸºç¡€ä¿¡æ¯ã€æ€§æ ¼ã€åå¥½ï¼‰
â”‚   â€¢ å…«å­—/æ˜Ÿåº§/MBTI ç­‰å¤šç»´åº¦èº«ä»½æ•°æ®
â”‚
â”œâ”€â”€ 2. Temporal Layerï¼ˆæ—¶é—´å±‚ï¼‰
â”‚   â€¢ å½“å‰æ—¶é—´èŠ‚ç‚¹ï¼ˆå¤§è¿ã€æµå¹´ã€æµæœˆã€æµæ—¥ï¼‰
â”‚   â€¢ å³å°†åˆ°æ¥çš„é‡è¦æ—¶é—´èŠ‚ç‚¹
â”‚
â”œâ”€â”€ 3. Memory Layerï¼ˆè®°å¿†å±‚ï¼‰
â”‚   â€¢ å†å²å¯¹è¯ä¸­çš„é‡è¦ä¿¡æ¯
â”‚   â€¢ ç”¨æˆ·æåˆ°çš„ç”Ÿæ´»äº‹ä»¶å’Œå…³å¿ƒçš„é—®é¢˜
â”‚   â€¢ AI å¯¹ç”¨æˆ·çš„ç´¯ç§¯æ´å¯Ÿ
â”‚
â”œâ”€â”€ 4. Knowledge Layerï¼ˆçŸ¥è¯†å±‚ï¼‰
â”‚   â€¢ ä¸å½“å‰è¯é¢˜ç›¸å…³çš„ä¸“ä¸šçŸ¥è¯†
â”‚   â€¢ å‘½ç†è§£è¯»çš„æœ€ä½³å®è·µ
â”‚
â””â”€â”€ 5. Persona Layerï¼ˆäººæ ¼å±‚ï¼‰
    â€¢ å½“å‰é€‰æ‹©çš„å¯¹è¯é£æ ¼
    â€¢ è¯­æ°”ã€æªè¾ã€è¡¨è¾¾æ–¹å¼
         â”‚
         â–¼
    Composed Context â†’ LLM â†’ AIå›å¤
         â”‚
         â–¼
    Insight Extractorï¼ˆæ´å¯ŸæŠ½å–å™¨ï¼‰
    â€¢ ä»å¯¹è¯ä¸­æŠ½å–ï¼šç”¨æˆ·äº‹ä»¶ã€æƒ…ç»ªã€æ´å¯Ÿã€è·Ÿè¿›ä»»åŠ¡
```

**å·®è·å¯¹æ¯”**ï¼š

| è“å›¾ç»„ä»¶ | å½“å‰å®ç° | å·®è· |
|---------|---------|------|
| Identity Layer | âœ… Portrait + Identity Prism | ç¼ºå°‘å¤šç»´åº¦èåˆçš„"å…¨æ¯ç”¨æˆ·" |
| Temporal Layer | âš ï¸ æœ‰å¤§è¿æµå¹´è®¡ç®— | ç¼ºå°‘"å³å°†åˆ°æ¥çš„é‡è¦æ—¶é—´èŠ‚ç‚¹"ä¸»åŠ¨æé†’ |
| Memory Layer | âš ï¸ æœ‰çŸ­æœŸå¯¹è¯å†å² | é•¿æœŸè®°å¿†ï¼ˆç”Ÿæ´»äº‹ä»¶ã€ç´¯ç§¯æ´å¯Ÿï¼‰è¾ƒå¼± |
| Knowledge Layer | âœ… RAG ç³»ç»Ÿå®Œæ•´ | - |
| Persona Layer | âœ… 3ç§è¯­æ°”æ¨¡å¼ | - |
| Insight Extractor | âš ï¸ æœ‰ InsightGenerator | ç¼ºå°‘è‡ªåŠ¨äº‹ä»¶è·Ÿè¸ªå’Œ Follow-up Task |

### 3.2 AI "æ‡‚ä½ "çš„å››ä¸ªå±‚æ¬¡

**è“å›¾è®¾è®¡**ï¼š
```
Level 1ï¼šè®°å¾—ä½ è¯´è¿‡çš„è¯
  "ä½ çš„é¢è¯•æ€ä¹ˆæ ·äº†ï¼Ÿä¸Šå‘¨ä½ è¯´ç‰¹åˆ«ç´§å¼ æ¥ç€ã€‚"

Level 2ï¼šç†è§£ä½ çš„æ¨¡å¼
  "æˆ‘æ³¨æ„åˆ°ä½ æœ€è¿‘å‡ æ¬¡æåˆ°å·¥ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šè¯´'ç´¯'å’Œ'æ²¡æ„æ€'ã€‚"

Level 3ï¼šé¢„è§ä½ çš„éœ€è¦
  "ä¸‹ä¸ªæœˆä½ å°±è¦è¿›å…¥æ–°çš„å¤§è¿äº†ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘æƒ³å’Œä½ èŠèŠ..."

Level 4ï¼šæˆä¸ºä½ çš„é•œå­
  "ä¸€å¹´å‰ä½ ç¬¬ä¸€æ¬¡æ¥æ‰¾æˆ‘çš„æ—¶å€™ï¼Œä½ è¯´'æˆ‘ä¸çŸ¥é“è‡ªå·±æƒ³è¦ä»€ä¹ˆ'ã€‚
   ä½†è¿™ä¸€å¹´æˆ‘ä»¬çš„å¯¹è¯é‡Œï¼Œä½ å·²ç»è¶Šæ¥è¶Šæ¸…æ™°äº†ã€‚"
```

**å½“å‰å®ç°**ï¼š
- Level 1ï¼šâš ï¸ æœ‰å¯¹è¯å†å²ï¼Œä½†æ— ä¸»åŠ¨è·Ÿè¿›
- Level 2ï¼šâš ï¸ InsightGenerator å¯å‘ç°æ¨¡å¼ï¼Œä½†è§¦å‘é¢‘ç‡ä½
- Level 3ï¼šâŒ ç¼ºå°‘é¢„è§æ€§æé†’
- Level 4ï¼šâŒ ç¼ºå°‘é•¿æœŸæˆé•¿è½¨è¿¹å¯¹æ¯”

### 3.3 å¤š Skill èåˆ

**è“å›¾è®¾è®¡**ï¼š
```
ç”¨æˆ·é—®ï¼š"æˆ‘æœ€è¿‘æ„Ÿæƒ…è¿åŠ¿æ€ä¹ˆæ ·ï¼Ÿ"

é‡æ„åå›ç­”ï¼š
"è®©æˆ‘ä»å‡ ä¸ªè§’åº¦å¸®ä½ çœ‹çœ‹ã€‚"

"é¦–å…ˆï¼Œä»å…«å­—çœ‹ï¼Œä½ ä»Šå¹´èµ°çš„æ˜¯ [å¤§è¿]ï¼Œæ„Ÿæƒ…å®«æ˜¯ [çŠ¶æ€]ã€‚
 è¿™æ„å‘³ç€ [è§£è¯»]ã€‚"

"æœ‰è¶£çš„æ˜¯ï¼Œä»æ˜Ÿåº§è§’åº¦çœ‹ï¼Œé‡‘æ˜Ÿæœ€è¿‘æ­£åœ¨ç»è¿‡ä½ çš„ç¬¬ä¸ƒå®«ï¼ˆå…³ç³»å®«ï¼‰ï¼Œ
 è¿™é€šå¸¸æ˜¯ [è§£è¯»]ã€‚"

"ç»“åˆè¿™ä¸¤ä¸ªè§†è§’ï¼Œæˆ‘çš„å»ºè®®æ˜¯ [ç»¼åˆå»ºè®®]ã€‚"

"ä½ æƒ³æ·±å…¥èŠèŠå“ªä¸ªè§’åº¦ï¼Ÿ"
```

**å½“å‰å®ç°**ï¼š
- å…«å­—å’Œæ˜Ÿåº§ä½œä¸ºç‹¬ç«‹ Skill å­˜åœ¨
- Context ä¸­æŒ‰ skill åˆ†åˆ«æ³¨å…¥
- å¯¹è¯ä¸­ä¸ä¼šè‡ªç„¶å¼•ç”¨å¤šç»´åº¦

---

## å››ã€ä¼˜åŒ–æå‡æ–¹æ¡ˆ

### 4.1 P0 ä¼˜å…ˆçº§ï¼šæ˜Ÿåº§è®¡ç®—ç²¾åº¦æå‡

#### 4.1.1 é›†æˆ Swiss Ephemeris

**ç›®æ ‡**ï¼šæå‡æ˜Ÿåº§è®¡ç®—ç²¾åº¦ï¼Œæ”¯æŒä¸“ä¸šçº§åˆ†æ

**æŠ€æœ¯æ–¹æ¡ˆ**ï¼š
```python
# æ–¹æ¡ˆAï¼šä½¿ç”¨ pyswisseph åº“
import swisseph as swe

def calculate_planet_position(jd, planet):
    """è®¡ç®—è¡Œæ˜Ÿç²¾ç¡®ä½ç½®"""
    swe.set_ephe_path('/path/to/ephemeris')
    result = swe.calc_ut(jd, planet)
    return {
        'longitude': result[0],
        'latitude': result[1],
        'distance': result[2],
        'speed': result[3]
    }

# æ–¹æ¡ˆBï¼šä½¿ç”¨ flatlib åº“ï¼ˆæ›´æ˜“ç”¨ï¼‰
from flatlib.datetime import Datetime
from flatlib.geopos import GeoPos
from flatlib.chart import Chart

def calculate_natal_chart(birth_date, birth_time, lat, lon):
    """è®¡ç®—å®Œæ•´æ˜Ÿç›˜"""
    date = Datetime(birth_date, birth_time, '+08:00')
    pos = GeoPos(lat, lon)
    chart = Chart(date, pos)
    return chart
```

**å®ç°æ–‡ä»¶**ï¼š
- `apps/api/tools/zodiac/ephemeris.py` - æ–°å¢
- `apps/api/tools/zodiac/chart.py` - é‡æ„

**ç²¾åº¦æå‡**ï¼š
| å…ƒç´  | å½“å‰ç²¾åº¦ | ç›®æ ‡ç²¾åº¦ |
|------|----------|----------|
| å¤ªé˜³æ˜Ÿåº§ | å‡†ç¡® | å‡†ç¡® |
| æœˆäº®æ˜Ÿåº§ | ï¿½ï¿½2å¤©è¯¯å·® | ç²¾ç¡®åˆ°åˆ†é’Ÿ |
| ä¸Šå‡æ˜Ÿåº§ | Â±2å°æ—¶è¯¯å·® | ç²¾ç¡®åˆ°åˆ†é’Ÿ |
| è¡Œæ˜Ÿä½ç½® | Â±5åº¦è¯¯å·® | ç²¾ç¡®åˆ°è§’åˆ† |
| ç›¸ä½è®¡ç®— | æ—  | ç²¾ç¡®åˆ°1åº¦å®¹è®¸åº¦ |

### 4.2 P0 ä¼˜å…ˆçº§ï¼šè®°å¿†ç³»ç»Ÿå®ç°

#### 4.2.1 Memory å­˜å‚¨å®ç°

**ç›®ï¿½ï¿½ï¿½**ï¼šè®© AI çœŸæ­£"è®°ä½"ç”¨æˆ·

**æ•°æ®æ¨¡å‹**ï¼š
```python
# models/memory.py
class Memory(BaseModel):
    id: str
    user_id: str
    type: Literal['event', 'preference', 'emotion', 'insight', 'fact']
    content: str
    source: str  # æ¥æºå¯¹è¯ID
    confidence: float  # ç½®ä¿¡åº¦ 0-1
    created_at: datetime
    expires_at: Optional[datetime]  # å¯é€‰è¿‡æœŸæ—¶é—´
    embedding: List[float]  # å‘é‡åµŒå…¥

class LifeEvent(BaseModel):
    id: str
    user_id: str
    event_type: str  # interview, meeting, travel, birthday...
    title: str
    description: Optional[str]
    scheduled_at: datetime
    status: Literal['upcoming', 'passed', 'cancelled']
    follow_up_sent: bool
    created_at: datetime
```

**å­˜å‚¨å®ç°**ï¼š
```python
# stores/memory_repo.py
class MemoryRepository:
    async def save_memory(self, memory: Memory) -> str:
        """ä¿å­˜è®°å¿†"""
        pass

    async def search_memories(
        self,
        user_id: str,
        query: str,
        types: List[str] = None,
        limit: int = 10
    ) -> List[Memory]:
        """è¯­ä¹‰æ£€ç´¢ç›¸å…³è®°å¿†"""
        pass

    async def get_recent_memories(
        self,
        user_id: str,
        days: int = 30
    ) -> List[Memory]:
        """è·å–è¿‘æœŸè®°å¿†"""
        pass
```

#### 4.2.2 æ´å¯ŸæŠ½å–å™¨å®ç°

**ç›®æ ‡**ï¼šä»å¯¹è¯ä¸­è‡ªåŠ¨æŠ½å–æœ‰ä»·å€¼ä¿¡æ¯

**å®ç°æ–¹æ¡ˆ**ï¼š
```python
# services/vibe_engine/insight_extractor.py
class InsightExtractor:
    EXTRACTION_PROMPT = """
    åˆ†æä»¥ä¸‹å¯¹è¯ï¼ŒæŠ½å–ä»¥ä¸‹ç±»å‹çš„ä¿¡æ¯ï¼š

    1. äº‹ä»¶ï¼ˆeventï¼‰ï¼šç”¨æˆ·æåˆ°çš„å…·ä½“äº‹ä»¶
       - è¿‡å»äº‹ä»¶ï¼šå·²ç»å‘ç”Ÿçš„äº‹
       - æœªæ¥äº‹ä»¶ï¼šè®¡åˆ’è¦åšçš„äº‹ï¼ˆéœ€è¦è·Ÿè¿›ï¼‰

    2. åå¥½ï¼ˆpreferenceï¼‰ï¼šç”¨æˆ·è¡¨è¾¾çš„å–œå¥½
       - å–œæ¬¢ä»€ä¹ˆ
       - ä¸å–œæ¬¢ä»€ä¹ˆ

    3. æƒ…ç»ªï¼ˆemotionï¼‰ï¼šç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€
       - å½“å‰æƒ…ç»ª
       - æƒ…ç»ªè§¦å‘å› ç´ 

    4. äº‹å®ï¼ˆfactï¼‰ï¼šå…³äºç”¨æˆ·çš„å®¢è§‚ä¿¡æ¯
       - èŒä¸šã€å®¶åº­ã€ç”Ÿæ´»çŠ¶æ€ç­‰

    å¯¹è¯å†…å®¹ï¼š
    {conversation}

    è¯·ä»¥JSONæ ¼å¼è¾“å‡ºæŠ½å–ç»“æœã€‚
    """

    async def extract(self, conversation: List[Message]) -> List[Memory]:
        """ä»å¯¹è¯ä¸­æŠ½å–è®°å¿†"""
        pass
```

#### 4.2.3 ä¸»åŠ¨è·Ÿè¿›ç³»ç»Ÿ

**ç›®æ ‡**ï¼šåœ¨å…³é”®æ—¶åˆ»ä¸»åŠ¨å…³å¿ƒç”¨æˆ·

**å®ç°æ–¹æ¡ˆ**ï¼š
```python
# services/reminder/follow_up_service.py
class FollowUpService:
    async def check_upcoming_events(self, user_id: str) -> List[FollowUp]:
        """æ£€æŸ¥å³å°†åˆ°æ¥çš„äº‹ä»¶"""
        events = await self.event_repo.get_upcoming_events(user_id)
        follow_ups = []

        for event in events:
            days_until = (event.scheduled_at - datetime.now()).days

            if days_until == 1:
                # æ˜å¤©çš„äº‹ä»¶
                follow_ups.append(FollowUp(
                    type='reminder',
                    message=f"æ˜å¤©å°±æ˜¯ä½ çš„{event.title}äº†ï¼Œå‡†å¤‡å¥½äº†å—ï¼Ÿ"
                ))
            elif days_until == 0:
                # ä»Šå¤©çš„äº‹ä»¶
                follow_ups.append(FollowUp(
                    type='encouragement',
                    message=f"ä»Šå¤©æ˜¯ä½ çš„{event.title}ï¼Œç¥ä½ ä¸€åˆ‡é¡ºåˆ©ï¼"
                ))
            elif days_until == -1:
                # æ˜¨å¤©çš„äº‹ä»¶
                follow_ups.append(FollowUp(
                    type='follow_up',
                    message=f"ä½ çš„{event.title}æ€ä¹ˆæ ·ï¼Ÿæƒ³èŠèŠå—ï¼Ÿ"
                ))

        return follow_ups
```

### 4.3 P1 ä¼˜å…ˆçº§ï¼šå¤šç»´åº¦èåˆ

#### 4.3.1 ç»´åº¦èåˆ Context ç¼–æ’

**ç›®æ ‡**ï¼šè®© AI è‡ªç„¶åœ°åœ¨å¤šä¸ªç»´åº¦ä¹‹é—´åˆ‡æ¢

**å®ç°æ–¹æ¡ˆ**ï¼š
```python
# services/vibe_engine/dimension_fusion.py
class DimensionFusion:
    FUSION_PROMPT = """
    ä½ æ˜¯ä¸€ä¸ªå¤šç»´åº¦åˆ†æä¸“å®¶ã€‚å½“ç”¨æˆ·æé—®æ—¶ï¼Œä½ åº”è¯¥ï¼š

    1. è¯†åˆ«é—®é¢˜æ¶‰åŠçš„ç»´åº¦ï¼ˆæ„Ÿæƒ…ã€äº‹ä¸šã€å¥åº·ã€è´¢è¿ã€è‡ªæˆ‘è®¤çŸ¥ï¼‰
    2. ä»å¤šä¸ªè§’åº¦æä¾›åˆ†æï¼š
       - å…«å­—è§’åº¦ï¼šåŸºäºç”¨æˆ·çš„å‘½ç›˜å’Œå½“å‰è¿åŠ¿
       - æ˜Ÿåº§è§’åº¦ï¼šåŸºäºç”¨æˆ·çš„æ˜Ÿç›˜å’Œè¡Œè¿
       - å…¶ä»–ç›¸å…³ç»´åº¦

    3. ç»¼åˆå¤šä¸ªè§’åº¦ç»™å‡ºå»ºè®®
    4. è‡ªç„¶åœ°å¼•å¯¼ç”¨æˆ·æ¢ç´¢å…¶ä»–ç»´åº¦

    ç”¨æˆ·çš„å¤šç»´åº¦ç”»åƒï¼š
    {identity_prism}

    å½“å‰é—®é¢˜ï¼š
    {question}
    """

    async def build_fusion_context(
        self,
        user_id: str,
        question: str
    ) -> str:
        """æ„å»ºèåˆä¸Šä¸‹æ–‡"""
        # è·å–ç”¨æˆ·çš„ Identity Prism
        prism = await self.portrait_service.get_identity_prism(user_id)

        # è·å–ç›¸å…³çš„å…«å­—ä¿¡æ¯
        bazi_context = await self.bazi_service.get_relevant_context(
            user_id, question
        )

        # è·å–ç›¸å…³çš„æ˜Ÿåº§ä¿¡æ¯
        zodiac_context = await self.zodiac_service.get_relevant_context(
            user_id, question
        )

        # ç»„åˆä¸Šä¸‹æ–‡
        return self.FUSION_PROMPT.format(
            identity_prism=prism,
            bazi_context=bazi_context,
            zodiac_context=zodiac_context,
            question=question
        )
```

#### 4.3.2 äº¤å‰æ´å¯Ÿç”Ÿæˆ

**ç›®æ ‡**ï¼šå‘ç°ä¸åŒç»´åº¦ä¹‹é—´çš„å…³è”

**å®ç°æ–¹æ¡ˆ**ï¼š
```python
# services/vibe_engine/cross_insight.py
class CrossInsightGenerator:
    CROSS_INSIGHT_PROMPT = """
    åˆ†æç”¨æˆ·çš„å¤šç»´åº¦æ•°æ®ï¼Œå‘ç°æœ‰è¶£çš„äº¤å‰æ´å¯Ÿï¼š

    å…«å­—ä¿¡æ¯ï¼š
    - æ—¥ä¸»ï¼š{day_master}
    - æ ¼å±€ï¼š{pattern}
    - ç”¨ç¥ï¼š{useful_god}

    æ˜Ÿåº§ä¿¡æ¯ï¼š
    - å¤ªé˜³æ˜Ÿåº§ï¿½ï¿½ï¿½{sun_sign}
    - æœˆäº®æ˜Ÿåº§ï¼š{moon_sign}
    - ä¸Šå‡æ˜Ÿåº§ï¼š{rising_sign}

    è¯·æ‰¾å‡ºå…«å­—å’Œæ˜Ÿåº§ä¹‹é—´ç›¸äº’å°è¯æˆ–æœ‰è¶£å¯¹æ¯”çš„ç‚¹ã€‚
    ä¾‹å¦‚ï¼š
    - "ä½ çš„å…«å­—æ—¥ä¸»æ˜¯ç”²æœ¨ï¼Œè€Œå¤ªé˜³æ˜Ÿåº§æ˜¯å¤„å¥³åº§ï¼Œè¿™ä¸¤è€…éƒ½æŒ‡å‘..."
    - "æœ‰è¶£çš„æ˜¯ï¼Œä½ çš„æœˆäº®åœ¨åŒé±¼åº§ï¼Œè€Œå…«å­—ä¸­æ°´å¾ˆæ—ºï¼Œè¿™è§£é‡Šäº†..."
    """

    async def generate(self, user_id: str) -> List[CrossInsight]:
        """ç”Ÿæˆäº¤å‰æ´å¯Ÿ"""
        pass
```

### 4.4 P2 ä¼˜å…ˆçº§ï¼šæ—¶é—´å±‚å¢å¼º

#### 4.4.1 æ—¶é—´èŠ‚ç‚¹é¢„è­¦ç³»ç»Ÿ

**ç›®æ ‡**ï¼šåœ¨é‡è¦æ—¶é—´èŠ‚ç‚¹å‰ä¸»åŠ¨æé†’

**å®ç°æ–¹æ¡ˆ**ï¼š
```python
# services/temporal/time_alert_service.py
class TimeAlertService:
    async def check_temporal_alerts(self, user_id: str) -> List[Alert]:
        """æ£€æŸ¥æ—¶é—´èŠ‚ç‚¹é¢„è­¦"""
        alerts = []

        # æ£€æŸ¥å¤§è¿äº¤æ¥
        dayun_change = await self.check_dayun_change(user_id)
        if dayun_change:
            alerts.append(dayun_change)

        # æ£€æŸ¥æµå¹´å˜åŒ–
        liunian_change = await self.check_liunian_change(user_id)
        if liunian_change:
            alerts.append(liunian_change)

        # æ£€æŸ¥æ˜Ÿåº§è¡Œè¿
        transit_alert = await self.check_transit_alert(user_id)
        if transit_alert:
            alerts.append(transit_alert)

        # æ£€æŸ¥èŠ‚æ°”
        solar_term = await self.check_solar_term()
        if solar_term:
            alerts.append(solar_term)

        return alerts

    async def check_dayun_change(self, user_id: str) -> Optional[Alert]:
        """æ£€æŸ¥å¤§è¿äº¤æ¥"""
        profile = await self.profile_repo.get(user_id)
        bazi = await self.bazi_service.calculate(profile.birth_info)

        current_dayun = bazi.get_current_dayun()
        next_dayun = bazi.get_next_dayun()

        days_until_change = (next_dayun.start_date - datetime.now()).days

        if days_until_change <= 30:
            return Alert(
                type='dayun_change',
                title='å¤§è¿å³å°†äº¤æ¥',
                message=f'è¿˜æœ‰{days_until_change}å¤©ï¼Œä½ å°†è¿›å…¥{next_dayun.name}å¤§è¿',
                priority='high'
            )

        return None
```

---

## äº”ã€æŠ€æœ¯å®ç°è·¯çº¿å›¾

### Phase 1ï¼šåŸºç¡€èƒ½åŠ›ï¼ˆWeek 1-2ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ |
|------|------|--------|
| Swiss Ephemeris é›†æˆ | tools/zodiac/ephemeris.py | 3å¤© |
| æ˜Ÿç›˜è®¡ç®—é‡æ„ | tools/zodiac/chart.py | 2å¤© |
| Memory æ•°æ®æ¨¡å‹ | models/memory.py | 1å¤© |
| Memory å­˜å‚¨å®ç° | stores/memory_repo.py | 2å¤© |
| Memory API å®ç° | routes/memories.py | 2å¤© |

### Phase 2ï¼šæ™ºèƒ½èƒ½åŠ›ï¼ˆWeek 3-4ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ |
|------|------|--------|
| æ´å¯ŸæŠ½å–å™¨ | services/vibe_engine/insight_extractor.py | 3å¤© |
| ç”Ÿæ´»äº‹ä»¶è·Ÿè¸ª | services/reminder/event_tracker.py | 2å¤© |
| ä¸»åŠ¨è·Ÿè¿›æœåŠ¡ | services/reminder/follow_up_service.py | 2å¤© |
| Context ç¼–æ’å¢å¼º | services/vibe_engine/context.py | 3å¤© |

### Phase 3ï¼šèåˆèƒ½åŠ›ï¼ˆWeek 5-6ï¼‰

| ä»»åŠ¡ | æ–‡ä»¶ | å·¥ä½œé‡ |
|------|------|--------|
| ç»´åº¦èåˆæœåŠ¡ | services/vibe_engine/dimension_fusion.py | 3å¤© |
| äº¤å‰æ´å¯Ÿç”Ÿæˆ | services/vibe_engine/cross_insight.py | 2å¤© |
| æ—¶é—´èŠ‚ç‚¹é¢„è­¦ | services/temporal/time_alert_service.py | 3å¤© |
| å®šæ—¶ä»»åŠ¡è°ƒåº¦ | workers/temporal_worker.py | 2å¤© |

---

## å…­ã€æˆåŠŸæŒ‡æ ‡

### 6.1 ç®—æ³•ç²¾åº¦æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰åŸºçº¿ | ç›®æ ‡å€¼ |
|------|----------|--------|
| æœˆäº®æ˜Ÿåº§å‡†ç¡®ç‡ | ~70% | >98% |
| ä¸Šå‡æ˜Ÿåº§å‡†ç¡®ç‡ | ~60% | >98% |
| è¡Œæ˜Ÿä½ç½®è¯¯å·® | Â±5åº¦ | <1åº¦ |

### 6.2 è®°å¿†ç³»ç»ŸæŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰åŸºçº¿ | ç›®æ ‡å€¼ |
|------|----------|--------|
| äº‹ä»¶æŠ½å–å‡†ç¡®ç‡ | 0% | >85% |
| ä¸»åŠ¨è·Ÿè¿›è§¦å‘ç‡ | 0% | >90% |
| ç”¨æˆ·æ„ŸçŸ¥"è¢«è®°ä½" | - | >4.5/5 |

### 6.3 èåˆèƒ½åŠ›æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰åŸºçº¿ | ç›®æ ‡å€¼ |
|------|----------|--------|
| å¤šç»´åº¦å¼•ç”¨ç‡ | 0% | >40% |
| äº¤å‰æ´å¯Ÿæ»¡æ„åº¦ | - | >4.5/5 |
| ç»´åº¦æ¢ç´¢è½¬åŒ–ç‡ | - | >30% |

---

## ä¸ƒã€é™„å½•

### A. æ•°æ®åº“ Schema å˜æ›´

```sql
-- è®°å¿†è¡¨
CREATE TABLE memories (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    type VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    source_conversation_id UUID,
    confidence FLOAT DEFAULT 1.0,
    embedding VECTOR(1024),
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    INDEX idx_memories_user_type (user_id, type),
    INDEX idx_memories_embedding USING ivfflat (embedding vector_cosine_ops)
);

-- ç”Ÿæ´»äº‹ä»¶è¡¨
CREATE TABLE life_events (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    event_type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    scheduled_at TIMESTAMP NOT NULL,
    status VARCHAR(20) DEFAULT 'upcoming',
    follow_up_sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_events_user_scheduled (user_id, scheduled_at)
);

-- æ—¶é—´é¢„è­¦è¡¨
CREATE TABLE temporal_alerts (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    alert_type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    trigger_at TIMESTAMP NOT NULL,
    sent BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    INDEX idx_alerts_trigger (trigger_at, sent)
);
```

### B. API æ¥å£å®šä¹‰

```yaml
# è®°å¿† API
POST /api/memories
  body: { type, content, source }
  response: { id, created_at }

GET /api/memories
  query: { type?, limit?, offset? }
  response: { memories: [...], total }

GET /api/memories/search
  query: { q, types?, limit? }
  response: { memories: [...] }

# ç”Ÿæ´»äº‹ä»¶ API
POST /api/events
  body: { event_type, title, description?, scheduled_at }
  response: { id, created_at }

GET /api/events/upcoming
  query: { days? }
  response: { events: [...] }

# æ—¶é—´é¢„è­¦ API
GET /api/alerts
  response: { alerts: [...] }

POST /api/alerts/{id}/dismiss
  response: { success: true }
```

### C. ä¾èµ–åº“

```
# æ˜Ÿåº§è®¡ç®—
pyswisseph>=2.10.0  # Swiss Ephemeris Python ç»‘å®š
# æˆ–
flatlib>=0.2.3      # æ›´æ˜“ç”¨çš„æ˜Ÿåº§åº“

# å‘é‡å­˜å‚¨
pgvector>=0.2.0     # PostgreSQL å‘é‡æ‰©å±•
```

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv5.2*
*åˆ›å»ºæ—¥æœŸï¼š2026-01-10*
*ä½œè€…ï¼šAI Code Review*
