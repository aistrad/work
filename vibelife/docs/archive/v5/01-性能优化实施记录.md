# VibeLife v5 性能优化实施记录

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║                    性 能 优 化 实 施 记 录                                    ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

> 基于 00-核心改动分析.md 中的问题排查，实施的性能优化

---

## 实施日期: 2026-01-11

---

## 1. Profile 智能裁剪策略

### 问题
- 每次对话都全量注入 Profile (~2000 tokens)
- 大 Profile 消耗大量 Token，增加延迟和成本

### 解决方案

**文件**: `apps/api/services/vibe_engine/context.py`

**新增方法**:
- `_detect_topic(message, skill)` - 检测用户消息话题类型
- `_select_profile_fields(profile, topic, skill)` - 根据话题智能选择 Profile 字段

**话题分类**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 话题类型        │ 关键词示例                    │ 注入内容                   │
├─────────────────┼───────────────────────────────┼────────────────────────────┤
│ self            │ 我是、我的性格、我适合        │ 完整 Profile + ai_insights │
│ career          │ 工作、跳槽、升职、创业        │ basic + career             │
│ relationship    │ 感情、恋爱、结婚、分手        │ basic + relationship       │
│ fortune         │ 运势、大运、流年、今年        │ basic + current_focus      │
│ general         │ 其他                          │ 只有 basic 核心字段        │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Token 节省估算**:
- 全量注入: ~2000 tokens
- 智能裁剪: ~200-800 tokens
- **节省: 60-90%**

### 测试结果
```
话题检测测试:
  ✓ "我是什么性格的人" -> self
  ✓ "我适合什么工作" -> self
  ✓ "最近工作压力很大" -> career
  ✓ "想跳槽了" -> career
  ✓ "和男朋友吵架了" -> relationship
  ✓ "今年运势怎么样" -> fortune
  ✓ "你好" -> general
```

---

## 2. Prism 融合防抖机制

### 问题
- 八字和星座同时计算时会触发两次融合
- 每次融合都调用 LLM，浪费资源

### 解决方案

**文件**: `apps/api/services/identity/prism_generator.py`

**新增机制**:
- `DEBOUNCE_SECONDS = 5` - 防抖时间配置
- `_pending_fusions: Dict[str, asyncio.Task]` - 待执行任务字典
- `_schedule_fusion(user_id)` - 调度防抖融合任务

**工作原理**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           防 抖 机 制                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  之前:                                                                      │
│  八字计算完成 ──▶ 触发融合 ──▶ LLM 调用                                    │
│  星座计算完成 ──▶ 触发融合 ──▶ LLM 调用                                    │
│  = 2 次 LLM 调用                                                            │
│                                                                             │
│  之后:                                                                      │
│  八字计算完成 ──▶ 调度融合 (5秒后执行)                                     │
│  星座计算完成 ──▶ 取消旧任务，重新调度 (5秒后执行)                         │
│  5秒后 ──▶ 执行融合 ──▶ LLM 调用                                           │
│  = 1 次 LLM 调用                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**代码示例**:
```python
async def _schedule_fusion(self, user_id: UUID) -> None:
    user_key = str(user_id)
    async with self._lock:
        # 取消已有的待执行任务
        if user_key in self._pending_fusions:
            existing_task = self._pending_fusions[user_key]
            if not existing_task.done():
                existing_task.cancel()

        # 创建新的延迟任务
        async def delayed_fusion():
            await asyncio.sleep(self.DEBOUNCE_SECONDS)
            await self.fuse_prism(user_id)

        self._pending_fusions[user_key] = asyncio.create_task(delayed_fusion())
```

---

## 3. K线数据持久化存储

### 问题
- 每次请求都重新计算 80 年数据
- CPU 密集，响应延迟高

### 解决方案

**新增文件**:
- `apps/api/stores/fortune_repo.py` - K线数据存储
- `migrations/013_fortune_cache.sql` - 数据库迁移

**修改文件**:
- `apps/api/services/fortune/kline_service.py` - 改为异步 + 缓存
- `apps/api/stores/__init__.py` - 导出 fortune_repo

**数据库表**:
```sql
CREATE TABLE user_fortune_cache (
    user_id UUID PRIMARY KEY REFERENCES vibe_users(vibe_id),
    kline_data JSONB NOT NULL,
    profile_hash VARCHAR(32) NOT NULL,
    generated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**缓存策略**:
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           K线缓存策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  缓存命中条件:                                                              │
│  1. user_fortune_cache 表中存在该用户的数据                                 │
│  2. profile_hash 与当前 profile 的 hash 相同                                │
│                                                                             │
│  缓存失效条件:                                                              │
│  1. profile_hash 变化 (birth_year/day_master/gender 改变)                   │
│  2. 用户显式要求重算 (force_recalculate=True)                               │
│                                                                             │
│  profile_hash 计算:                                                         │
│  MD5(JSON({birth_year, day_master_element, gender}))                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**API 变更**:
```python
# 之前 (同步)
def generate_kline(self, user_id, profile, year_range=None) -> KLineData

# 之后 (异步 + 缓存)
async def generate_kline(self, user_id, profile, year_range=None, force_recalculate=False) -> KLineData
```

### 测试结果
```
Profile Hash 测试:
  ✓ 相同 profile hash 相等
  ✓ 不同 profile hash 不等
```

---

## 4. 用户画像缓存 (已有)

**文件**: `apps/api/services/vibe_engine/profile_cache.py`

已有本地内存缓存实现:
- TTL: 5 分钟
- LRU 策略
- 支持手动失效

无需修改。

---

## 部署步骤

### 1. 运行数据库迁移
```bash
psql -d vibelife -f migrations/013_fortune_cache.sql
```

### 2. 重启 API 服务
```bash
# 重启以加载新代码
systemctl restart vibelife-api
```

---

## 性能提升预估

| 优化项 | 之前 | 之后 | 提升 |
|--------|------|------|------|
| Profile Token 消耗 | ~2000 tokens/对话 | ~200-800 tokens/对话 | 60-90% |
| Prism 融合 LLM 调用 | 2次/用户 | 1次/用户 | 50% |
| K线计算时间 | ~500ms/请求 | ~10ms/请求 (缓存命中) | 98% |

---

## 相关文件清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `apps/api/services/vibe_engine/context.py` | 修改 | 添加话题检测和智能裁剪 |
| `apps/api/services/identity/prism_generator.py` | 修改 | 添加防抖机制 |
| `apps/api/services/fortune/kline_service.py` | 修改 | 改为异步 + 缓存 |
| `apps/api/stores/fortune_repo.py` | 新增 | K线数据存储 |
| `apps/api/stores/__init__.py` | 修改 | 导出 fortune_repo |
| `migrations/013_fortune_cache.sql` | 新增 | 数据库迁移 |

---

*文档版本: v1.0*
*创建日期: 2026-01-11*
