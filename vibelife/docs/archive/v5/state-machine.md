 1. 系统整体架构图

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                           VibeLife System Architecture                       │
  └─────────────────────────────────────────────────────────────────────────────┘

                                ┌─────────────┐
                                │   Client    │
                                │  (Next.js)  │
                                └──────┬──────┘
                                       │ HTTP/SSE
                                       ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                              FastAPI Backend                                 │
  │  ┌─────────────────────────────────────────────────────────────────────┐   │
  │  │                           Routes Layer                               │   │
  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   │   │
  │  │  │  /chat  │ │ /skill  │ │ /user   │ │/knowledge│ │ /portrait   │   │   │
  │  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └──────┬──────┘   │   │
  │  └───────┼──────────┼──────────┼──────────┼───────────────┼───────────┘   │
  │          │          │          │          │               │               │
  │  ┌───────┴──────────┴──────────┴──────────┴───────────────┴───────────┐   │
  │  │                         Services Layer                              │   │
  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   │   │
  │  │  │  Agent  │ │   LLM   │ │Knowledge│ │  Bazi   │ │SkillDistill │   │   │
  │  │  │ System  │ │ Client  │ │   RAG   │ │ Engine  │ │  Pipeline   │   │   │
  │  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └──────┬──────┘   │   │
  │  └───────┼──────────┼──────────┼──────────┼───────────────┼───────────┘   │
  │          │          │          │          │               │               │
  │  ┌───────┴──────────┴──────────┴──────────┴───────────────┴───────────┐   │
  │  │                          Stores Layer                               │   │
  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐   │   │
  │  │  │  User   │ │  Chat   │ │ Skill   │ │Document │ │   Vector    │   │   │
  │  │  │  Store  │ │  Store  │ │  Store  │ │  Store  │ │   Store     │   │   │
  │  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └──────┬──────┘   │   │
  │  └───────┼──────────┼──────────┼──────────┼───────────────┼───────────┘   │
  └──────────┼──────────┼──────────┼──────────┼───────────────┼───────────────┘
             │          │          │          │               │
             ▼          ▼          ▼          ▼               ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                     PostgreSQL + pgvector                                    │
  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────────┐   │
  │  │  users  │ │messages │ │ skills  │ │documents│ │ document_chunks     │   │
  │  │         │ │         │ │         │ │         │ │ (vector embeddings) │   │
  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────────────────┘   │
  └─────────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────────────────────┐
                      │       Background Workers        │
                      │  ┌───────────┐ ┌───────────┐   │
                      │  │ Ingestion │ │  Portrait │   │
                      │  │  Worker   │ │  Worker   │   │
                      │  └───────────┘ └───────────┘   │
                      └─────────────────────────────────┘

  ---
  2. Agent 状态机 (核心)

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        Agent State Machine                                   │
  └─────────────────────────────────────────────────────────────────────────────┘

                                ┌──────────┐
                                │   IDLE   │
                                └────┬─────┘
                                     │ on_message_received
                                     ▼
                      ┌─────────────────────────────┐
           ┌─────────│         THINKING            │◄────────────┐
           │         └─────────────┬───────────────┘             │
           │                       │                              │
           │         ┌─────────────┼─────────────┐               │
           │         ▼             ▼             ▼               │
           │    [has_tool]   [has_content]  [exception]          │
           │         │             │             │               │
           │         ▼             ▼             ▼               │
           │  ┌────────────┐ ┌──────────┐ ┌──────────┐          │
           │  │TOOL_CALLING│ │COMPLETED │ │  ERROR   │          │
           │  └─────┬──────┘ └──────────┘ └──────────┘          │
           │        │                                            │
           │        │ execute_tool()                             │
           │        ▼                                            │
           │  ┌────────────────────────────────────┐            │
           │  │         Tool Execution             │            │
           │  │  ┌──────────┐    ┌──────────┐     │            │
           │  │  │ success  │    │  error   │     │            │
           │  │  └────┬─────┘    └────┬─────┘     │            │
           │  └───────┼──────────────┼────────────┘            │
           │          │              │                          │
           │          │              ▼                          │
           │          │        ┌──────────┐                     │
           │          │        │  ERROR   │                     │
           │          │        └──────────┘                     │
           │          │                                         │
           └──────────┴─────────────────────────────────────────┘
                      append_tool_result & continue

      ┌─────────────────────────────────────────────────────────────────┐
      │  Guard: max_iterations reached → ERROR (prevent infinite loop)  │
      └─────────────────────────────────────────────────────────────────┘

  States:
    • IDLE         - 等待用户消息
    • THINKING     - LLM 推理中
    • TOOL_CALLING - 执行工具调用
    • COMPLETED    - 成功完成响应
    • ERROR        - 发生错误或超时

  ---
  3. 文档摄入状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                    Document Ingestion State Machine                          │
  └─────────────────────────────────────────────────────────────────────────────┘

      ┌─────────────┐
      │   PENDING   │◄─────────────────────────────────┐
      └──────┬──────┘                                  │
             │ worker claims (SKIP LOCKED)             │ retry
             ▼                                         │
      ┌─────────────┐                                  │
      │ PROCESSING  │──────────────────────────────────┤
      └──────┬──────┘                                  │
             │                                         │
             ├─────────────────────────────────────────┤
             │                                         │
             ▼                                         ▼
      ┌─────────────┐                           ┌──────────┐
      │  COMPLETED  │                           │  FAILED  │
      └─────────────┘                           └──────────┘


  Processing Pipeline Detail:
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                                                                              │
  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌───────┐ │
  │  │  Claim   │───▶│ Convert  │───▶│  Chunk   │───▶│  Embed   │───▶│ Store │ │
  │  │ Document │    │    to    │    │  (Smart  │    │ (BGE-M3) │    │Vectors│ │
  │  │          │    │ Markdown │    │ Chunker) │    │          │    │       │ │
  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └───────┘ │
  │                                                                              │
  │  ┌──────────────────────────────────────────────────────────────────────┐   │
  │  │                    Smart Chunker 3-Phase                              │   │
  │  │  Phase 1: Parse Structure (Markdown headings → Section tree)         │   │
  │  │  Phase 2: Smart Merge (Merge small sections < 100 chars)             │   │
  │  │  Phase 3: Safe Split (Sentence boundaries, 80 char overlap)          │   │
  │  └──────────────────────────────────────────────────────────────────────┘   │
  │                                                                              │
  └─────────────────────────────────────────────────────────────────────────────┘

  ---
  4. Chat 请求流程状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        Chat Request Flow                                     │
  └─────────────────────────────────────────────────────────────────────────────┘

      POST /chat/stream
             │
             ▼
      ┌─────────────┐
      │   INIT      │ Parse request (skill, voice_mode)
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐     ┌──────────┐
      │ CHECK_QUOTA │────▶│  REJECT  │ (quota exceeded)
      └──────┬──────┘     └──────────┘
             │ pass
             ▼
      ┌─────────────┐
      │LOAD_CONTEXT │ User profile + Skill data + History
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐
      │BUILD_PROMPT │ ContextBuilder.build()
      └──────┬──────┘
             │
             ▼
      ┌─────────────┐
      │ LLM_STREAM  │◄────────────────────────────┐
      └──────┬──────┘                             │
             │                                    │
             ├──────────────┬─────────────┐      │
             ▼              ▼             ▼      │
      [text_delta]    [tool_call]    [done]      │
             │              │             │      │
             ▼              ▼             ▼      │
      ┌──────────┐   ┌───────────┐  ┌─────────┐ │
      │ SSE_EMIT │   │TOOL_EXEC  │  │FINALIZE │ │
      └──────────┘   └─────┬─────┘  └─────────┘ │
                           │                     │
                           │ tool_result         │
                           └─────────────────────┘

      ┌─────────────────────────────────────────────────────────────────┐
      │  Tools Available:                                                │
      │  • search_knowledge → RAG retrieval                             │
      │  • UI tools → execute_ui_tool()                                 │
      │  • bazi_calculate → Bazi engine                                 │
      └─────────────────────────────────────────────────────────────────┘

  ---
  5. Orchestrator 意图分类状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                    Orchestrator Intent Classification                        │
  └─────────────────────────────────────────────────────────────────────────────┘

                           User Message
                                │
                                ▼
                      ┌─────────────────┐
                      │ Keyword Detect  │
                      └────────┬────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
      [1 skill kw]      [2+ skill kw]        [no skill kw]
      [no fusion]       [OR fusion kw]
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │SINGLE_SKILL │    │ MULTI_SKILL │    │   GENERAL   │
    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
           │                  │                   │
           ▼                  ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ Run Single  │    │Run Parallel │    │Use Current  │
    │   Agent     │    │   Agents    │    │   Skill     │
    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
           │                  │                   │
           │                  ▼                   │
           │           ┌─────────────┐            │
           │           │FusionAgent  │            │
           │           │(Merge多结果)│            │
           │           └──────┬──────┘            │
           │                  │                   │
           └──────────────────┼───────────────────┘
                              ▼
                      ┌─────────────┐
                      │  Response   │
                      └─────────────┘

      Skill Keywords: bazi(八字), zodiac(星座), tarot(塔罗)...
      Fusion Keywords: 综合, 结合, 融合, 一起, 同时...

  ---
  6. RAG 检索流程状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                         RAG Retrieval Flow                                   │
  └─────────────────────────────────────────────────────────────────────────────┘

                           User Query
                                │
                                ▼
                      ┌─────────────────┐
                      │  PREPROCESS     │ Jieba tokenization
                      └────────┬────────┘
                               │
                ┌──────────────┴──────────────┐
                ▼                             ▼
      ┌─────────────────┐           ┌─────────────────┐
      │  VECTOR_SEARCH  │           │   FTS_SEARCH    │
      │   (pgvector)    │           │  (PostgreSQL)   │
      │                 │           │                 │
      │  embed(query)   │           │ to_tsquery()    │
      │  cosine_sim     │           │ ts_rank()       │
      └────────┬────────┘           └────────┬────────┘
               │                             │
               │ vector_results              │ fts_results
               │                             │
               └──────────────┬──────────────┘
                              ▼
                      ┌─────────────────┐
                      │   RRF_FUSION    │
                      │                 │
                      │ score = 0.7*V   │
                      │       + 0.3*F   │
                      └────────┬────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │    RERANK       │ (optional)
                      └────────┬────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │  TOP_K_RESULTS  │
                      └─────────────────┘

      ┌─────────────────────────────────────────────────────────────────┐
      │  Embedding Model: BAAI/bge-m3                                    │
      │  Dimension: 1024                                                 │
      │  Similarity: Cosine                                              │
      │  Weights: Vector 70% + FTS 30%                                   │
      └─────────────────────────────────────────────────────────────────┘

  ---
  7. Skill Distillation Pipeline 状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                      Skill Distillation Pipeline                             │
  └─────────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────┐
                      │   FILE_SCAN     │ FileTracker detects changes
                      └────────┬────────┘
                               │
                ┌──────────────┼──────────────┐
                ▼              ▼              ▼
           [new_file]    [modified]     [deleted]
                │              │              │
                ▼              ▼              ▼
      ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
      │   EXTRACT   │  │  RE-EXTRACT │  │   REMOVE    │
      └──────┬──────┘  └──────┬──────┘  └─────────────┘
             │                │
             └────────┬───────┘
                      ▼
             ┌─────────────────┐
             │ IDENTITY_EXTRACT│ Extract expert role/goal/backstory
             └────────┬────────┘
                      │
                      ▼
             ┌─────────────────┐
             │KNOWLEDGE_EXTRACT│
             └────────┬────────┘
                      │
      ┌───────────────┼───────────────┬───────────────┐
      ▼               ▼               ▼               ▼
  ┌────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
  │analysis│    │ judgment │    │ dialogue │    │expression│
  │ _flow  │    │  _rule   │    │_strategy │    │  _norm   │
  └────────┘    └──────────┘    └──────────┘    └──────────┘
      │               │               │               │
      └───────────────┴───────────────┴───────────────┘
                      │
                      ▼
             ┌─────────────────┐
             │CONSTRAINT_EXTRACT│ Output format constraints
             └────────┬────────┘
                      │
                      ▼
             ┌─────────────────┐
             │  VERSION_MGMT   │ Semantic versioning
             └────────┬────────┘
                      │
                      ▼
             ┌─────────────────┐
             │  SKILL_ASSEMBLE │ Generate SKILL.md
             └─────────────────┘

      Knowledge Unit Types:
      • analysis_flow    - 分析流程
      • judgment_rule    - 判断规则
      • dialogue_strategy- 对话策略
      • expression_norm  - 表达规范
      • domain_concept   - 领域概念
      • expert_insight   - 专家洞察

  ---
  8. LLM Provider Fallback 状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                       LLM Provider Fallback Chain                            │
  └─────────────────────────────────────────────────────────────────────────────┘

                      ┌─────────────────┐
                      │   LLM_REQUEST   │
                      └────────┬────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │  PRIMARY (GLM)  │
                      └────────┬────────┘
                               │
                ┌──────────────┴──────────────┐
                ▼                             ▼
           [success]                      [failure]
                │                             │
                ▼                             ▼
          ┌──────────┐              ┌─────────────────┐
          │ RESPONSE │              │FALLBACK_1(Gemini)│
          └──────────┘              └────────┬────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              ▼                             ▼
                         [success]                      [failure]
                              │                             │
                              ▼                             ▼
                        ┌──────────┐              ┌─────────────────┐
                        │ RESPONSE │              │FALLBACK_2(Claude)│
                        └──────────┘              └────────┬────────┘
                                                           │
                                            ┌──────────────┴──────────────┐
                                            ▼                             ▼
                                       [success]                      [failure]
                                            │                             │
                                            ▼                             ▼
                                      ┌──────────┐                  ┌──────────┐
                                      │ RESPONSE │                  │  ERROR   │
                                      └──────────┘                  └──────────┘

      Provider Priority:
      1. GLM (智谱) - Primary
      2. Gemini (Google) - Fallback 1
      3. Claude (Anthropic) - Fallback 2

  ---
  9. Context Building 状态机

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                      Context Building Flow                                   │
  └─────────────────────────────────────────────────────────────────────────────┘

                           User Message
                                │
                                ▼
                      ┌─────────────────┐
                      │  TOPIC_DETECT   │
                      └────────┬────────┘
                               │
           ┌───────────┬───────┼───────┬───────────┐
           ▼           ▼       ▼       ▼           ▼
        [self]     [career] [relation] [fortune] [general]
           │           │       │       │           │
           ▼           ▼       ▼       ▼           ▼
      ┌─────────────────────────────────────────────────┐
      │              LAYER_SELECTION                     │
      │                                                  │
      │  Layer 0: Identity Prism (ALWAYS)               │
      │  Layer 1: Basic core fields                     │
      │  Layer 2: Current skill chart data              │
      │  Layer 3: Topic-related life_context            │
      │  Layer 4: AI insights (self-inquiry only)       │
      └────────────────────┬────────────────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │  BUILD_SYSTEM   │ Persona + Skill + Voice Mode
                  │     PROMPT      │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │ FORMAT_HISTORY  │ Conversation messages
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │ CONTEXT_READY   │
                  └─────────────────┘

      Topic → Profile Fields Mapping:
      • self       → Full profile + ai_insights
      • career     → life_context.career + basic
      • relationship → life_context.relationship + basic
      • fortune    → basic (chart data) + current_focus
      • general    → identity_prism summary only
